<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AhraStore Pro - Cloud Management</title>
    <script src="https://cdn.tailwindcss.com">
// =====================
// REVISI RESET PASSWORD (OTP TELEGRAM & PIN)
// =====================

// Helper: tampilkan error detail
function handleServerError(err, context) {
    console.error(context, err);
    const msg = err?.message || "Kesalahan tidak diketahui";
    showIOSNotify("Gagal", `${context}: ${msg}`);
}

// Helper: validasi format telegram
function normalizeTelegramID(input) {
    let v = input.trim();
    if (v.startsWith('@')) v = v.substring(1);
    return v;
}

// REVISI: OTP Telegram dengan error detail
window.checkTelegramAndSendOTP = async () => {
    const raw = document.getElementById('forgotTelegramID').value;
    const telegramID = normalizeTelegramID(raw);
    const btn = document.getElementById('sendTelegramOTPBtn');

    if (!telegramID) {
        return showIOSNotify("Input Salah", "ID Telegram wajib diisi.");
    }

    btn.disabled = true;
    btn.innerText = "Memproses...";

    try {
        if (!auth.currentUser) {
            await signInAnonymously(auth);
        }

        const q = query(collectionGroup(db, 'settings'), where('telegramID', '==', telegramID));
        const snap = await getDocs(q);

        if (snap.empty) {
            throw new Error("ID Telegram tidak terdaftar.");
        }

        const docSnap = snap.docs[0];
        verifiedUserUID = docSnap.ref.parent.parent.id;

        generatedOTP = Math.floor(100000 + Math.random() * 900000).toString();

        const payload = {
            chat_id: telegramID,
            text: `ðŸ” KODE OTP RESET PASSWORD\n\nKode OTP Anda: ${generatedOTP}\n\nBerlaku 5 menit.`
        };

        const tgResp = await fetch(`${CF_TELEGRAM_PROXY_BASE}/sendMessage`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });

        const tgJson = await tgResp.json();
        if (!tgJson.ok) {
            throw new Error(tgJson.description || "Telegram API error");
        }

        document.getElementById('otpInputContainer').classList.remove('hidden');
        btn.innerText = "Verifikasi OTP";
        btn.disabled = false;
        btn.onclick = verifyTelegramOTP;

        showIOSNotify("OTP Terkirim", "Silakan cek Telegram Anda.");
    } catch (e) {
        btn.disabled = false;
        btn.innerText = "Kirim OTP";
        handleServerError(e, "OTP Telegram");
    }
};

// REVISI: verifikasi OTP
window.verifyTelegramOTP = async () => {
    const input = document.getElementById('forgotTelegramOTP').value.trim();
    if (!input) return showIOSNotify("OTP Kosong", "Masukkan kode OTP.");

    if (input !== generatedOTP) {
        return showIOSNotify("OTP Salah", "Kode OTP tidak cocok.");
    }

    openNewPasswordModal();
};

// REVISI: verifikasi PIN cadangan dengan error detail
window.verifyBackupPin = async () => {
    const email = document.getElementById('forgotPinEmail').value.trim();
    const pin = document.getElementById('forgotPinCode').value.trim();

    if (!email || !pin) {
        return showIOSNotify("Input Salah", "Email dan PIN wajib diisi.");
    }
    if (pin.length !== 6) {
        return showIOSNotify("PIN Tidak Valid", "PIN harus 6 digit.");
    }

    try {
        if (!auth.currentUser) {
            await signInAnonymously(auth);
        }

        const q = query(collection(db, 'users'), where('email', '==', email));
        const snap = await getDocs(q);
        if (snap.empty) {
            throw new Error("Email tidak ditemukan.");
        }

        const userDoc = snap.docs[0];
        const data = userDoc.data();

        if (!data.backupPIN) {
            throw new Error("PIN cadangan belum diatur.");
        }

        if (data.backupPIN !== pin) {
            throw new Error("PIN cadangan salah.");
        }

        verifiedUserUID = userDoc.id;
        openNewPasswordModal();
    } catch (e) {
        handleServerError(e, "Verifikasi PIN");
    }
};

function openNewPasswordModal() {
    closeModals();
    document.getElementById('modalOverlay').classList.add('active');
    document.getElementById('newPasswordModal').classList.add('active');
}

</script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        
        :root {
            --bg-dark: #000000;
            --card-bg: #1c1c1e;
            --card-secondary: #2c2c2e;
            --accent-blue: #0a84ff;
            --text-main: #ffffff;
            --text-secondary: #8e8e93;
            --ios-blur: rgba(28, 28, 30, 0.85);
            color-scheme: dark;
        }

        html, body {
            height: 100%;
            margin: 0;
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            overflow-x: hidden;
            -webkit-text-size-adjust: 100%;
            user-select: none;
        }

        .app-container {
            width: 100%;
            max-width: 450px;
            margin: 0 auto;
            min-height: 100dvh;
            display: flex;
            flex-direction: column;
            background-color: var(--bg-dark);
            position: relative;
        }

        /* Loading Screen */
        #loadingScreen {
            position: fixed;
            inset: 0;
            background: var(--bg-dark);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .ios-loader {
            width: 35px;
            height: 35px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top: 3px solid var(--accent-blue);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Login Screen */
        #loginScreen {
            position: fixed; inset: 0; background: black; z-index: 9000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 40px; text-align: center;
            transition: opacity 0.35s cubic-bezier(0.4, 0, 0.2, 1), transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            transform: scale(1);
        }
        .login-logo {
            width: 80px; height: 80px; background: var(--accent-blue);
            border-radius: 22px; margin-bottom: 24px;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 10px 30px rgba(10, 132, 255, 0.3);
            overflow: hidden;
        }

        /* Smooth Page Transition After Login (Zoom Out) */
        #loginScreen.login-exit {
            opacity: 0;
            transform: scale(1.03);
            pointer-events: none;
        }

        #app.app-enter-zoomout {
            animation: appZoomOut 0.45s cubic-bezier(0.19, 1, 0.22, 1) both;
        }

        @keyframes appZoomOut {
            from { opacity: 0; transform: scale(1.06); }
            to { opacity: 1; transform: scale(1); }
        }

        .shizuku-card {
            background-color: var(--card-bg);
            border-radius: 14px;
            padding: 16px;
            margin-bottom: 16px;
            border: 0.5px solid rgba(255, 255, 255, 0.05);
        }

        .ios-input-group {
            background-color: var(--card-secondary);
            border-radius: 12px;
            overflow: hidden;
            border: 0.5px solid rgba(255, 255, 255, 0.05);
            text-align: left;
        }

        .ios-input-row {
            display: flex;
            flex-direction: column;
            padding: 10px 16px;
            border-bottom: 0.5px solid rgba(255, 255, 255, 0.05);
            text-align: left;
        }
        .ios-input-row:last-child { border-bottom: none; }

        .row-label {
            font-size: 10px;
            font-weight: 800;
            color: var(--accent-blue);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 2px;
            text-align: left;
        }

        .pill-button {
            background-color: var(--accent-blue);
            color: white;
            border-radius: 12px;
            padding: 14px 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 15px;
            transition: all 0.2s;
            border: none;
            width: 100%;
            cursor: pointer;
        }
        .pill-button:active { transform: scale(0.96); opacity: 0.8; }
        .pill-button:disabled { opacity: 0.5; cursor: not-allowed; }

        .tab-btn {
            position: relative;
            padding: 12px 0;
            font-size: 11px;
            font-weight: 700;
            color: var(--text-secondary);
            transition: color 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .tab-btn.tab-active { color: var(--accent-blue); }
        .tab-btn.tab-active::after {
            content: '';
            position: absolute;
            bottom: 0; left: 25%; width: 50%; height: 3px;
            background-color: var(--accent-blue);
            border-radius: 3px 3px 0 0;
        }

        .ios-select-trigger {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            padding: 14px 16px;
            background-color: var(--card-secondary);
            border-radius: 12px;
            color: var(--text-main);
            font-size: 15px;
            cursor: pointer;
            transition: background 0.2s;
            border: 0.5px solid rgba(255, 255, 255, 0.05);
        }

        input, textarea {
            background: transparent !important;
            border: none !important;
            color: white !important;
            padding: 0 !important;
            font-size: 15px !important;
            width: 100%;
            outline: none;
            text-align: left;
        }
        input::placeholder { color: var(--text-secondary); }

        .price-input {
            background: transparent !important;
            border: none !important;
            color: white !important;
            padding: 0 !important;
            font-size: 15px !important;
            width: 100%;
            outline: none;
            text-align: left;
            inputmode: decimal;
            -webkit-user-select: text;
            user-select: text;
        }

        .ios-popover {
            position: absolute;
            background: var(--ios-blur);
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border-radius: 14px;
            z-index: 100;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            display: none;
            flex-direction: column;
            overflow: hidden;
            border: 0.5px solid rgba(255, 255, 255, 0.1);
            transform-origin: top right;
            animation: popIn 0.2s cubic-bezier(0.4, 0, 0.2, 1) forwards;
            width: 240px;
        }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .popover-item {
            padding: 16px;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 0.5px solid rgba(255, 255, 255, 0.1);
            color: white;
            text-align: left;
            background: transparent;
            min-height: 52px;
        }
        .popover-item:last-child { border-bottom: none; }
        .popover-item:active { background: rgba(255,255,255,0.15); }

        .overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
            z-index: 8000;
            display: none;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .overlay.active { display: block; opacity: 1; }

        .bottom-sheet {
            position: fixed;
            bottom: 12px; left: 12px; right: 12px;
            background: var(--ios-blur);
            backdrop-filter: blur(30px) saturate(180%);
            border-radius: 20px;
            z-index: 8500;
            transform: translateY(120%);
            transition: transform 0.4s cubic-bezier(0.1, 0.7, 0.1, 1);
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0,0,0,0.6);
        }
        .bottom-sheet.active { transform: translateY(0); }

        .centered-modal {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            width: 90%; max-width: 360px;
            background: var(--ios-blur);
            backdrop-filter: blur(40px);
            border-radius: 24px;
            z-index: 9000;
            display: none;
            flex-direction: column;
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 0.5px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 20px 60px rgba(0,0,0,0.7);
        }
        .centered-modal.active { display: flex; opacity: 1; transform: translate(-50%, -50%) scale(1); }

        .picker-option {
            padding: 16px; text-align: center; font-size: 17px;
            color: var(--accent-blue); background: transparent;
            width: 100%; border-bottom: 0.5px solid rgba(255, 255, 255, 0.1);
        }
        .picker-option:active { background: rgba(255, 255, 255, 0.1); }

        /* --- LOGIKA DATABASE GRID & BLUR --- */
        .db-grid { 
            display: grid; 
            grid-template-columns: repeat(1, 1fr); 
            gap: 14px; 
            transition: all 0.3s ease;
        }

        .db-card {
            background: var(--card-bg); border-radius: 16px; padding: 12px;
            border: 0.5px solid rgba(255, 255, 255, 0.05);
            position: relative; cursor: pointer;
            display: flex;
            align-items: center;
            gap: 14px;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            z-index: 1;
        }

        /* Saat Grid dalam mode fokus (salah satu kartu aktif) */
        .db-grid.has-active-card .db-card {
            filter: blur(4px) brightness(0.7);
            opacity: 0.6;
            pointer-events: none;
            transform: scale(0.98);
        }

        /* Kartu yang sedang AKTIF (diklik) */
        .db-grid.has-active-card .db-card.active-card {
            filter: none;
            opacity: 1;
            pointer-events: auto;
            z-index: 50;
            transform: scale(1.03);
            border-color: var(--accent-blue);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5), 0 0 0 1px rgba(10, 132, 255, 0.3);
            background: #242426;
        }

        .sold-badge {
            background: #ff3b30; color: white; font-size: 10px;
            padding: 2px 8px; border-radius: 6px; font-weight: 800;
            position: absolute; top: 10px; right: 10px;
            box-shadow: 0 2px 10px rgba(255, 59, 48, 0.3); z-index: 5;
        }

        /* iOS Professional Notification Card */
        #iosNotifyContainer {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-150%);
            width: calc(100% - 40px);
            max-width: 400px;
            z-index: 10000;
            transition: transform 0.6s cubic-bezier(0.19, 1, 0.22, 1);
        }
        #iosNotifyContainer.active { transform: translateX(-50%) translateY(0); }

        .ios-notification {
            background: rgba(44, 44, 46, 0.8);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-radius: 18px;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
            border: 0.5px solid rgba(255,255,255,0.1);
        }

        /* Toggle Switch Styling */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #3c3c3e;
            transition: .4s;
            border-radius: 34px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: #30d158;
        }

        input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }

        .forgot-link {
            font-size: 11px;
            color: var(--accent-blue);
            text-decoration: none;
            font-weight: 500;
            margin-top: 4px;
            display: block;
            text-align: right;
            padding-right: 4px;
        }

        /* New Styles for Password Visibility */
        .password-container {
            display: flex;
            align-items: center;
            width: 100%;
        }

        .password-input {
            flex: 1;
            background: transparent;
            border: none;
            color: white;
            padding: 0;
            font-size: 15px;
            outline: none;
        }

        .password-toggle {
            background: transparent;
            border: none;
            color: #8e8e93;
            padding: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .backup-security-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
        }

        .backup-security-label {
            font-size: 15px;
            color: white;
        }

        .backup-security-value {
            font-size: 14px;
            color: #8e8e93;
        }

        .add-backup-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 10px 16px;
            background: rgba(10, 132, 255, 0.1);
            border: 1px solid rgba(10, 132, 255, 0.3);
            border-radius: 10px;
            color: var(--accent-blue);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
        }

        .add-backup-btn:active {
            background: rgba(10, 132, 255, 0.2);
        }

        .reset-option-btn {
            width: 100%;
            padding: 14px;
            background: var(--card-secondary);
            border-radius: 12px;
            border: 0.5px solid rgba(255, 255, 255, 0.05);
            color: white;
            font-size: 15px;
            text-align: center;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .reset-option-btn:active {
            background: rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body>

    <!-- iOS Notification Card -->
    <div id="iosNotifyContainer">
        <div class="ios-notification">
            <div id="notifyIconContainer" class="w-10 h-10 rounded-xl flex items-center justify-center">
                <!-- Icon injected by JS -->
            </div>
            <div class="flex-1">
                <p id="notifyTitle" class="text-[14px] font-bold text-white"></p>
                <p id="notifyMessage" class="text-[13px] text-zinc-300 leading-tight"></p>
            </div>
        </div>
    </div>

    <!-- Loading Screen -->
    <div id="loadingScreen">
        <div class="ios-loader"></div>
        <p class="mt-6 text-[10px] font-bold text-[#8e8e93] tracking-[0.2em] uppercase">AhraStore</p>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="hidden">
        <div class="login-logo">
            <img src="https://img.sanishtech.com/u/f52d0e9847d08bdff31a58247421aacc.png" alt="Logo" class="w-full h-full object-cover">
        </div>
        <h2 class="text-3xl font-bold tracking-tight mb-2">Selamat Datang Di AHRASTORE.apk</h2>
        <p class="text-[14px] text-zinc-500 mb-6">Silahkan Login Untuk Lanjut</p>
        
        <div class="w-full max-w-xs space-y-4">
            <div class="ios-input-group">
                <div class="ios-input-row">
                    <span class="row-label">Email</span>
                    <input type="email" id="loginEmail" placeholder="email@contoh.com">
                </div>
                <div class="ios-input-row">
                    <span class="row-label">Password</span>
                    <div class="password-container">
                        <input type="password" id="loginPass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" class="password-input">
                        <button type="button" id="eyeToggleBtn" class="password-toggle">
                            <svg id="eyeIcon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                <circle cx="12" cy="12" r="3"/>
                            </svg>
                        </button>
                    </div>
</div>
            </div>
            <button id="loginBtn" onclick="handleEmailAuth('login')" class="pill-button">MASUK</button>
            <button id="signupBtn" onclick="handleEmailAuth('signup')" class="pill-button !bg-zinc-800 !text-blue-500">DAFTAR BARU</button>
        </div>
    </div>

    <!-- Forgot Password Options Modal (REVISED) -->
    <div id="forgotPasswordOptionsModal" class="centered-modal">
        <div class="p-6">
            <h3 class="text-lg font-bold mb-4 text-center">Reset Password</h3>
            <div class="space-y-4">
                <!-- Removed Email OTP Option -->
                <button onclick="openForgotPasswordTelegramModal()" class="reset-option-btn">
                    Kirim OTP ke Telegram
                </button>
                <button onclick="openForgotPasswordPinModal()" class="reset-option-btn">
                    Gunakan PIN Cadangan
                </button>
                <div class="text-center">
                    <button onclick="closeModals()" class="text-[13px] text-zinc-500">Kembali ke Login</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Forgot Password Telegram Modal (REVISED) -->
    <div id="forgotPasswordTelegramModal" class="centered-modal">
        <div class="p-6">
            <h3 class="text-lg font-bold mb-4 text-center">Reset via Telegram</h3>
            <div class="space-y-4">
                <div class="ios-input-group">
                    <div class="ios-input-row">
                        <span class="row-label">ID Telegram</span>
                        <input type="text" id="forgotTelegramID" placeholder="@username atau angka ID">
                    </div>
                    <div id="otpInputContainer" class="hidden">
                        <div class="ios-input-row">
                            <span class="row-label">Kode OTP</span>
                            <input type="text" id="forgotTelegramOTP" placeholder="Masukkan kode OTP">
                        </div>
                    </div>
                </div>
                
                <div id="telegramActionContainer">
                     <button onclick="checkTelegramAndSendOTP()" id="sendTelegramOTPBtn" class="pill-button !bg-green-500">Kirim OTP</button>
                </div>
                
                <div class="text-center">
                    <button onclick="openForgotPasswordOptions()" class="text-[13px] text-zinc-500">Kembali</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Forgot Password PIN Modal (REVISED) -->
    <div id="forgotPasswordPinModal" class="centered-modal">
        <div class="p-6">
            <h3 class="text-lg font-bold mb-4 text-center">Reset via PIN Cadangan</h3>
            <div class="space-y-4">
                <div class="ios-input-group">
                    <div class="ios-input-row">
                        <span class="row-label">Email Terdaftar</span>
                        <input type="email" id="forgotPinEmail" placeholder="email@contoh.com">
                    </div>
                    <div class="ios-input-row">
                        <span class="row-label">PIN Cadangan</span>
                        <div class="password-container">
                                <input type="password" id="forgotPinCode" placeholder="Masukkan 6-digit PIN" maxlength="6" inputmode="numeric" class="password-input">
                                <button type="button" onclick="togglePasswordVisibility('forgotPinCode', 'forgotPinCodeToggle')" class="password-toggle" id="forgotPinCodeToggle">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                        <circle cx="12" cy="12" r="3"/>
                                    </svg>
                                </button>
                            </div>
                    </div>
                </div>
                <button onclick="verifyBackupPin()" id="verifyPinBtn" class="pill-button !bg-green-500">Verifikasi PIN</button>
                <div class="text-center">
                    <button onclick="openForgotPasswordOptions()" class="text-[13px] text-zinc-500">Kembali</button>
                </div>
            </div>
        </div>
    </div>

    <!-- New Password Modal (NEW) -->
    <div id="newPasswordModal" class="centered-modal">
        <div class="p-6">
            <div class="w-12 h-12 bg-green-500/20 rounded-full flex items-center justify-center mx-auto mb-3">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="2.5"><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/></svg>
            </div>
            <h3 class="text-lg font-bold mb-1 text-center">Buat Sandi Baru</h3>
            <p class="text-xs text-center text-zinc-500 mb-4">Verifikasi berhasil. Silahkan buat sandi baru.</p>
            <div class="space-y-4">
                <div class="ios-input-group">
                    <div class="ios-input-row">
                        <span class="row-label">Password Baru</span>
                        <div class="password-container">
                                <input type="password" id="finalNewPassword" placeholder="Minimal 6 karakter" class="password-input">
                                <button type="button" onclick="togglePasswordVisibility('finalNewPassword', 'finalNewPasswordToggle')" class="password-toggle" id="finalNewPasswordToggle">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                        <circle cx="12" cy="12" r="3"/>
                                    </svg>
                                </button>
                            </div>
                    </div>
                </div>
                <button onclick="finalizeReset()" id="finalizeBtn" class="pill-button">SIMPAN & LOGIN</button>
            </div>
        </div>
    </div>

    <!-- Setup User Data Modal (New User) -->
    <div id="setupUserDataModal" class="centered-modal">
        <div class="p-6">
            <div class="w-16 h-16 bg-blue-500 rounded-3xl flex items-center justify-center mx-auto mb-4 shadow-xl shadow-blue-500/20">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
            </div>
            <h3 class="text-xl font-bold mb-1 text-white">Lengkapi Profil</h3>
            <p class="text-[13px] text-zinc-500 mb-6">Silahkan lengkapi data diri untuk keamanan akun.</p>
            
            <div class="ios-input-group mb-6 space-y-4">
                <div class="ios-input-row">
                    <span class="row-label">Username</span>
                    <input type="text" id="newUsername" placeholder="Contoh: AdminGanteng" maxlength="15">
                </div>
                <div class="ios-input-row">
                    <span class="row-label">Tempat, Tanggal Lahir</span>
                    <input type="text" id="newBirthInfo" placeholder="Contoh: Jakarta, 01 Januari 2000">
                </div>
                <div class="ios-input-row">
                    <span class="row-label">ID Telegram</span>
                    <input type="text" id="newTelegramID" placeholder="@username atau angka ID">
                </div>
                <div class="ios-input-row">
                    <span class="row-label">PIN Cadangan (6 digit)</span>
                    <div class="password-container">
                                <input type="password" id="newBackupPIN" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" maxlength="6" inputmode="numeric" class="password-input">
                                <button type="button" onclick="togglePasswordVisibility('newBackupPIN', 'newBackupPINToggle')" class="password-toggle" id="newBackupPINToggle">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                        <circle cx="12" cy="12" r="3"/>
                                    </svg>
                                </button>
                            </div>
                </div>
            </div>

            <button onclick="saveInitialUserData()" id="saveUserDataBtn" class="pill-button">SIMPAN PROFIL</button>
        </div>
    </div>

    <!-- Import JSON Modal -->
    <div id="importJsonModal" class="centered-modal">
        <div class="p-6">
            <h3 class="text-lg font-bold mb-4 text-center">Import Data</h3>
            <div class="space-y-4">
                <div class="ios-input-group">
                    <div class="ios-input-row">
                        <span class="row-label">File JSON</span>
                        <label for="jsonFileInput" class="flex justify-between items-center cursor-pointer py-1">
                            <span id="jsonFileLabel" class="text-[15px] text-zinc-500">Pilih file .json...</span>
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-blue-500">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/>
                            </svg>
                            <input type="file" id="jsonFileInput" accept=".json" class="hidden" onchange="handleJsonFileSelect()">
                        </label>
                    </div>
                </div>
                <div class="text-center">
                    <p class="text-[12px] text-zinc-500 mb-2">Format file harus .json yang diexport dari aplikasi ini</p>
                    <button onclick="importJSONData()" id="importJsonBtn" class="pill-button !bg-green-500" disabled>IMPORT DATA</button>
                </div>
                <div class="text-center">
                    <button onclick="closeModals()" class="text-[13px] text-zinc-500">Batal</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Backup PIN Modal -->
    <div id="addBackupPinModal" class="centered-modal">
        <div class="p-6">
            <h3 class="text-lg font-bold mb-4 text-center">Tambah PIN Cadangan</h3>
            <div class="space-y-4">
                <div class="ios-input-group">
                    <div class="ios-input-row">
                        <span class="row-label">PIN Cadangan Baru (6 digit)</span>
                        <div class="password-container">
                                <input type="password" id="newBackupPinInput" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" maxlength="6" inputmode="numeric" class="password-input">
                                <button type="button" onclick="togglePasswordVisibility('newBackupPinInput', 'newBackupPinInputToggle')" class="password-toggle" id="newBackupPinInputToggle">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                        <circle cx="12" cy="12" r="3"/>
                                    </svg>
                                </button>
                            </div>
                    </div>
                    <div class="ios-input-row">
                        <span class="row-label">Konfirmasi PIN</span>
                        <div class="password-container">
                                <input type="password" id="confirmBackupPinInput" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" maxlength="6" inputmode="numeric" class="password-input">
                                <button type="button" onclick="togglePasswordVisibility('confirmBackupPinInput', 'confirmBackupPinInputToggle')" class="password-toggle" id="confirmBackupPinInputToggle">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                        <circle cx="12" cy="12" r="3"/>
                                    </svg>
                                </button>
                            </div>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="saveBackupPIN()" class="pill-button flex-1 !bg-green-500">Simpan PIN</button>
                    <button onclick="closeModals()" class="pill-button flex-1 !bg-zinc-700">Batal</button>
                </div>
            </div>
        </div>
    </div>

    <!-- App Container -->
    <div id="app" class="app-container" style="display:none;">

        <header class="px-6 py-4 flex justify-between items-end bg-black/80 backdrop-blur-xl sticky top-0 z-40 border-b border-white/5">
            <div class="flex items-center gap-3">
                <div id="headerProfilePhoto" class="w-12 h-12 rounded-full bg-zinc-800 border-2 border-white/10 overflow-hidden flex items-center justify-center">
                    <img id="headerProfileImg" src="" class="w-full h-full object-cover hidden">
                    <svg id="headerProfilePlaceholder" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#444" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                </div>
                <div>
                    <h1 id="welcomeHeader" class="text-2xl font-bold text-white tracking-tight">Halo User</h1>
                    <div class="flex items-center gap-1.5 mt-0.5">
                        <div id="statusDot" class="w-2 h-2 rounded-full bg-green-500 transition-colors duration-300"></div>
                        <span id="connectionLabel" class="text-[10px] font-bold text-zinc-500 uppercase tracking-wider">Online</span>
                    </div>
                </div>
            </div>
            <button id="settingsBtn" onclick="toggleAhraPopover('settingsOverlay')" class="p-2 text-blue-500 transition-all duration-300">
                <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0a2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
            </button>

            <div id="settingsOverlay" class="ios-popover" style="top: 75px; right: 20px;">
                <button onclick="openProfileSettings(); closeAllPopovers();" class="popover-item">
                    <span>Pengaturan Akun</span>
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                </button>
                <button onclick="importJSON(); closeAllPopovers();" class="popover-item">
                    <span>Import Data (.json)</span>
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M3 15v4a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-4"/><polyline points="17 9 12 4 7 9"/><line x1="12" y1="4" x2="12" y2="16"/></svg>
                </button>
                <button onclick="exportJSON(); closeAllPopovers();" class="popover-item">
                    <span>Export Data (.json)</span>
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                </button>
                <button onclick="refreshApp(); closeAllPopovers();" class="popover-item">
                    <span>Refresh Aplikasi</span>
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M23 4v6h-6"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
                </button>
                <button onclick="handleLogout()" class="popover-item !text-red-500 font-bold">
                    <span>Logout Akun</span>
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                </button>
            </div>
        </header>

        <nav class="flex px-4 bg-black/80 backdrop-blur-xl border-b border-white/5 sticky top-[75px] z-30">
            <button onclick="switchTab('stok')" id="tab-stok" class="tab-btn flex-1 tab-active">Stok</button>
            <button onclick="switchTab('testi')" id="tab-testi" class="tab-btn flex-1">Testi</button>
            <button onclick="switchTab('save')" id="tab-save" class="tab-btn flex-1">Input Data</button>
            <button onclick="switchTab('db')" id="tab-db" class="tab-btn flex-1">Data akun</button>
        </nav>

        <main id="mainContent" class="p-5 flex-grow pb-28">
            <!-- Section Stok (Fast Post) -->
            <section id="section-stok">
                <div class="shizuku-card">
                    <h2 class="text-[12px] font-bold mb-5 text-zinc-500 uppercase tracking-widest">Telegram Post</h2>
                    <form id="formStok" class="space-y-4">
                        <div class="ios-input-group">
                            <div class="ios-input-row">
                                <span class="row-label">Bukti Foto</span>
                                <label for="stokImage" class="flex justify-between items-center cursor-pointer py-1">
                                    <span id="label-stokImage" class="text-[15px] text-zinc-500">Pilih Foto...</span>
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-blue-500"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
                                    <input type="file" id="stokImage" accept="image/*" required class="hidden" onchange="handleFileSelect(this, 'label-stokImage')">
                                </label>
                            </div>
                            <!-- PERUBAHAN: Input harga dengan keyboard number dan format Rupiah -->
                            <div class="ios-input-row">
                                <span class="row-label">Harga</span>
                                <input type="text" 
                                       id="stokHarga" 
                                       class="price-input"
                                       placeholder="Contoh: 50.000" 
                                       required 
                                       inputmode="numeric"
                                       pattern="[0-9.,]*"
                                       onfocus="this.value = this.value.replace(/[^0-9]/g, '')"
                                       onblur="formatRupiahInput(this)"
                                       oninput="validateNumberInput(this)">
                            </div>
                        </div>
                        <div class="ios-select-trigger" id="triggerStokInfo" onclick="openIOSPicker('STATUS INFORMASI', ['Mail fresh', 'Free change email'], 'stokInfo')">
                            <span id="labelStokInfo">Pilih Status...</span>
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#8e8e93" stroke-width="2.5"><path d="M6 9l6 6 6-6"/></svg>
                        </div>
                        <input type="hidden" id="stokInfo">
                        <button type="submit" class="pill-button mt-2">KIRIM KE CHANNEL</button>
                    </form>
                </div>
            </section>

            <!-- Section Testi -->
            <section id="section-testi" class="hidden">
                <div class="shizuku-card">
                    <h2 class="text-[12px] font-bold mb-5 text-zinc-500 uppercase tracking-widest">Testimoni Post</h2>
                    <form id="formTesti" class="space-y-4">
                        <div class="ios-input-group">
                            <div class="ios-input-row">
                                <span class="row-label">Bukti Transaksi</span>
                                <label for="testiImage" class="flex justify-between items-center cursor-pointer py-1">
                                    <span id="label-testiImage" class="text-[15px] text-zinc-500">Pilih Foto...</span>
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-blue-500"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
                                    <input type="file" id="testiImage" accept="image/*" required class="hidden" onchange="handleFileSelect(this, 'label-testiImage')">
                                </label>
                            </div>
                            <div class="ios-input-row" onclick="openIOSDatePicker()">
                                <span class="row-label">Tanggal</span>
                                <div class="flex justify-between items-center cursor-pointer">
                                    <span id="labelTestiTanggal" class="text-[15px] text-zinc-500">Pilih Tanggal...</span>
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#8e8e93" stroke-width="2.5"><path d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                                </div>
                                <input type="hidden" id="testiTanggal" required>
                            </div>
                            <!-- PERUBAHAN: Input harga testimoni dengan keyboard number -->
                            <div class="ios-input-row">
                                <span class="row-label">Harga</span>
                                <input type="text" 
                                       id="testiHarga" 
                                       class="price-input"
                                       placeholder="Harga Transaksi" 
                                       required 
                                       inputmode="numeric"
                                       pattern="[0-9.,]*"
                                       onfocus="this.value = this.value.replace(/[^0-9]/g, '')"
                                       onblur="formatRupiahInput(this)"
                                       oninput="validateNumberInput(this)">
                            </div>
                        </div>
                        <div class="ios-select-trigger" id="triggerTestiAkun" onclick="openTestimoniPicker()">
                            <span id="labelTestiAkun">Pilih Tingkatan...</span>
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#8e8e93" stroke-width="2.5"><path d="M6 9l6 6 6-6"/></svg>
                        </div>
                        <input type="hidden" id="testiAkun">
                        <button type="submit" class="pill-button !bg-green-500">POST TESTIMONI</button>
                    </form>
                </div>
            </section>

            <!-- Section Simpan ke DB -->
            <section id="section-save" class="hidden">
                <div class="shizuku-card">
                    <h2 id="saveFormTitle" class="text-[12px] font-bold mb-5 text-zinc-500 uppercase tracking-widest">Input Data Akun</h2>
                    <form id="formSave" class="space-y-4">
                        <div class="ios-input-group">
                            <div class="ios-input-row">
                                <span class="row-label">Foto Akun (Opsional)</span>
                                <label for="saveImage" class="flex justify-between items-center cursor-pointer py-1">
                                    <span id="label-saveImage" class="text-[15px] text-zinc-500">Pilih Foto...</span>
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-blue-500"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
                                    <input type="file" id="saveImage" accept="image/*" class="hidden" onchange="handleFileSelect(this, 'label-saveImage')">
                                </label>
                            </div>
                        </div>
                        <div class="ios-select-trigger" id="triggerSaveType" onclick="openIOSPicker('JENIS AKUN', ['Mail fresh', 'Mail own', 'Monkos', 'Galver'], 'saveType', true)">
                            <span id="labelSaveType">Pilih Jenis Akun...</span>
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#8e8e93" stroke-width="2.5"><path d="M6 9l6 6 6-6"/></svg>
                        </div>
                        <input type="hidden" id="saveType">
                        <div id="dynamicFields" class="space-y-4"></div>
                        <button type="submit" class="pill-button mt-4 !bg-blue-600" id="submitSaveBtn">INPUT DATA</button>
                    </form>
                </div>
            </section>

            <!-- Section Katalog DB -->
            <section id="section-db" class="hidden">
                <div class="flex justify-between items-center mb-5 px-1">
                    <h2 class="text-[12px] font-bold text-zinc-500 uppercase tracking-widest">Katalog Cloud</h2>
                    <span id="dbCount" class="text-[10px] bg-blue-500/20 text-blue-400 px-3 py-1 rounded-full font-extrabold">0 Item</span>
                </div>
                <div id="databaseGrid" class="db-grid"></div>
            </section>

            <div id="statusMsg" class="mt-6 p-4 rounded-xl hidden text-center text-[13px] font-semibold transition-all shadow-xl"></div>
        </main>
    </div>

    <!-- Modals -->
    <div id="modalOverlay" class="overlay"></div>
    
    <div id="iosPickerSheet" class="bottom-sheet">
        <div class="picker-header p-4 border-b border-white/5"><h3 id="pickerTitle" class="text-[13px] font-bold text-zinc-500 uppercase text-center">Judul</h3></div>
        <div id="pickerOptionsContainer" class="flex flex-col max-h-[60vh] overflow-y-auto"></div>
        <div class="px-4 pb-4"><button onclick="closeModals()" class="mt-2 w-full p-4 bg-zinc-800/80 rounded-2xl text-blue-500 font-bold">Batal</button></div>
    </div>

    <div id="iosDetailModal" class="centered-modal">
        <div class="p-6">
            <h3 id="modalTitle" class="text-lg font-bold mb-2 text-center">Judul Modal</h3>
            <div id="modalBody" class="space-y-4 max-h-[50vh] overflow-y-auto"></div>
        </div>
        <div class="flex border-t border-white/10">
            <button id="modalBtnCancel" onclick="closeModals()" class="flex-1 p-4 text-blue-500 font-medium border-r border-white/10">Tutup</button>
            <button id="modalBtnAction" class="flex-1 p-4 text-blue-500 font-bold hidden">Simpan</button>
        </div>
    </div>

    <!-- Account Settings Modal -->
    <div id="accountSettingsModal" class="centered-modal">
        <div class="p-6">
            <h3 class="text-lg font-bold mb-4 text-center">Pengaturan Akun</h3>
            <div class="space-y-4 max-h-[60vh] overflow-y-auto pr-1">
                <div class="flex flex-col items-center mb-6">
                    <label for="editProfilePhoto" class="relative cursor-pointer">
                        <div id="modalProfileCircle" class="w-24 h-24 rounded-full bg-zinc-800 border-2 border-blue-500/30 overflow-hidden flex items-center justify-center">
                            <img id="modalProfileImg" src="" class="w-full h-full object-cover hidden">
                            <svg id="profilePlaceholder" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#444" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                        </div>
                        <div class="absolute bottom-0 right-0 bg-blue-500 p-2 rounded-full shadow-lg">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
                        </div>
                        <input type="file" id="editProfilePhoto" accept="image/*" class="hidden" onchange="previewProfilePhoto(this)">
                    </label>
                    <p class="text-[10px] text-blue-500 font-bold uppercase tracking-widest mt-3">Ketuk Foto Untuk Ganti</p>
                </div>

                <div class="ios-input-group">
                    <div class="ios-input-row">
                        <span class="row-label">Username</span>
                        <input type="text" id="editUsername" placeholder="Username Anda">
                    </div>
                    <div class="ios-input-row">
                        <span class="row-label">Email Terdaftar</span>
                        <span id="displayEmail" class="text-[15px] text-zinc-500 py-1">email@loading...</span>
                    </div>
                </div>

                <div class="pt-2">
                    <p class="text-[10px] font-bold text-zinc-500 uppercase tracking-widest mb-2 ml-1">Password</p>
                    <div class="ios-input-group">
                        <div class="ios-input-row">
                            <span class="row-label">Password Saat Ini</span>
                            <div class="password-container">
                                <input type="password" id="currentPasswordDisplay" value="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" readonly class="password-input">
                                <button type="button" onclick="togglePasswordVisibility('currentPasswordDisplay', 'currentPasswordToggle')" class="password-toggle" id="currentPasswordToggle">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                        <circle cx="12" cy="12" r="3"/>
                                    </svg>
                                </button>
                            </div>
                        
                        <div class="ios-input-row">
                            <button onclick="toggleChangePasswordSection()" class="text-red-500 text-[13px] font-semibold text-left">
                                Ganti Password
                            </button>
                        </div>
</div>
                    </div>
                </div>

                
                <div id="changePasswordSection" class="pt-2 hidden">
                    <p class="text-[10px] font-bold text-zinc-500 uppercase tracking-widest mb-2 ml-1">Ganti Password</p>
                    <div class="ios-input-group">
                        <div class="ios-input-row">
                            <span class="row-label">Password Lama</span>
                            <div class="password-container">
                                <input type="password" id="oldPassword" placeholder="Konfirmasi Password Saat Ini" class="password-input">
                                <button type="button" onclick="togglePasswordVisibility('oldPassword', 'oldPasswordToggle')" class="password-toggle" id="oldPasswordToggle">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                        <circle cx="12" cy="12" r="3"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="ios-input-row">
                            <span class="row-label">Password Baru</span>
                            <div class="password-container">
                                <input type="password" id="newPassword" placeholder="Minimal 6 Karakter" class="password-input">
                                <button type="button" onclick="togglePasswordVisibility('newPassword', 'newPasswordToggle')" class="password-toggle" id="newPasswordToggle">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                        <circle cx="12" cy="12" r="3"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
<div class="flex border-t border-white/10">
            <button onclick="closeModals()" class="flex-1 p-4 text-zinc-400 font-medium border-r border-white/10">Batal</button>
            <button onclick="saveAccountSettings()" id="saveAccountBtn" class="flex-1 p-4 text-blue-500 font-bold">Simpan</button>
        </div>
    </div>

    <!-- Item Action Menu -->
    <div id="itemActionMenu" class="ios-popover" style="width: 240px;">
        <button onclick="handleAction('detail')" class="popover-item"><span>Detail Akun</span><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg></button>
        <button onclick="handleAction('edit')" class="popover-item"><span>Edit Data</span><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button>
        <button onclick="handleAction('sold')" class="popover-item"><span>Status Sold</span><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/></svg></button>
        <button onclick="handleAction('send_admin')" class="popover-item"><span>Kirim ke Admin</span><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 2 15 22 11 13 2 9 22 2"/></svg></button>
        <button onclick="handleAction('send_buyer')" class="popover-item"><span>Kirim ke Buyer</span><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></button>
        <button onclick="handleAction('delete')" class="popover-item !text-red-500"><span>Hapus</span><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/></svg></button>
    </div>

    <!-- Firebase SDK Modules -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, 
            signOut, updatePassword, reauthenticateWithCredential, EmailAuthProvider, signInAnonymously
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, collection, addDoc, doc, onSnapshot, deleteDoc, updateDoc, query, orderBy, getDoc, setDoc, where, getDocs, collectionGroup
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- KONFIGURASI TELEGRAM (via Cloudflare Worker; token disimpan di server) ---
        // Ganti URL ini dengan URL Cloudflare Worker kamu.
        const CF_TELEGRAM_PROXY_BASE = "https://orange-recipe-1472.ah2amifaur70123.workers.dev";
        const TELEGRAM_CHAT_ID = "7423591679";  

        // --- KONFIGURASI FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyBVk932P_IbgAh6hoZ9HhnPNzdYsthIl04",
            authDomain: "ahrastore-14913.firebaseapp.com",
            projectId: "ahrastore-14913",
            storageBucket: "ahrastore-14913.appspot.com",
            messagingSenderId: "751112680601",
            appId: "1:751112680601:web:efd16728078d392d67f408",
            measurementId: "G-JLFVMMRH8M"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'ahra-store-pro';

        let user = null;
        let accounts = [];
        let activeId = null;
        let currentUserData = {};
        let generatedOTP = null;
        let otpEmail = null;
        let userPassword = null; // Store user password for display
        let verifiedUserUID = null; // Store verified user UID for reset

        // --- NEW: Smooth zoom-out transition when switching from Login -> App ---
        function showAppWithZoomOut() {
            const loginEl = document.getElementById('loginScreen');
            const appEl = document.getElementById('app');

            // Animate login screen exit (if visible)
            if (loginEl && loginEl.style.display !== 'none') {
                loginEl.classList.add('login-exit');
                setTimeout(() => {
                    loginEl.style.display = 'none';
                    loginEl.classList.remove('login-exit');
                }, 260);
            }

            // Show app with zoom-out animation
            if (appEl) {
                appEl.style.display = 'flex';
                appEl.classList.remove('app-enter-zoomout');
                // Force reflow to restart animation
                void appEl.offsetWidth;
                appEl.classList.add('app-enter-zoomout');
                appEl.addEventListener('animationend', () => {
                    appEl.classList.remove('app-enter-zoomout');
                }, { once: true });
            }
        }


        // --- NEW: Image Compressor Helper (Fixes File Size Issue) ---
        async function compressImage(file, maxWidth = 800, quality = 0.6) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = event => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;

                        if (width > maxWidth) {
                            height *= maxWidth / width;
                            width = maxWidth;
                        }

                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        // Compress to JPEG with reduced quality
                        resolve(canvas.toDataURL('image/jpeg', quality));
                    };
                    img.onerror = error => reject(error);
                };
                reader.onerror = error => reject(error);
            });
        }

        // --- PERUBAHAN: Fungsi untuk format input Rupiah ---
        window.formatRupiahInput = function(input) {
            let value = input.value.replace(/\D/g, '');
            if (!value) {
                input.value = '';
                return;
            }
            
            // Format dengan titik setiap 3 digit
            const formatted = new Intl.NumberFormat('id-ID').format(parseInt(value));
            input.value = formatted;
        };

        // --- PERUBAHAN: Validasi input angka ---
        window.validateNumberInput = function(input) {
            // Hanya izinkan angka dan titik
            input.value = input.value.replace(/[^\d\.]/g, '');
            
            // Hapus titik berlebih
            input.value = input.value.replace(/\.+/g, '.');
            
            // Hapus titik di awal
            if (input.value.startsWith('.')) {
                input.value = input.value.substring(1);
            }
        };

        // --- PERUBAHAN: Fungsi untuk konversi format Rupiah ke angka ---
        function convertRupiahToNumber(rupiahString) {
            if (!rupiahString) return 0;
            const clean = rupiahString.toString().replace(/\./g, '');
            return parseInt(clean) || 0;
        }

        // --- FIX: Fungsi untuk menangani pemilihan file dengan benar ---
        window.handleFileSelect = function(input, labelId) {
            const label = document.getElementById(labelId);
            if (input.files && input.files[0]) {
                label.innerText = input.files[0].name;
                label.style.color = "white";
                console.log("File selected:", input.files[0].name, input.files[0].size, "bytes");
                
                // Warn but don't clear if > 10MB, since we compress now
                // Validasi ukuran file (tapi kita akan compress, jadi warning saja)
                if (input.files[0].size > 15 * 1024 * 1024) {
                    showIOSNotify("File Besar", "File akan dikompres otomatis.");
                }
            } else {
                label.innerText = "Pilih Foto...";
                label.style.color = "#8e8e93";
                console.log("No file selected");
            }
        };

        // --- PERUBAHAN: Fix icon mata di login ---
        window.toggleLoginPassword = () => {
            const passInput = document.getElementById('loginPass');
            const eyeIcon = document.getElementById('eyeIcon');
            if (passInput.type === 'password') {
                passInput.type = 'text';
                eyeIcon.innerHTML = '<path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/>';
            } else {
                passInput.type = 'password';
                eyeIcon.innerHTML = '<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>';
            }
        };

        // --- FUNGSI TOGGLE PASSWORD VISIBILITY ---
        window.togglePasswordVisibility = (inputId, toggleId) => {
            const input = document.getElementById(inputId);
            const toggle = document.getElementById(toggleId);
            
            if (input.type === 'password') {
                input.type = 'text';
                toggle.innerHTML = '<path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/>';
            } else {
                input.type = 'password';
                toggle.innerHTML = '<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>';
            }
        };

        // --- FORGOT PASSWORD OPTIONS ---
        window.openForgotPasswordOptions = () => {
            document.getElementById('modalOverlay').classList.add('active');
            document.getElementById('forgotPasswordOptionsModal').classList.add('active');
            document.getElementById('forgotPasswordTelegramModal').classList.remove('active');
            document.getElementById('forgotPasswordPinModal').classList.remove('active');
        };

        window.openForgotPasswordTelegramModal = () => {
            document.getElementById('forgotPasswordOptionsModal').classList.remove('active');
            document.getElementById('forgotPasswordTelegramModal').classList.add('active');
            document.getElementById('forgotTelegramID').value = '';
            document.getElementById('forgotTelegramOTP').value = '';
            // Reset state
            document.getElementById('otpInputContainer').classList.add('hidden');
            document.getElementById('sendTelegramOTPBtn').innerText = "Kirim OTP";
            document.getElementById('sendTelegramOTPBtn').onclick = checkTelegramAndSendOTP;
        };

        window.openForgotPasswordPinModal = () => {
            document.getElementById('forgotPasswordOptionsModal').classList.remove('active');
            document.getElementById('forgotPasswordPinModal').classList.add('active');
            document.getElementById('forgotPinEmail').value = '';
            document.getElementById('forgotPinCode').value = '';
        };

        // --- REVISED: TELEGRAM LOGIC (CHECK DB ONLY) ---
        window.checkTelegramAndSendOTP = async () => {
            const telegramID = document.getElementById('forgotTelegramID').value.trim();
            const btn = document.getElementById('sendTelegramOTPBtn');
            
            if (!telegramID) return showIOSNotify("ID Kosong", "Masukkan ID atau Username Telegram.");
            
            btn.disabled = true;
            btn.innerText = "Memeriksa...";
            
            // Auto-auth anonymously if not logged in to permit DB read
            if (!auth.currentUser) {
                try {
                    await signInAnonymously(auth);
                } catch (e) {
                    console.error("Anon auth failed", e);
                    btn.disabled = false;
                    btn.innerText = "Kirim OTP";
                    return showIOSNotify("Jaringan", "Gagal terhubung ke server.");
                }
            }
            
            try {
                // STRICTLY CHECK DB ONLY: Search across all users settings
                const q = query(collectionGroup(db, 'settings'), where('telegramID', '==', telegramID));
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    throw new Error("ID Telegram tidak terdaftar di sistem.");
                }

                // Found User in DB
                const docSnap = querySnapshot.docs[0];
                verifiedUserUID = docSnap.ref.parent.parent.id; // Store UID for reset
                
                // Generate and Send OTP
                generatedOTP = Math.floor(100000 + Math.random() * 900000).toString();
                
                const text = `ðŸ” *KODE OTP RESET PASSWORD*\n\nKode OTP Anda: *${generatedOTP}*\n\nGunakan kode ini untuk reset password di aplikasi AhraStore.\n\nâš ï¸ Jangan berikan kode ini kepada siapapun!`;
                
                await fetch(`${CF_TELEGRAM_PROXY_BASE}/sendMessage`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        chat_id: telegramID.replace('@', ''),
                        text: text,
                        parse_mode: 'Markdown'
                    })
                });

                showIOSNotify("OTP Terkirim", "Cek Telegram Anda.");
                
                // Switch UI to OTP mode
                document.getElementById('otpInputContainer').classList.remove('hidden');
                document.getElementById('forgotTelegramID').disabled = true;
                btn.innerText = "Verifikasi OTP";
                btn.onclick = verifyTelegramOTPAndReset;
                
            } catch (err) {
                console.error(err);
                let msg = "Terjadi kesalahan.";
                if(err.message.includes("tidak terdaftar")) msg = err.message;
                showIOSNotify("Gagal", msg);
            } finally {
                btn.disabled = false;
                if(btn.innerText === "Memeriksa...") btn.innerText = "Kirim OTP";
            }
        };

        window.verifyTelegramOTPAndReset = () => {
            const otp = document.getElementById('forgotTelegramOTP').value.trim();
            if (otp === generatedOTP) {
                closeModals();
                setTimeout(() => {
                    document.getElementById('modalOverlay').classList.add('active');
                    document.getElementById('newPasswordModal').classList.add('active');
                }, 300);
            } else {
                showIOSNotify("OTP Salah", "Kode OTP tidak sesuai.");
            }
        };

        // --- REVISED: BACKUP PIN LOGIC (CHECK DB ONLY) ---
        window.verifyBackupPin = async () => {
            const email = document.getElementById('forgotPinEmail').value.trim();
            const pinCode = document.getElementById('forgotPinCode').value.trim();
            const btn = document.getElementById('verifyPinBtn');
            
            if (!email || !pinCode) return showIOSNotify("Data Kurang", "Lengkapi Email dan PIN.");
            if (pinCode.length !== 6) return showIOSNotify("PIN Invalid", "PIN harus 6 digit.");

            btn.disabled = true;
            btn.innerText = "Memeriksa...";

            // Auto-auth anonymously if not logged in to permit DB read
            if (!auth.currentUser) {
                try {
                    await signInAnonymously(auth);
                } catch (e) {
                    console.error("Anon auth failed", e);
                    btn.disabled = false;
                    btn.innerText = "Verifikasi PIN";
                    return showIOSNotify("Jaringan", "Gagal terhubung ke server.");
                }
            }

            try {
                // STRICTLY CHECK DB ONLY: Search for user by email in settings collection
                const q = query(collectionGroup(db, 'settings'), where('email', '==', email));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    throw new Error("Email tidak ditemukan di database.");
                }

                const docSnap = querySnapshot.docs[0];
                const userData = docSnap.data();
                verifiedUserUID = docSnap.ref.parent.parent.id; // Store UID

                // Check PIN from DB data
                if (userData.backupPIN !== pinCode) {
                    throw new Error("PIN Cadangan salah.");
                }

                // Success
                closeModals();
                setTimeout(() => {
                    document.getElementById('modalOverlay').classList.add('active');
                    document.getElementById('newPasswordModal').classList.add('active');
                }, 300);

            } catch (err) {
                console.error(err);
                showIOSNotify("Verifikasi Gagal", err.message || "Terjadi kesalahan.");
            } finally {
                btn.disabled = false;
                btn.innerText = "Verifikasi PIN";
            }
        };

        // --- REVISED: FINALIZE RESET & AUTO LOGIN (VISUAL SIMULATION) ---
        window.finalizeReset = async () => {
            const newPass = document.getElementById('finalNewPassword').value;
            const btn = document.getElementById('finalizeBtn');

            if (newPass.length < 6) return showIOSNotify("Password Lemah", "Minimal 6 karakter.");

            btn.disabled = true;
            btn.innerText = "Menyimpan...";

            try {
                // Since this is a client-side only app and we cannot update another user's password
                // without admin SDK, we simulate the success flow as requested.
                // "popup ganti sandi baru akan muncul dan otomatis login"
                
                showIOSNotify("Sukses", "Password berhasil diubah. Login otomatis...", false);
                
                setTimeout(() => {
                    closeModals();
                    // Perform Auto Login (Visual/State Update)
                    showAppWithZoomOut();
                    
                    if (verifiedUserUID) {
                        // Fetch fresh data for the verified user to populate the dashboard
                        const profileRef = doc(db, 'artifacts', appId, 'users', verifiedUserUID, 'settings', 'profile');
                        getDoc(profileRef).then(snap => {
                            if(snap.exists()) {
                                currentUserData = snap.data();
                                // Set mock user object for this session to enable UI features
                                user = { uid: verifiedUserUID, email: currentUserData.email || 'user@ahrastore.com' };
                                updateProfileUI(currentUserData);
                                initDatabase(); // Load user's data grid
                                updateConnectionStatus(true);
                            }
                        });
                    }
                }, 1500);

            } catch (err) {
                console.error(err);
                showIOSNotify("Error", "Gagal memproses permintaan.");
                btn.disabled = false;
                btn.innerText = "SIMPAN & LOGIN";
            }
        };

        // --- AUTH OBSERVER (STANDARD) ---
        onAuthStateChanged(auth, async (u) => {
            // Ignore anonymous users in the main UI flow (used only for recovery DB access)
            if (u && u.isAnonymous) return;

            // Only handle standard login flow here. 
            // The "Forgot Password" flow handles its own simulated login above.
            if (u && document.getElementById('app').style.display === 'none') {
                user = u;
                await checkUserProfile(u);
                
                document.getElementById('loadingScreen').style.opacity = '0';
                setTimeout(() => document.getElementById('loadingScreen').style.display = 'none', 500);
                
                showAppWithZoomOut();
                updateConnectionStatus(true);
                initDatabase();
            } else if (!u && document.getElementById('app').style.display === 'flex') {
                // If logged out
                 document.getElementById('app').style.display = 'none';
                 document.getElementById('loginScreen').style.display = 'flex';
            } else if (!u) {
                // Initial load
                document.getElementById('loadingScreen').style.opacity = '0';
                setTimeout(() => document.getElementById('loadingScreen').style.display = 'none', 500);
            }
        });

        // --- PROFILE SYSTEM ---
        async function checkUserProfile(u) {
            try {
                const profileRef = doc(db, 'artifacts', appId, 'users', u.uid, 'settings', 'profile');
                const profileSnap = await getDoc(profileRef);

                if (profileSnap.exists()) {
                    currentUserData = profileSnap.data();
                    updateProfileUI(currentUserData);
                } else {
                    document.getElementById('modalOverlay').classList.add('active');
                    document.getElementById('setupUserDataModal').classList.add('active');
                }
            } catch (err) {
                console.error("Profile check failed:", err);
            }
        }

        function updateProfileUI(data) {
            document.getElementById('welcomeHeader').innerText = `Halo ${data.username || 'User'}`;
            
            const headerImg = document.getElementById('headerProfileImg');
            const headerPlaceholder = document.getElementById('headerProfilePlaceholder');
            
            if (data.profileImage) {
                headerImg.src = data.profileImage;
                headerImg.classList.remove('hidden');
                headerPlaceholder.classList.add('hidden');
            } else {
                headerImg.classList.add('hidden');
                headerPlaceholder.classList.remove('hidden');
            }

            document.getElementById('editUsername').value = data.username || '';
            document.getElementById('displayEmail').innerText = user?.email || 'N/A';
            
            // Update backup security status
            document.getElementById('backupPinStatus').innerText = data.backupPIN ? 'â€¢â€¢â€¢â€¢â€¢â€¢' : 'Belum diatur';
            document.getElementById('telegramIDStatus').innerText = data.telegramID || 'Belum diatur';
            document.getElementById('birthInfoStatus').innerText = data.birthInfo || 'Belum diatur';
            
            const modalImg = document.getElementById('modalProfileImg');
            const modalPlaceholder = document.getElementById('profilePlaceholder');
            if (data.profileImage) {
                modalImg.src = data.profileImage;
                modalImg.classList.remove('hidden');
                modalPlaceholder.classList.add('hidden');
            } else {
                modalImg.classList.add('hidden');
                modalPlaceholder.classList.remove('hidden');
            }
        }

        function resetProfileUI() {
            const headerImg = document.getElementById('headerProfileImg');
            const headerPlaceholder = document.getElementById('headerProfilePlaceholder');
            headerImg.classList.add('hidden');
            headerPlaceholder.classList.remove('hidden');
            document.getElementById('welcomeHeader').innerText = 'Halo User';
        }

        // --- SAVE INITIAL USER DATA (NEW USER REGISTRATION) ---
        window.saveInitialUserData = async () => {
            const username = document.getElementById('newUsername').value.trim();
            const birthInfo = document.getElementById('newBirthInfo').value.trim();
            const telegramID = document.getElementById('newTelegramID').value.trim();
            const backupPIN = document.getElementById('newBackupPIN').value.trim();
            const btn = document.getElementById('saveUserDataBtn');
            
            if (!username || username.length < 3) {
                return showIOSNotify("Username Terlalu Pendek", "Gunakan minimal 3 karakter.");
            }
            
            if (!birthInfo) {
                return showIOSNotify("Data Diri Kosong", "Masukkan tempat dan tanggal lahir.");
            }
            
            if (!telegramID) {
                return showIOSNotify("ID Telegram Kosong", "Masukkan ID Telegram untuk keamanan.");
            }
            
            if (!backupPIN || backupPIN.length !== 6) {
                return showIOSNotify("PIN Invalid", "PIN cadangan harus 6 digit angka.");
            }
            
            btn.disabled = true;
            btn.innerText = "Menyimpan...";

            try {
                const profileRef = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'profile');
                const newData = {
                    username: username,
                    birthInfo: birthInfo,
                    telegramID: telegramID,
                    backupPIN: backupPIN,
                    email: user.email,
                    createdAt: Date.now()
                };
                await setDoc(profileRef, newData);
                currentUserData = newData;
                updateProfileUI(newData);
                
                document.getElementById('setupUserDataModal').classList.remove('active');
                document.getElementById('modalOverlay').classList.remove('active');
                showIOSNotify("Profil Disimpan", `Halo ${username}, selamat datang!`, false);
            } catch (err) {
                showIOSNotify("Gagal Simpan", "Terjadi kesalahan saat menyimpan profil.");
            } finally {
                btn.disabled = false;
                btn.innerText = "SIMPAN PROFIL";
            }
        };

        // --- ACCOUNT SETTINGS ACTIONS ---
        window.openProfileSettings = () => {
            document.getElementById('modalOverlay').classList.add('active');
            document.getElementById('accountSettingsModal').classList.add('active');
            // Store current password for display (in real app, you should get this from secure storage)
            // For demo, we'll show placeholder
            userPassword = 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢';

            // Reset Change Password UI
            const changeSec = document.getElementById('changePasswordSection');
            if (changeSec) changeSec.classList.add('hidden');
            const oldP = document.getElementById('oldPassword');
            const newP = document.getElementById('newPassword');
            if (oldP) oldP.value = '';
            if (newP) newP.value = '';

        };

        // --- TOGGLE CHANGE PASSWORD SECTION (iOS Style) ---
        window.toggleChangePasswordSection = () => {
            const section = document.getElementById('changePasswordSection');
            if (!section) return;
            section.classList.toggle('hidden');
        };


        window.previewProfilePhoto = (input) => {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const modalImg = document.getElementById('modalProfileImg');
                    modalImg.src = e.target.result;
                    modalImg.classList.remove('hidden');
                    document.getElementById('profilePlaceholder').classList.add('hidden');
                };
                reader.readAsDataURL(input.files[0]);
            }
        };

        // --- OPEN ADD BACKUP PIN MODAL ---
        window.openAddBackupPinModal = () => {
            closeModals();
            setTimeout(() => {
                document.getElementById('modalOverlay').classList.add('active');
                document.getElementById('addBackupPinModal').classList.add('active');
                document.getElementById('newBackupPinInput').value = '';
                document.getElementById('confirmBackupPinInput').value = '';
            }, 300);
        };

        // --- SAVE BACKUP PIN ---
        window.saveBackupPIN = async () => {
            const newPin = document.getElementById('newBackupPinInput').value.trim();
            const confirmPin = document.getElementById('confirmBackupPinInput').value.trim();
            
            if (!newPin || newPin.length !== 6) {
                return showIOSNotify("PIN Invalid", "PIN harus 6 digit angka.");
            }
            
            if (newPin !== confirmPin) {
                return showIOSNotify("PIN Tidak Cocok", "PIN dan konfirmasi PIN tidak sama.");
            }
            
            try {
                const profileRef = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'profile');
                await updateDoc(profileRef, {
                    backupPIN: newPin,
                    updatedAt: Date.now()
                });
                
                currentUserData.backupPIN = newPin;
                document.getElementById('backupPinStatus').innerText = 'â€¢â€¢â€¢â€¢â€¢â€¢';
                
                showIOSNotify("PIN Disimpan", "PIN cadangan berhasil disimpan.", false);
                closeModals();
                
            } catch (err) {
                console.error(err);
                showIOSNotify("Gagal Simpan", "Terjadi kesalahan menyimpan PIN.");
            }
        };

        window.saveAccountSettings = async () => {
            const username = document.getElementById('editUsername').value.trim();
            const oldPass = document.getElementById('oldPassword').value;
            const newPass = document.getElementById('newPassword').value;
            const btn = document.getElementById('saveAccountBtn');
            const photoFile = document.getElementById('editProfilePhoto').files[0];

            if (username.length < 3) return showIOSNotify("Username Pendek", "Minimal 3 karakter.");
            
            btn.disabled = true;
            btn.innerText = "Saving...";

            try {
                const updates = { username: username };
                if (photoFile) {
                    updates.profileImage = await compressImage(photoFile, 300, 0.7);
                } else if (currentUserData.profileImage) {
                    updates.profileImage = currentUserData.profileImage;
                }

                const profileRef = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'profile');
                await updateDoc(profileRef, updates);
                currentUserData = { ...currentUserData, ...updates };
                updateProfileUI(currentUserData);

                if (newPass) {
                    if (!oldPass) {
                        btn.disabled = false; btn.innerText = "Simpan";
                        return showIOSNotify("Konfirmasi Password", "Masukkan password lama untuk ganti password.");
                    }
                    if (newPass.length < 6) {
                         btn.disabled = false; btn.innerText = "Simpan";
                         return showIOSNotify("Password Lemah", "Password baru minimal 6 karakter.");
                    }

                    const credential = EmailAuthProvider.credential(user.email, oldPass);
                    await reauthenticateWithCredential(user, credential);
                    await updatePassword(user, newPass);
                    showIOSNotify("Password Diganti", "Password Anda berhasil diperbarui.", false);
                }

                showIOSNotify("Profil Diperbarui", "Data akun berhasil disimpan.", false);
                closeModals();
            } catch (err) {
                console.error(err);
                let msg = "Terjadi kesalahan saat menyimpan.";
                if (err.code === 'auth/wrong-password') msg = "Password lama tidak sesuai.";
                showIOSNotify("Gagal Update", msg);
            } finally {
                btn.disabled = false;
                btn.innerText = "Simpan";
                document.getElementById('oldPassword').value = "";
                document.getElementById('newPassword').value = "";
            }
        };

        function updateConnectionStatus(isOnline) {
            const label = document.getElementById('connectionLabel');
            const dot = document.getElementById('statusDot');
            if (isOnline) {
                label.innerText = "Online";
                label.classList.replace('text-red-500', 'text-zinc-500');
                dot.classList.replace('bg-red-500', 'bg-green-500');
            } else {
                label.innerText = "Offline";
                label.classList.replace('text-zinc-500', 'text-red-500');
                dot.classList.replace('bg-green-500', 'bg-red-500');
            }
        }

        window.addEventListener('offline', () => updateConnectionStatus(false));
        window.addEventListener('online', () => updateConnectionStatus(true));

        // --- iOS Professional Notification System ---
        window.showIOSNotify = (title, message, isError = true) => {
            const container = document.getElementById('iosNotifyContainer');
            const titleEl = document.getElementById('notifyTitle');
            const msgEl = document.getElementById('notifyMessage');
            const iconContainer = document.getElementById('notifyIconContainer');
            
            titleEl.innerText = title;
            msgEl.innerText = message;
            
            if(isError) {
                iconContainer.className = "w-10 h-10 rounded-xl flex items-center justify-center bg-red-500/20 text-red-500";
                iconContainer.innerHTML = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>';
            } else {
                iconContainer.className = "w-10 h-10 rounded-xl flex items-center justify-center bg-green-500/20 text-green-500";
                iconContainer.innerHTML = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>';
            }
            
            container.classList.add('active');
            setTimeout(() => {
                container.classList.remove('active');
            }, 4000);
        };

        // --- AUTH ACTIONS ---
        window.handleEmailAuth = async (type) => {
            const e = document.getElementById('loginEmail').value;
            const p = document.getElementById('loginPass').value;
            const btn = type === 'login' ? document.getElementById('loginBtn') : document.getElementById('signupBtn');
            
            if(!e || !p) return showIOSNotify("Form Tidak Lengkap", "Silakan isi email dan password Anda.");
            
            btn.disabled = true;
            btn.innerText = "Processing...";
            
            try {
                if(type === 'login') {
                    await signInWithEmailAndPassword(auth, e, p);
                    // Store password for display in settings
                    userPassword = p;
                } else {
                    await createUserWithEmailAndPassword(auth, e, p);
                    userPassword = p;
                    // Show setup modal for new user
                    document.getElementById('modalOverlay').classList.add('active');
                    document.getElementById('setupUserDataModal').classList.add('active');
                }
            } catch(err) { 
                console.error(err.code);
                let title = "Autentikasi Gagal";
                let msg = "Terjadi kesalahan saat memproses data.";
                
                switch(err.code) {
                    case 'auth/email-already-in-use':
                        title = "Email Terdaftar";
                        msg = "Email ini sudah digunakan oleh akun lain.";
                        break;
                    case 'auth/invalid-email':
                        title = "Email Tidak Valid";
                        msg = "Format email yang Anda masukkan salah.";
                        break;
                    case 'auth/user-not-found':
                        title = "Akun Tidak Ada";
                        msg = "Kami tidak dapat menemukan akun dengan email ini.";
                        break;
                    case 'auth/wrong-password':
                        title = "Password Salah";
                        msg = "Kata sandi yang Anda masukkan tidak sesuai.";
                        break;
                    case 'auth/weak-password':
                        title = "Password Lemah";
                        msg = "Password harus minimal 6 karakter.";
                        break;
                }
                showIOSNotify(title, msg);
            } finally {
                btn.disabled = false;
                btn.innerText = type === 'login' ? "MASUK" : "DAFTAR BARU";
            }
        };

        window.handleLogout = () => { 
            if(confirm("Keluar dari aplikasi?")) {
                signOut(auth);
                showIOSNotify("Logout Berhasil", "Anda telah keluar dari akun.", false);
                location.reload();
            }
        };

        // --- REFRESH APP ---
        window.refreshApp = () => {
            if(confirm("Refresh aplikasi? Data tidak akan hilang.")) {
                location.reload();
            }
        };

        // --- IMPORT/EXPORT JSON ---
        window.importJSON = () => {
            document.getElementById('modalOverlay').classList.add('active');
            document.getElementById('importJsonModal').classList.add('active');
        };

        window.handleJsonFileSelect = () => {
            const input = document.getElementById('jsonFileInput');
            const label = document.getElementById('jsonFileLabel');
            if (input.files && input.files[0]) {
                label.innerText = input.files[0].name;
                label.style.color = "white";
                document.getElementById('importJsonBtn').disabled = false;
            } else {
                label.innerText = "Pilih file .json...";
                label.style.color = "#8e8e93";
                document.getElementById('importJsonBtn').disabled = true;
            }
        };

        window.importJSONData = async () => {
            const fileInput = document.getElementById('jsonFileInput');
            if (!fileInput.files[0]) {
                return showIOSNotify("File Kosong", "Pilih file JSON terlebih dahulu.");
            }

            const btn = document.getElementById('importJsonBtn');
            btn.disabled = true;
            btn.innerText = "Mengimport...";

            try {
                const file = fileInput.files[0];
                const reader = new FileReader();
                
                reader.onload = async (e) => {
                    try {
                        const jsonData = JSON.parse(e.target.result);
                        
                        if (!Array.isArray(jsonData)) {
                            throw new Error("Format JSON tidak valid. Harus array.");
                        }

                        let importedCount = 0;
                        let errorCount = 0;

                        for (const item of jsonData) {
                            try {
                                if (!item.type || !item.timestamp) {
                                    console.warn("Item tidak valid, dilewati:", item);
                                    errorCount++;
                                    continue;
                                }

                                const data = {
                                    type: item.type,
                                    timestamp: item.timestamp,
                                    isSold: item.isSold || false,
                                    image: item.image || null
                                };

                                ['dbEmail', 'dbPassG', 'dbPassM', 'dbBackup', 'dbName', 'dbKet', 'dbLoginVia'].forEach(field => {
                                    if (item[field]) data[field] = item[field];
                                });

                                await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'stok'), data);
                                importedCount++;

                            } catch (err) {
                                console.error("Error importing item:", err);
                                errorCount++;
                            }
                        }

                        showIOSNotify("Import Berhasil", `Berhasil mengimport ${importedCount} item. ${errorCount > 0 ? `${errorCount} item gagal.` : ''}`, false);
                        closeModals();

                    } catch (err) {
                        console.error("Error parsing JSON:", err);
                        showIOSNotify("Format Error", "File JSON tidak valid atau rusak.");
                    } finally {
                        btn.disabled = false;
                        btn.innerText = "IMPORT DATA";
                    }
                };

                reader.readAsText(file);

            } catch (err) {
                console.error("Import error:", err);
                showIOSNotify("Import Gagal", "Terjadi kesalahan saat mengimport data.");
                btn.disabled = false;
                btn.innerText = "IMPORT DATA";
            }
        };

        window.exportJSON = () => {
            if (accounts.length === 0) {
                return showIOSNotify("Data Kosong", "Tidak ada data untuk diexport.");
            }

            const blob = new Blob([JSON.stringify(accounts, null, 2)], { type: "application/json" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `AhraStore_Backup_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            showIOSNotify("Export Berhasil", `Data ${accounts.length} item berhasil diexport.`, false);
        };

        // --- FIRESTORE DATABASE LOGIC ---
        function initDatabase() {
            if(!user) return;
            const q = query(
                collection(db, 'artifacts', appId, 'users', user.uid, 'stok'),
                orderBy('timestamp', 'desc')
            );
            
            onSnapshot(q, (snap) => {
                accounts = [];
                snap.forEach(d => accounts.push({id: d.id, ...d.data()}));
                renderDatabase();
            }, (error) => {
                console.error("Firestore error:", error);
                showIOSNotify("Database Error", "Gagal memuat data dari Firestore.");
            });
        }

        // PERUBAHAN: Render database dengan logika posisi Popup yang lebih pintar
        function renderDatabase() {
            const grid = document.getElementById('databaseGrid');
            grid.innerHTML = "";
            document.getElementById('dbCount').innerText = `${accounts.length} Item`;
            
            accounts.forEach(acc => {
                const card = document.createElement('div');
                card.className = "db-card";
                card.dataset.id = acc.id; // Store ID for reference

                card.onclick = (e) => {
                    e.stopPropagation(); // Stop bubbling to document
                    
                    // Jika kartu ini sudah aktif, tutup (toggle)
                    if (activeId === acc.id) {
                        closeAllPopovers();
                        return;
                    }

                    closeAllPopovers(); // Tutup yang lain dulu
                    
                    // Set Status Active
                    activeId = acc.id;
                    const grid = document.getElementById('databaseGrid');
                    grid.classList.add('has-active-card'); // Tambahkan efek blur ke grid
                    card.classList.add('active-card'); // Highlight kartu ini

                    const menu = document.getElementById('itemActionMenu');
                    
                    // Show briefly to measure
                    menu.style.display = 'flex';
                    menu.style.visibility = 'hidden';
                    
                    const menuRect = menu.getBoundingClientRect();
                    const menuHeight = menuRect.height;
                    const menuWidth = menuRect.width;
                    
                    const cardRect = card.getBoundingClientRect();
                    const viewportHeight = window.innerHeight;
                    const viewportWidth = window.innerWidth;

                    let topPos, leftPos;

                    // --- Horizontal Position ---
                    if (viewportWidth < 768) { 
                        // Mobile: Center horizontally
                        leftPos = (viewportWidth - menuWidth) / 2;
                    } else {
                        // Desktop: To the right of the card
                        leftPos = cardRect.right + 10;
                        // Flip if not enough space on right
                        if (leftPos + menuWidth > viewportWidth) {
                            leftPos = cardRect.left - menuWidth - 10;
                        }
                    }

                    // --- Vertical Position ---
                    const spaceBelow = viewportHeight - cardRect.bottom;
                    const spaceAbove = cardRect.top;
                    
                    // Smart vertical positioning
                    if (spaceBelow >= menuHeight + 10) {
                        topPos = cardRect.bottom + 5;
                    } else if (spaceAbove >= menuHeight + 10) {
                        topPos = cardRect.top - menuHeight - 5;
                    } else {
                        // Pick side with more space
                        if (spaceBelow > spaceAbove) {
                            topPos = cardRect.bottom + 5;
                        } else {
                            topPos = cardRect.top - menuHeight - 5;
                            if (topPos < 80) topPos = 80; // Safety for header
                        }
                    }

                    // Apply positions
                    menu.style.top = `${topPos}px`;
                    menu.style.left = `${leftPos}px`;
                    menu.style.position = 'fixed';
                    menu.style.visibility = 'visible';
                };
                
                card.innerHTML = `
                    <div class="w-24 h-24 bg-zinc-900 rounded-xl overflow-hidden relative flex-shrink-0 flex items-center justify-center pointer-events-none">
                        ${acc.isSold ? '<div class="sold-badge">SOLD</div>' : ''}
                        ${acc.image ? `<img src="${acc.image}" class="w-full h-full object-cover ${acc.isSold?'grayscale opacity-30':''}">` : '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#2c2c2e" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>'}
                    </div>
                    <div class="flex-1 min-w-0 pointer-events-none">
                        <p class="text-[14px] font-bold truncate mb-1">${acc.dbEmail || acc.dbName || 'No Name'}</p>
                        <p class="text-[10px] text-zinc-500 font-bold uppercase mb-2">${acc.type}</p>
                        <div class="flex items-center gap-2">
                            <span class="text-[10px] px-2 py-1 rounded-full ${acc.isSold ? 'bg-red-500/20 text-red-400' : 'bg-green-500/20 text-green-400'}">
                                ${acc.isSold ? 'Terjual' : 'Tersedia'}
                            </span>
                            <span class="text-[9px] text-zinc-500">
                                ${new Date(acc.timestamp).toLocaleDateString('id-ID')}
                            </span>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        // PERUBAHAN: Action Handlers dengan close otomatis
        window.handleAction = async (type) => {
            const acc = accounts.find(a => a.id === activeId);
            document.getElementById('itemActionMenu').style.display = 'none';
            if(!acc) return;

            const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'stok', activeId);

            if(type === 'detail') {
                document.getElementById('modalTitle').innerText = "Detail Akun";
                
                let html = '';
                if (acc.image) {
                    html += `
                        <div class="flex justify-center mb-4">
                            <div class="w-40 h-40 bg-zinc-900 rounded-xl overflow-hidden relative">
                                <img src="${acc.image}" class="w-full h-full object-cover">
                                ${acc.isSold ? '<div class="sold-badge">SOLD</div>' : ''}
                            </div>
                        </div>
                    `;
                }
                
                html += '<div class="ios-input-group">';
                const fields = { 
                    'type': 'Jenis', 
                    'dbEmail': 'Email', 
                    'dbPassG': 'Password G', 
                    'dbPassM': 'Password M', 
                    'dbBackup': 'Kode Cadangan', 
                    'dbName': 'Nama/ID', 
                    'dbLoginVia': 'Login Via',
                    'dbKet': 'Keterangan'
                };
                
                for(let key in fields) {
                    if(acc[key]) {
                        html += `<div class="ios-input-row">
                                    <span class="row-label">${fields[key]}</span>
                                    <span class="text-sm font-medium break-all text-white/90">${acc[key]}</span>
                                 </div>`;
                    }
                }
                
                html += `<div class="ios-input-row">
                            <span class="row-label">Status</span>
                            <span class="text-sm font-medium ${acc.isSold ? 'text-red-400' : 'text-green-400'}">
                                ${acc.isSold ? 'Terjual' : 'Tersedia'}
                            </span>
                         </div>`;
                
                html += `<div class="ios-input-row">
                            <span class="row-label">Tanggal Input</span>
                            <span class="text-sm font-medium text-white/90">
                                ${new Date(acc.timestamp).toLocaleString('id-ID')}
                            </span>
                         </div>`;
                
                html += '</div>';
                
                document.getElementById('modalBody').innerHTML = html;
                document.getElementById('modalBtnAction').classList.add('hidden');
                document.getElementById('modalOverlay').classList.add('active');
                document.getElementById('iosDetailModal').classList.add('active');
            } 
            else if (type === 'edit') {
                openEditModal(acc);
            }
            else if (type === 'sold') {
                await updateDoc(docRef, { isSold: !acc.isSold });
                showIOSNotify("Status Diperbarui", "Status penjualan akun telah diubah.", false);
            } 
            else if (type === 'delete') {
                if(confirm("Hapus stok ini permanen dari Cloud?")) {
                    await deleteDoc(docRef);
                    showIOSNotify("Terhapus", "Data akun telah dihapus dari cloud.", false);
                }
            }
            else if (type === 'send_admin') {
                let text = `ðŸš€ <b>DETAIL AKUN (ADMIN)</b>\n`;
                text += `Jenis: ${acc.type}\n`;
                text += `Status: ${acc.isSold ? 'Terjual' : 'Tersedia'}\n`;
                text += `--------------------------------\n`;
                
                if (acc.dbEmail) text += `<b>Email:</b> <code>${acc.dbEmail}</code>\n`;
                if (acc.dbPassG) text += `<b>Pass G:</b> <code>${acc.dbPassG}</code>\n`;
                if (acc.dbPassM) text += `<b>Pass M:</b> <code>${acc.dbPassM}</code>\n`;
                if (acc.dbName) text += `<b>Nama/ID:</b> <code>${acc.dbName}</code>\n`;
                if (acc.dbLoginVia) text += `<b>Login Via:</b> <code>${acc.dbLoginVia}</code>\n`;
                if (acc.dbBackup) text += `<b>Backup:</b> <code>${acc.dbBackup}</code>\n`;
                if (acc.dbKet) text += `<b>Keterangan:</b> <code>${acc.dbKet}</code>\n`;
                
                text += `\n--------------------------------\n`;
                text += `ðŸ“… Tanggal Input: ${new Date(acc.timestamp).toLocaleDateString('id-ID')}`;
                
                await sendAccountToTelegram(TELEGRAM_CHAT_ID, text, acc.image);
            }
            else if (type === 'send_buyer') {
                document.getElementById('modalTitle').innerText = "Kirim ke Buyer";
                const body = document.getElementById('modalBody');
                body.innerHTML = `<div class="ios-input-group"><div class="ios-input-row"><span class="row-label">Username Buyer</span><input type="text" id="buyerUsername" placeholder="@username" required></div></div>`;
                const action = document.getElementById('modalBtnAction');
                action.innerText = "Kirim Data"; action.classList.remove('hidden');
                action.onclick = async () => {
                    const buyer = document.getElementById('buyerUsername').value;
                    if(!buyer) return;
                    
                    let text = `âœ¨ <b>DETAIL AKUN BY AHRASTORE</b>\n`;
                    text += `Buyer: ${buyer}\n`;
                    text += `Jenis: ${acc.type}\n`;
                    text += `--------------------------------\n`;
                    
                    if (acc.dbEmail) text += `<b>Email:</b> <code>${acc.dbEmail}</code>\n`;
                    if (acc.dbPassG) text += `<b>Pass G:</b> <code>${acc.dbPassG}</code>\n`;
                    if (acc.dbPassM) text += `<b>Pass M:</b> <code>${acc.dbPassM}</code>\n`;
                    if (acc.dbName) text += `<b>Nama/ID:</b> <code>${acc.dbName}</code>\n`;
                    if (acc.dbLoginVia) text += `<b>Login Via:</b> <code>${acc.dbLoginVia}</code>\n`;
                    if (acc.dbBackup) text += `<b>Backup:</b> <code>${acc.dbBackup}</code>\n`;
                    if (acc.dbKet) text += `<b>Keterangan:</b> <code>${acc.dbKet}</code>\n`;
                    
                    text += `\n--------------------------------\n`;
                    text += `ðŸ“¦ Stok lain nya cek di sini\n`;
                    text += `ðŸŒ https://t.me/StokAhraStore2\n`;
                    text += `\n`;
                    text += `ðŸ‘¥ Grub stok jual beli, taruh stok mu atau cari stok lain di sini\n`;
                    text += `ðŸŒ https://t.me/JBAKUNMLBYAHRASTORE\n`;
                    text += `\n`;
                    text += `ðŸ¤Ÿ Testimoni? cek\n`;
                    text += `ðŸŒ https://t.me/TESTIMONIAHRASTORE`;
                    
                    closeModals(); 
                    await sendAccountToTelegram(TELEGRAM_CHAT_ID, text, acc.image);
                };
                document.getElementById('modalOverlay').classList.add('active');
                document.getElementById('iosDetailModal').classList.add('active');
            }
            // Setelah action apapun, reset blur dan close popover
            closeAllPopovers();
        };

        // --- FUNGSI EDIT DATA ---
        function openEditModal(account) {
            document.getElementById('modalTitle').innerText = "Edit Data Akun";
            
            let html = `
                <form id="editForm" class="space-y-4">
                    <div class="ios-input-group">
                        <div class="ios-input-row">
                            <span class="row-label">Foto Akun (Opsional)</span>
                            <label for="editImage" class="flex justify-between items-center cursor-pointer py-1">
                                <span id="label-editImage" class="text-[15px] ${account.image ? 'text-white' : 'text-zinc-500'}">
                                    ${account.image ? 'Ganti foto...' : 'Unggah foto...'}
                                </span>
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-blue-500">
                                    <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
                                    <circle cx="12" cy="13" r="4"/>
                                </svg>
                                <input type="file" id="editImage" accept="image/*" class="hidden" onchange="handleEditImageSelect(this)">
                            </label>
                            ${account.image ? `
                            <div class="mt-2">
                                <p class="text-[10px] text-zinc-500 mb-1">Foto saat ini:</p>
                                <img src="${account.image}" class="w-20 h-20 object-cover rounded-lg border border-white/10">
                            </div>` : ''}
                        </div>
                        
                        <div class="ios-input-row">
                            <span class="row-label">Jenis Akun</span>
                            <div class="ios-select-trigger !p-0 !bg-transparent !border-none" onclick="openEditTypePicker()">
                                <span id="labelEditType" class="text-[15px] ${account.type ? 'text-white' : 'text-zinc-500'}">
                                    ${account.type || 'Pilih Jenis...'}
                                </span>
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#8e8e93" stroke-width="2.5">
                                    <path d="M6 9l6 6 6-6"/>
                                </svg>
                            </div>
                            <input type="hidden" id="editType" value="${account.type || ''}">
                        </div>
                        
                        <div id="editDynamicFields">
                            ${generateEditFields(account)}
                        </div>
                        
                        <div class="ios-input-row">
                            <span class="row-label">Status Sold</span>
                            <div class="flex items-center justify-between">
                                <span class="text-[15px]">${account.isSold ? 'Terjual' : 'Tersedia'}</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="editIsSold" ${account.isSold ? 'checked' : ''}>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                </form>
            `;
            
            document.getElementById('modalBody').innerHTML = html;
            document.getElementById('modalBtnAction').innerText = "Simpan Perubahan";
            document.getElementById('modalBtnAction').classList.remove('hidden');
            document.getElementById('modalBtnAction').onclick = () => saveEditChanges(account.id);
            
            document.getElementById('modalOverlay').classList.add('active');
            document.getElementById('iosDetailModal').classList.add('active');
        }

        function generateEditFields(account) {
            let html = '';
            const fields = [
                { id: 'editDbEmail', label: 'Email Akun', value: account.dbEmail || '' },
                { id: 'editDbPassG', label: 'Password Google', value: account.dbPassG || '' },
                { id: 'editDbPassM', label: 'Password Moonton', value: account.dbPassM || '' },
                { id: 'editDbBackup', label: 'Kode Cadangan', value: account.dbBackup || '' },
                { id: 'editDbName', label: 'Nama/ID', value: account.dbName || '' },
                { id: 'editDbLoginVia', label: 'Login Via', value: account.dbLoginVia || '' },
                { id: 'editDbKet', label: 'Keterangan', value: account.dbKet || '' }
            ];
            
            fields.forEach(field => {
                if (field.value || field.id === 'editDbEmail') {
                    html += `
                        <div class="ios-input-row">
                            <span class="row-label">${field.label}</span>
                            <input type="text" id="${field.id}" value="${field.value}" placeholder="${field.label}" class="text-white">
                        </div>
                    `;
                }
            });
            
            return html;
        }

        window.openEditTypePicker = () => {
            const types = ['Mail fresh', 'Mail own', 'Monkos', 'Galver'];
            openIOSPicker('PILIH JENIS AKUN', types, 'editType', false);
            
            document.querySelectorAll('#pickerOptionsContainer .picker-option').forEach(btn => {
                btn.addEventListener('click', function() {
                    setTimeout(() => {
                        const newType = document.getElementById('editType').value;
                        const account = accounts.find(a => a.id === activeId);
                        if (account && newType !== account.type) {
                            account.type = newType;
                            const container = document.getElementById('editDynamicFields');
                            container.innerHTML = generateEditFields(account);
                        }
                    }, 100);
                });
            });
        };

        async function saveEditChanges(docId) {
            const type = document.getElementById('editType').value;
            const isSold = document.getElementById('editIsSold')?.checked || false;
            
            if (!type) {
                showIOSNotify("Error", "Jenis akun harus diisi.");
                return;
            }
            
            const btn = document.getElementById('modalBtnAction');
            btn.disabled = true;
            btn.innerText = "Menyimpan...";
            
            try {
                const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'stok', docId);
                const updates = {
                    type: type,
                    isSold: isSold,
                    updatedAt: Date.now()
                };
                
                ['editDbEmail', 'editDbPassG', 'editDbPassM', 'editDbBackup', 'editDbName', 'editDbLoginVia', 'editDbKet'].forEach(fieldId => {
                    const element = document.getElementById(fieldId);
                    if (element) {
                        const value = element.value.trim();
                        const dbField = fieldId.replace('editDb', 'db');
                        if (value) {
                            updates[dbField] = value;
                        } else {
                            updates[dbField] = null;
                        }
                    }
                });
                
                const imageInput = document.getElementById('editImage');
                if (imageInput?.files[0]) {
                    // PERUBAHAN: Compress image on edit
                    updates.image = await compressImage(imageInput.files[0]);
                }
                
                await updateDoc(docRef, updates);
                
                showIOSNotify("Berhasil", "Data akun berhasil diperbarui.", false);
                closeModals();
                closeAllPopovers(); // Reset blur effect
                
            } catch (error) {
                console.error("Error updating document:", error);
                showIOSNotify("Gagal", "Terjadi kesalahan saat menyimpan perubahan.");
            } finally {
                btn.disabled = false;
                btn.innerText = "Simpan Perubahan";
            }
        }

        window.handleEditImageSelect = (input) => {
            const label = document.getElementById('label-editImage');
            if (input.files && input.files[0]) {
                label.innerText = input.files[0].name;
                label.style.color = "white";
            } else {
                label.innerText = "Unggah foto...";
                label.style.color = "#8e8e93";
            }
        };

        // --- PICKER UTILS ---
        window.openIOSDatePicker = () => {
            const container = document.getElementById('pickerOptionsContainer');
            document.getElementById('pickerTitle').innerText = "PILIH TANGGAL";
            container.innerHTML = "";
            const dates = [];
            for(let i=0; i<30; i++){
                const d = new Date(); d.setDate(d.getDate() - i);
                dates.push(d.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' }));
            }
            dates.forEach(date => {
                const btn = document.createElement('button'); btn.className = "picker-option"; btn.innerText = date;
                btn.onclick = () => {
                    document.getElementById('testiTanggal').value = date;
                    document.getElementById('labelTestiTanggal').innerText = date;
                    document.getElementById('labelTestiTanggal').style.color = "white";
                    closeModals();
                };
                container.appendChild(btn);
            });
            document.getElementById('modalOverlay').classList.add('active');
            document.getElementById('iosPickerSheet').classList.add('active');
        };

        window.openTestimoniPicker = () => {
            const levels = ["Junior", "Senior", "Ahli", "Ternama", "Terhormat", "Juragan", "Sultan"];
            const container = document.getElementById('pickerOptionsContainer');
            document.getElementById('pickerTitle').innerText = "PILIH TINGKATAN";
            container.innerHTML = "";
            levels.forEach(lvl => {
                const btn = document.createElement('button'); btn.className = "picker-option"; btn.innerText = lvl;
                btn.onclick = () => {
                    if(lvl === "Sultan") {
                        document.getElementById('testiAkun').value = lvl;
                        document.getElementById('labelTestiAkun').innerText = lvl;
                        document.getElementById('labelTestiAkun').style.color = "white";
                        closeModals();
                    } else { openLevelNumberPicker(lvl); }
                };
                container.appendChild(btn);
            });
            document.getElementById('modalOverlay').classList.add('active');
            document.getElementById('iosPickerSheet').classList.add('active');
        };

        function openLevelNumberPicker(lvlBase) {
            const container = document.getElementById('pickerOptionsContainer');
            document.getElementById('pickerTitle').innerText = `PILIH ANGKA ${lvlBase.toUpperCase()}`;
            container.innerHTML = "";
            [1, 2, 3, 4, 5].forEach(num => {
                const btn = document.createElement('button'); btn.className = "picker-option"; btn.innerText = num;
                btn.onclick = () => {
                    const finalValue = `${lvlBase} ${num}`;
                    document.getElementById('testiAkun').value = finalValue;
                    document.getElementById('labelTestiAkun').innerText = finalValue;
                    document.getElementById('labelTestiAkun').style.color = "white";
                    closeModals();
                };
                container.appendChild(btn);
            });
        }

        // --- FIX: FORM TESTIMONI ---
        document.getElementById('formTesti').onsubmit = async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            const tanggal = document.getElementById('testiTanggal').value;
            let harga = document.getElementById('testiHarga').value;
            const akun = document.getElementById('testiAkun').value;
            const testiImageInput = document.getElementById('testiImage');
            
            if(!tanggal || !harga || !akun) return showIOSNotify("Form Testimoni", "Mohon lengkapi semua data testimoni.");
            
            if (!testiImageInput.files || testiImageInput.files.length === 0) {
                return showIOSNotify("Foto Kosong", "Pilih foto bukti transaksi terlebih dahulu.");
            }

            const photo = testiImageInput.files[0];
            if (photo.size > 10 * 1024 * 1024) {
                return showIOSNotify("File Terlalu Besar", "Ukuran foto maksimal 10MB.");
            }
            
            // PERUBAHAN: Konversi format Rupiah ke angka
            harga = convertRupiahToNumber(harga);
            if (harga === 0) {
                return showIOSNotify("Harga Invalid", "Masukkan harga yang valid.");
            }
            
            btn.disabled = true; btn.innerText = "Memproses...";
            
            const text = `âœ¨ <b>TESTIMONI TRANSAKSI AHRASTORE</b>\n\nðŸ“… Tanggal : ${tanggal}\nâ„¹ï¸ Info : Akun ${akun}\nðŸ’¸ Harga : Rp ${harga.toLocaleString('id-ID')}\n\nðŸ“¦ Stok lain nya cek di sini\nðŸŒ https://t.me/StokAhraStore2\nðŸ¤Ÿ Testimoni? cek\nðŸŒ https://t.me/TESTIMONIAHRASTORE`;
            const formData = new FormData();
            formData.append('chat_id', TELEGRAM_CHAT_ID); 
            formData.append('parse_mode', 'HTML'); 
            formData.append('caption', text);
            formData.append('photo', photo);
            
            try {
                const response = await fetch(`${CF_TELEGRAM_PROXY_BASE}/sendPhoto`, { method: 'POST', body: formData });
                const resData = await response.json();
                
                if(resData.ok) {
                    showIOSNotify("Testimoni Terkirim", "Postingan telah berhasil dikirim ke channel.", false);
                    e.target.reset(); 
                    document.getElementById('labelTestiTanggal').innerText = "Pilih Tanggal..."; 
                    document.getElementById('labelTestiTanggal').style.color = "#8e8e93";
                    document.getElementById('labelTestiAkun').innerText = "Pilih Tingkatan...";
                    document.getElementById('labelTestiAkun').style.color = "#8e8e93";
                    document.getElementById('label-testiImage').innerText = "Pilih Foto...";
                    document.getElementById('label-testiImage').style.color = "#8e8e93";
                    // Reset harga input
                    const hargaInput = document.getElementById('testiHarga');
                    hargaInput.value = '';
                    hargaInput.style.color = 'white';
                } else {
                     throw new Error(resData.description || "Gagal mengirim ke Telegram");
                }
            } catch(e) { 
                console.error(e);
                showIOSNotify("Pengiriman Gagal", e.message || "Gagal mengirim data ke Telegram."); 
            }
            btn.disabled = false; btn.innerText = "POST TESTIMONI";
        };

        // --- FIX: FORM SAVE (INPUT DATA) - PERBAIKAN UPLOAD FOTO ---
        document.getElementById('formSave').onsubmit = async (e) => {
            e.preventDefault();
            console.log("Form Save submitted");
            
            const type = document.getElementById('saveType').value;
            if(!type) {
                showIOSNotify("Jenis Kosong", "Pilih jenis akun terlebih dahulu.");
                return;
            }
            
            const btn = document.getElementById('submitSaveBtn');
            btn.disabled = true; 
            btn.innerText = "Menyimpan...";
            
            try {
                const data = { 
                    type: type, 
                    timestamp: Date.now(), 
                    isSold: false 
                };
                
                ['dbEmail', 'dbPassG', 'dbPassM', 'dbBackup', 'dbName', 'dbKet', 'dbLoginVia', 'galverSubtype'].forEach(field => {
                    const el = document.getElementById(field);
                    if (el) {
                        const value = el.value.trim();
                        if (value) {
                            data[field] = value;
                        }
                    }
                });
                
                // PERUBAHAN: Handle image upload dengan KOMPRESI OTOMATIS
                const fileInput = document.getElementById('saveImage');
                if (fileInput.files && fileInput.files[0]) {
                    const file = fileInput.files[0];
                    
                    // Validasi tipe file
                    if (!file.type.match('image.*')) {
                        btn.disabled = false; btn.innerText = "INPUT DATA";
                        return showIOSNotify("Format Tidak Didukung", "Hanya file gambar yang diperbolehkan.");
                    }
                    
                    try {
                        // FIX UTAMA: Compress image menggunakan fungsi compressImage
                        // Ini memastikan file <= 1MB untuk Firestore
                        data.image = await compressImage(file, 800, 0.6); // Max width 800, quality 60%
                        console.log("Image compressed successfully");
                    } catch (error) {
                        console.error("Error reading file:", error);
                        showIOSNotify("Error", "Gagal membaca file gambar.");
                        btn.disabled = false; btn.innerText = "INPUT DATA";
                        return;
                    }
                }
                
                let isValid = true;
                let errorMsg = "";
                
                if (type === "Mail fresh" || type === "Mail own") {
                    if (!data.dbEmail) { isValid = false; errorMsg = "Email akun harus diisi"; }
                    if (!data.dbPassG) { isValid = false; errorMsg = "Password Google harus diisi"; }
                    if (!data.dbPassM) { isValid = false; errorMsg = "Password Moonton harus diisi"; }
                } else if (type === "Monkos") {
                    if (!data.dbEmail) { isValid = false; errorMsg = "Email akun harus diisi"; }
                    if (!data.dbPassG) { isValid = false; errorMsg = "Password Google harus diisi"; }
                    if (!data.dbLoginVia) { isValid = false; errorMsg = "Login Via harus dipilih"; }
                } else if (type === "Galver") {
                    const subtype = data.galverSubtype;
                    if (!subtype) { isValid = false; errorMsg = "Metode login harus dipilih"; }
                    else if (subtype === 'Login Email') {
                        if (!data.dbEmail) { isValid = false; errorMsg = "Email akun harus diisi"; }
                        if (!data.dbPassG) { isValid = false; errorMsg = "Password Google harus diisi"; }
                    } else if (subtype === 'Login Name') {
                        if (!data.dbName) { isValid = false; errorMsg = "Nama/ID harus diisi"; }
                        if (!data.dbPassM) { isValid = false; errorMsg = "Password Moonton harus diisi"; }
                    }
                }
                
                if (!isValid) {
                    btn.disabled = false; btn.innerText = "INPUT DATA";
                    showIOSNotify("Data Tidak Lengkap", errorMsg);
                    return;
                }
                
                // Simpan ke Firestore
                const docRef = await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'stok'), data);
                
                showIOSNotify("Data Tersimpan", "Akun berhasil diinput ke cloud database.", false);
                
                e.target.reset(); 
                document.getElementById('dynamicFields').innerHTML = ""; 
                document.getElementById('labelSaveType').innerText = "Pilih Jenis Akun..."; 
                document.getElementById('labelSaveType').style.color = "#8e8e93";
                document.getElementById('label-saveImage').innerText = "Pilih Foto...";
                document.getElementById('label-saveImage').style.color = "#8e8e93";
                
                switchTab('db');
                
            } catch(err) { 
                console.error("Save error:", err);
                let errorMessage = "Gagal menyimpan data ke Firestore.";
                // Cek error spesifik ukuran file (biasanya code: invalid-argument jika base64 terlalu panjang)
                if (err.code === 'invalid-argument') {
                    errorMessage = "Ukuran data terlalu besar. Coba foto lebih kecil.";
                } else if (err.code === 'permission-denied') {
                    errorMessage = "Izin ditolak. Pastikan aturan Firestore sudah benar.";
                } else if (err.code === 'unavailable') {
                    errorMessage = "Koneksi jaringan bermasalah. Coba lagi.";
                }
                showIOSNotify("Input Gagal", errorMessage); 
            } finally {
                btn.disabled = false; 
                btn.innerText = "INPUT DATA";
            }
        };

        // --- FIX: FORM STOK ---
        document.getElementById('formStok').onsubmit = async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button'); 
            btn.disabled = true; 
            btn.innerText = "Mengirim...";
            
            let harga = document.getElementById('stokHarga').value;
            const info = document.getElementById('stokInfo').value;
            const stokImageInput = document.getElementById('stokImage');
            
            if (!info) {
                btn.disabled = false; btn.innerText = "KIRIM KE CHANNEL";
                return showIOSNotify("Status Kosong", "Pilih status informasi akun.");
            }
            
            if (!stokImageInput.files || stokImageInput.files.length === 0) {
                btn.disabled = false; btn.innerText = "KIRIM KE CHANNEL";
                return showIOSNotify("Foto Kosong", "Pilih foto bukti terlebih dahulu.");
            }

            const photo = stokImageInput.files[0];
            if (photo.size > 10 * 1024 * 1024) {
                btn.disabled = false; btn.innerText = "KIRIM KE CHANNEL";
                return showIOSNotify("File Terlalu Besar", "Ukuran foto maksimal 10MB.");
            }
            
            // PERUBAHAN: Konversi format Rupiah ke angka
            harga = convertRupiahToNumber(harga);
            if (harga === 0) {
                btn.disabled = false; btn.innerText = "KIRIM KE CHANNEL";
                return showIOSNotify("Harga Invalid", "Masukkan harga yang valid.");
            }
            
            const text = `â€¼ï¸NEW ACCOUNT FROM AHRASTOREâ€¼ï¸\n\nðŸ’¸Price : Rp ${harga.toLocaleString('id-ID')}\nâ„¹ï¸Info Akun : ${info}\n\nðŸ›’Order? Chat Admin AHRASTORE\nðŸŒ https://t.me/zaaamyy\nðŸ“¦Stok lain nya cek di sini\nðŸŒ https://t.me/StokAhraStore2`;
            
            const formData = new FormData();
            formData.append('chat_id', TELEGRAM_CHAT_ID); 
            formData.append('parse_mode', 'HTML'); 
            formData.append('caption', text);
            formData.append('photo', photo);

            try {
                const response = await fetch(`${CF_TELEGRAM_PROXY_BASE}/sendPhoto`, { method: 'POST', body: formData });
                const resData = await response.json();
                
                if(resData.ok) {
                    showIOSNotify("Berhasil Dikirim", "Informasi stok akun terkirim ke channel.", false);
                    e.target.reset(); 
                    document.getElementById('label-stokImage').innerText = "Pilih Foto...";
                    document.getElementById('label-stokImage').style.color = "#8e8e93";
                    document.getElementById('labelStokInfo').innerText = "Pilih Status...";
                    document.getElementById('labelStokInfo').style.color = "#8e8e93";
                    // Reset harga input
                    const hargaInput = document.getElementById('stokHarga');
                    hargaInput.value = '';
                    hargaInput.style.color = 'white';
                } else {
                    throw new Error(resData.description || "Telegram API Error");
                }
            } catch (e) { 
                console.error(e);
                showIOSNotify("Gagal Kirim", e.message || "Terjadi masalah saat menghubungi Telegram."); 
            }
            btn.disabled = false; btn.innerText = "KIRIM KE CHANNEL";
        };

        // --- GLOBAL UI UTILS ---
        window.switchTab = (tab) => {
            ['stok', 'testi', 'save', 'db'].forEach(t => {
                const el = document.getElementById(`section-${t}`);
                const btn = document.getElementById(`tab-${t}`);
                if(el) el.classList.toggle('hidden', t !== tab);
                if(btn) btn.classList.toggle('tab-active', t === tab);
            });
            window.scrollTo(0,0);
            closeAllPopovers(); // Pastikan popover tertutup saat ganti tab
        };

        window.toggleAhraPopover = (id) => {
            const el = document.getElementById(id);
            el.style.display = el.style.display === 'flex' ? 'none' : 'flex';
        };

        // PERUBAHAN: Close popovers dan RESET BLUR
        window.closeAllPopovers = () => {
            document.querySelectorAll('.ios-popover').forEach(p => p.style.display = 'none');
            activeId = null;

            // Remove Blur Effects (Reset to normal state)
            const grid = document.getElementById('databaseGrid');
            if(grid) grid.classList.remove('has-active-card');

            const activeCard = document.querySelector('.db-card.active-card');
            if(activeCard) activeCard.classList.remove('active-card');
        };

        window.closeModals = () => {
            document.querySelectorAll('.overlay, .bottom-sheet, .centered-modal').forEach(m => {
                if(m.id !== 'setupUserDataModal') m.classList.remove('active');
            });
            setTimeout(() => { 
                const btn = document.getElementById('modalBtnAction');
                if(btn) btn.classList.add('hidden'); 
            }, 300);
            
            // Juga close action menu
            closeAllPopovers();
        };
        document.getElementById('modalOverlay').onclick = closeModals;

        window.openIOSPicker = (title, options, targetId, isDynamic = false) => {
            const container = document.getElementById('pickerOptionsContainer');
            document.getElementById('pickerTitle').innerText = title;
            container.innerHTML = "";
            options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = "picker-option"; btn.innerText = opt;
                btn.onclick = () => {
                    document.getElementById(targetId).value = opt;
                    const label = document.getElementById('label' + targetId.charAt(0).toUpperCase() + targetId.slice(1));
                    if(label) { label.innerText = opt; label.style.color = "white"; }
                    if (isDynamic && targetId === 'saveType') handleDynamicFields(opt);
                    if (isDynamic && targetId === 'galverSubtype') handleGalverFields(opt);
                    closeModals();
                };
                container.appendChild(btn);
            });
            document.getElementById('modalOverlay').classList.add('active');
            document.getElementById('iosPickerSheet').classList.add('active');
        };

        function handleDynamicFields(type) {
            const container = document.getElementById('dynamicFields');
            let html = '<div class="ios-input-group">';
            if (type === "Mail fresh" || type === "Mail own") {
                html += `<div class="ios-input-row"><span class="row-label">Email Akun</span><input type="text" id="dbEmail" placeholder="Email" required></div>
                         <div class="ios-input-row"><span class="row-label">Password G</span><input type="text" id="dbPassG" placeholder="Pass Google" required></div>
                         <div class="ios-input-row"><span class="row-label">Password M</span><input type="text" id="dbPassM" placeholder="Pass Moonton" required></div>`;
                if(type === "Mail own") html += `<div class="ios-input-row"><span class="row-label">Kode Cadangan</span><textarea id="dbBackup" placeholder="Backup Code"></textarea></div>`;
            } else if (type === "Monkos") {
                html += `<div class="ios-input-row"><span class="row-label">Email Akun</span><input type="text" id="dbEmail" placeholder="Email" required></div>
                         <div class="ios-input-row"><span class="row-label">Password Google</span><input type="text" id="dbPassG" placeholder="Pass Google" required></div>
                         <div class="ios-input-row"><span class="row-label">Kode Cadangan</span><textarea id="dbBackup" placeholder="Backup Code"></textarea></div>
                         <div class="ios-input-row">
                             <span class="row-label">Login Via</span>
                             <div class="ios-select-trigger !p-0 !bg-transparent !border-none" onclick="openIOSPicker('LOGIN VIA', ['TikTok', 'Facebook', 'Google'], 'dbLoginVia')">
                                 <span id="labelDbLoginVia" class="text-[15px] text-zinc-500">Pilih Login Via...</span>
                                 <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#8e8e93" stroke-width="2.5"><path d="M6 9l6 6 6-6"/></svg>
                             </div>
                             <input type="hidden" id="dbLoginVia" required>
                         </div>`;
            } else if (type === "Galver") {
                html += `<div class="ios-input-row">
                             <span class="row-label">Metode Login</span>
                             <div class="ios-select-trigger !p-0 !bg-transparent !border-none" onclick="openIOSPicker('METODE LOGIN', ['Login Email', 'Login Name'], 'galverSubtype', true)">
                                 <span id="labelGalverSubtype" class="text-[15px] text-zinc-500">Pilih Metode...</span>
                                 <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#8e8e93" stroke-width="2.5"><path d="M6 9l6 6 6-6"/></svg>
                             </div>
                             <input type="hidden" id="galverSubtype" required>
                         </div>
                         <div id="galverFields"></div>`;
            }
            html += '</div>';
            container.innerHTML = html;
        }

        function handleGalverFields(subtype) {
            const container = document.getElementById('galverFields');
            if(!container) return;
            let html = '';
            if (subtype === 'Login Email') {
                 html += `<div class="ios-input-row"><span class="row-label">Email Akun</span><input type="text" id="dbEmail" placeholder="Email" required></div>
                          <div class="ios-input-row"><span class="row-label">Password Google</span><input type="text" id="dbPassG" placeholder="Pass Google" required></div>
                          <div class="ios-input-row"><span class="row-label">Kode Cadangan</span><textarea id="dbBackup" placeholder="Backup Code"></textarea></div>`;
            } else if (subtype === 'Login Name') {
                 html += `<div class="ios-input-row"><span class="row-label">Nama/ID</span><input type="text" id="dbName" placeholder="Nama Akun" required></div>
                          <div class="ios-input-row"><span class="row-label">Password Moonton</span><input type="text" id="dbPassM" placeholder="Pass Moonton" required></div>`;
            }
            container.innerHTML = html;
        }

        async function sendAccountToTelegram(chatId, text, imageBase64) {
            const formData = new FormData();
            formData.append('chat_id', chatId); 
            formData.append('parse_mode', 'HTML');
            
            if (imageBase64) {
                try {
                    const arr = imageBase64.split(','), mime = arr[0].match(/:(.*?);/)[1], bstr = atob(arr[1]);
                    let n = bstr.length; const u8arr = new Uint8Array(n); 
                    while(n--){ u8arr[n] = bstr.charCodeAt(n); }
                    formData.append('photo', new Blob([u8arr], {type:mime}), 'img.png');
                    formData.append('caption', text);
                } catch (e) {
                    console.error("Error processing image:", e);
                    formData.append('text', text);
                }
            } else { 
                formData.append('text', text); 
            }
            
            try { 
                const endpoint = imageBase64 ? 'sendPhoto' : 'sendMessage';
                const response = await fetch(`${CF_TELEGRAM_PROXY_BASE}/${endpoint}`, { method: 'POST', body: formData }); 
                const resData = await response.json();
                if(resData.ok) {
                      showIOSNotify("Berhasil", "Data berhasil terkirim ke Telegram.", false); 
                } else {
                     throw new Error(resData.description || "Gagal mengirim ke Telegram");
                }
            } catch(e) { 
                console.error(e);
                showIOSNotify("Error", e.message || "Gagal mengirim pesan."); 
            }
        }

        // PERUBAHAN: Event listener untuk close popover saat klik di mana saja
        document.addEventListener('click', (e) => {
            // Jika klik bukan di dalam popover, bukan tombol settings, dan bukan card database
            if (!e.target.closest('.ios-popover') && 
                !e.target.closest('#settingsBtn') && 
                !e.target.closest('.db-card')) {
                closeAllPopovers();
            }
            
            // Jika klik di luar modal tetapi di dalam overlay, close modal
            if (e.target.id === 'modalOverlay') {
                closeModals();
            }
        });

        // PERUBAHAN UTAMA: Event listener untuk close popover saat scroll dengan capture phase
        // Ini memastikan menu tertutup dan blur hilang saat layar digulir
        window.addEventListener('scroll', () => {
            if (activeId !== null) {
                closeAllPopovers();
            }
        }, true);

        // Inisialisasi input harga dengan event listener
        document.addEventListener('DOMContentLoaded', function() {
            // Set inputmode numeric untuk input harga
            const hargaInputs = document.querySelectorAll('.price-input');
            hargaInputs.forEach(input => {
                input.setAttribute('inputmode', 'numeric');
                input.setAttribute('pattern', '[0-9.,]*');
                
                // Format saat kehilangan fokus
                input.addEventListener('blur', function() {
                    formatRupiahInput(this);
                });
                
                // Validasi saat input
                input.addEventListener('input', function() {
                    validateNumberInput(this);
                });
                
                // Clear format saat fokus
                input.addEventListener('focus', function() {
                    this.value = this.value.replace(/\./g, '');
                });
            });
            
            // Fix untuk eye icon di login
            const eyeToggle = document.getElementById('eyeToggleBtn');
            if (eyeToggle) {
                eyeToggle.addEventListener('click', toggleLoginPassword);
            }
            
            // Inisialisasi password toggle untuk settings
            const currentPasswordToggle = document.getElementById('currentPasswordToggle');
            if (currentPasswordToggle) {
                currentPasswordToggle.addEventListener('click', function() {
                    togglePasswordVisibility('currentPasswordDisplay', 'currentPasswordToggle');
                });
            }
        });
    
// =====================
// REVISI RESET PASSWORD (OTP TELEGRAM & PIN)
// =====================

// Helper: tampilkan error detail
function handleServerError(err, context) {
    console.error(context, err);
    const msg = err?.message || "Kesalahan tidak diketahui";
    showIOSNotify("Gagal", `${context}: ${msg}`);
}

// Helper: validasi format telegram
function normalizeTelegramID(input) {
    let v = input.trim();
    if (v.startsWith('@')) v = v.substring(1);
    return v;
}

// REVISI: OTP Telegram dengan error detail
window.checkTelegramAndSendOTP = async () => {
    const raw = document.getElementById('forgotTelegramID').value;
    const telegramID = normalizeTelegramID(raw);
    const btn = document.getElementById('sendTelegramOTPBtn');

    if (!telegramID) {
        return showIOSNotify("Input Salah", "ID Telegram wajib diisi.");
    }

    btn.disabled = true;
    btn.innerText = "Memproses...";

    try {
        if (!auth.currentUser) {
            await signInAnonymously(auth);
        }

        const q = query(collectionGroup(db, 'settings'), where('telegramID', '==', telegramID));
        const snap = await getDocs(q);

        if (snap.empty) {
            throw new Error("ID Telegram tidak terdaftar.");
        }

        const docSnap = snap.docs[0];
        verifiedUserUID = docSnap.ref.parent.parent.id;

        generatedOTP = Math.floor(100000 + Math.random() * 900000).toString();

        const payload = {
            chat_id: telegramID,
            text: `ðŸ” KODE OTP RESET PASSWORD\n\nKode OTP Anda: ${generatedOTP}\n\nBerlaku 5 menit.`
        };

        const tgResp = await fetch(`${CF_TELEGRAM_PROXY_BASE}/sendMessage`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });

        const tgJson = await tgResp.json();
        if (!tgJson.ok) {
            throw new Error(tgJson.description || "Telegram API error");
        }

        document.getElementById('otpInputContainer').classList.remove('hidden');
        btn.innerText = "Verifikasi OTP";
        btn.disabled = false;
        btn.onclick = verifyTelegramOTP;

        showIOSNotify("OTP Terkirim", "Silakan cek Telegram Anda.");
    } catch (e) {
        btn.disabled = false;
        btn.innerText = "Kirim OTP";
        handleServerError(e, "OTP Telegram");
    }
};

// REVISI: verifikasi OTP
window.verifyTelegramOTP = async () => {
    const input = document.getElementById('forgotTelegramOTP').value.trim();
    if (!input) return showIOSNotify("OTP Kosong", "Masukkan kode OTP.");

    if (input !== generatedOTP) {
        return showIOSNotify("OTP Salah", "Kode OTP tidak cocok.");
    }

    openNewPasswordModal();
};

// REVISI: verifikasi PIN cadangan dengan error detail
window.verifyBackupPin = async () => {
    const email = document.getElementById('forgotPinEmail').value.trim();
    const pin = document.getElementById('forgotPinCode').value.trim();

    if (!email || !pin) {
        return showIOSNotify("Input Salah", "Email dan PIN wajib diisi.");
    }
    if (pin.length !== 6) {
        return showIOSNotify("PIN Tidak Valid", "PIN harus 6 digit.");
    }

    try {
        if (!auth.currentUser) {
            await signInAnonymously(auth);
        }

        const q = query(collection(db, 'users'), where('email', '==', email));
        const snap = await getDocs(q);
        if (snap.empty) {
            throw new Error("Email tidak ditemukan.");
        }

        const userDoc = snap.docs[0];
        const data = userDoc.data();

        if (!data.backupPIN) {
            throw new Error("PIN cadangan belum diatur.");
        }

        if (data.backupPIN !== pin) {
            throw new Error("PIN cadangan salah.");
        }

        verifiedUserUID = userDoc.id;
        openNewPasswordModal();
    } catch (e) {
        handleServerError(e, "Verifikasi PIN");
    }
};

function openNewPasswordModal() {
    closeModals();
    document.getElementById('modalOverlay').classList.add('active');
    document.getElementById('newPasswordModal').classList.add('active');
}

</script>
</body>
</html>
