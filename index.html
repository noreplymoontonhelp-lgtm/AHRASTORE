<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AhraStore Pro - Cloud Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        
        :root {
            --bg-dark: #000000;
            --card-bg: #1c1c1e;
            --card-secondary: #2c2c2e;
            --accent-blue: #0a84ff;
            --text-main: #ffffff;
            --text-secondary: #8e8e93;
            --ios-blur: rgba(28, 28, 30, 0.85);
            color-scheme: dark;
        }

        html, body {
            height: 100%;
            margin: 0;
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            overflow-x: hidden;
            -webkit-text-size-adjust: 100%;
            user-select: none;
        }

        .app-container {
            width: 100%;
            max-width: 450px;
            margin: 0 auto;
            min-height: 100dvh;
            display: flex;
            flex-direction: column;
            background-color: var(--bg-dark);
            position: relative;
        }

        /* Loading Screen */
        #loadingScreen {
            position: fixed;
            inset: 0;
            background: var(--bg-dark);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .ios-loader {
            width: 35px;
            height: 35px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top: 3px solid var(--accent-blue);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Login Screen */
        #loginScreen {
            position: fixed; inset: 0; background: black; z-index: 9000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 40px; text-align: center;
        }
        .login-logo {
            width: 80px; height: 80px; background: var(--accent-blue);
            border-radius: 22px; margin-bottom: 24px;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 10px 30px rgba(10, 132, 255, 0.3);
        }

        .shizuku-card {
            background-color: var(--card-bg);
            border-radius: 14px;
            padding: 16px;
            margin-bottom: 16px;
            border: 0.5px solid rgba(255, 255, 255, 0.05);
        }

        .ios-input-group {
            background-color: var(--card-secondary);
            border-radius: 12px;
            overflow: hidden;
            border: 0.5px solid rgba(255, 255, 255, 0.05);
        }

        .ios-input-row {
            display: flex;
            flex-direction: column;
            padding: 10px 16px;
            border-bottom: 0.5px solid rgba(255, 255, 255, 0.05);
        }
        .ios-input-row:last-child { border-bottom: none; }

        .row-label {
            font-size: 10px;
            font-weight: 800;
            color: var(--accent-blue);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 2px;
        }

        .pill-button {
            background-color: var(--accent-blue);
            color: white;
            border-radius: 12px;
            padding: 14px 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 15px;
            transition: all 0.2s;
            border: none;
            width: 100%;
            cursor: pointer;
        }
        .pill-button:active { transform: scale(0.96); opacity: 0.8; }

        .tab-btn {
            position: relative;
            padding: 12px 0;
            font-size: 11px;
            font-weight: 700;
            color: var(--text-secondary);
            transition: color 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .tab-btn.tab-active { color: var(--accent-blue); }
        .tab-btn.tab-active::after {
            content: '';
            position: absolute;
            bottom: 0; left: 25%; width: 50%; height: 3px;
            background-color: var(--accent-blue);
            border-radius: 3px 3px 0 0;
        }

        .ios-select-trigger {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            padding: 14px 16px;
            background-color: var(--card-secondary);
            border-radius: 12px;
            color: var(--text-main);
            font-size: 15px;
            cursor: pointer;
            transition: background 0.2s;
            border: 0.5px solid rgba(255, 255, 255, 0.05);
        }

        input, textarea {
            background: transparent !important;
            border: none !important;
            color: white !important;
            padding: 0 !important;
            font-size: 15px !important;
            width: 100%;
            outline: none;
        }
        input::placeholder { color: var(--text-secondary); }

        .ios-popover {
            position: absolute;
            background: var(--ios-blur);
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border-radius: 14px;
            z-index: 100;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            display: none;
            flex-direction: column;
            overflow: hidden;
            border: 0.5px solid rgba(255, 255, 255, 0.1);
            transform-origin: top right;
            animation: popIn 0.2s cubic-bezier(0.4, 0, 0.2, 1) forwards;
            width: 220px;
        }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .popover-item {
            padding: 14px 16px;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 0.5px solid rgba(255, 255, 255, 0.1);
            color: white;
            text-align: left;
            background: transparent;
        }
        .popover-item:last-child { border-bottom: none; }
        .popover-item:active { background: rgba(255,255,255,0.15); }

        .overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
            z-index: 8000;
            display: none;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .overlay.active { display: block; opacity: 1; }

        .bottom-sheet {
            position: fixed;
            bottom: 12px; left: 12px; right: 12px;
            background: var(--ios-blur);
            backdrop-filter: blur(30px) saturate(180%);
            border-radius: 20px;
            z-index: 8500;
            transform: translateY(120%);
            transition: transform 0.4s cubic-bezier(0.1, 0.7, 0.1, 1);
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0,0,0,0.6);
        }
        .bottom-sheet.active { transform: translateY(0); }

        .centered-modal {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            width: 90%; max-width: 360px;
            background: var(--ios-blur);
            backdrop-filter: blur(40px);
            border-radius: 24px;
            z-index: 9000;
            display: none;
            flex-direction: column;
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 0.5px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 20px 60px rgba(0,0,0,0.7);
        }
        .centered-modal.active { display: flex; opacity: 1; transform: translate(-50%, -50%) scale(1); }

        .picker-option {
            padding: 16px; text-align: center; font-size: 17px;
            color: var(--accent-blue); background: transparent;
            width: 100%; border-bottom: 0.5px solid rgba(255, 255, 255, 0.1);
        }
        .picker-option:active { background: rgba(255, 255, 255, 0.1); }

        .db-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 14px; }
        .db-card {
            background: var(--card-bg); border-radius: 16px; padding: 12px;
            border: 0.5px solid rgba(255, 255, 255, 0.05);
            position: relative; cursor: pointer;
        }

        .sold-badge {
            background: #ff3b30; color: white; font-size: 10px;
            padding: 2px 8px; border-radius: 6px; font-weight: 800;
            position: absolute; top: 10px; right: 10px;
            box-shadow: 0 2px 10px rgba(255, 59, 48, 0.3); z-index: 5;
        }
    </style>
</head>
<body>

    <!-- Loading Screen -->
    <div id="loadingScreen">
        <div class="ios-loader"></div>
        <p class="mt-6 text-[10px] font-bold text-[#8e8e93] tracking-[0.2em] uppercase">AhraStore</p>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="hidden">
        <div class="login-logo">
            <svg width="40" height="40" viewBox="0 0 24 24" fill="white"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 14H9V9h2v7zm4 0h-2V9h2v7z"/></svg>
        </div>
        <h2 class="text-3xl font-bold tracking-tight mb-2">Selamat Datang Di AHRASTORE.apk</h2>
        <p class="text-[14px] text-zinc-500 mb-10">Silahkan Login Untuk Lanjut</p>
        
        <div class="w-full max-w-xs space-y-4">
            <div class="ios-input-group">
                <div class="ios-input-row">
                    <span class="row-label">Email</span>
                    <input type="email" id="loginEmail" placeholder="email@contoh.com">
                </div>
                <div class="ios-input-row">
                    <span class="row-label">Password</span>
                    <input type="password" id="loginPass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                </div>
            </div>
            <button onclick="handleEmailAuth('login')" class="pill-button">MASUK</button>
            <button onclick="handleEmailAuth('signup')" class="pill-button !bg-zinc-800 !text-blue-500">DAFTAR BARU</button>
            
            <div class="flex items-center gap-4 py-2">
                <div class="h-[1px] bg-zinc-800 flex-1"></div>
                <span class="text-[9px] text-zinc-500 font-bold uppercase">Atau</span>
                <div class="h-[1px] bg-zinc-800 flex-1"></div>
            </div>

            <button onclick="handleGoogleAuth()" class="pill-button !bg-white !text-black">
                <svg width="18" height="18" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
                Google
            </button>
        </div>
    </div>

    <!-- App Container -->
    <div id="app" class="app-container" style="display:none;">
        <header class="px-6 py-4 flex justify-between items-end bg-black/80 backdrop-blur-xl sticky top-0 z-40 border-b border-white/5">
            <div>
                <h1 class="text-2xl font-bold text-white tracking-tight">Halo User</h1>
                <div class="flex items-center gap-1.5 mt-0.5">
                    <div class="w-2 h-2 rounded-full bg-green-500 transition-colors duration-300"></div>
                    <span id="userLabel" class="text-[10px] font-bold text-zinc-500 uppercase tracking-wider">Sync Active</span>
                </div>
            </div>
            <button id="settingsBtn" onclick="toggleAhraPopover('settingsOverlay', this)" class="p-2 text-blue-500 transition-all duration-300">
                <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0a2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
            </button>

            <div id="settingsOverlay" class="ios-popover" style="top: 75px; right: 20px;">
                <button onclick="exportJSON(); closeAllPopovers();" class="popover-item">
                    <span>Export Data (.json)</span>
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                </button>
                <button onclick="handleLogout()" class="popover-item !text-red-500 font-bold">
                    <span>Logout Akun</span>
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                </button>
            </div>
        </header>

        <nav class="flex px-4 bg-black/80 backdrop-blur-xl border-b border-white/5 sticky top-[75px] z-30">
            <button onclick="switchTab('stok')" id="tab-stok" class="tab-btn flex-1 tab-active">Stok</button>
            <button onclick="switchTab('testi')" id="tab-testi" class="tab-btn flex-1">Testi</button>
            <button onclick="switchTab('save')" id="tab-save" class="tab-btn flex-1">Simpan</button>
            <button onclick="switchTab('db')" id="tab-db" class="tab-btn flex-1">Data akun</button>
        </nav>

        <main id="mainContent" class="p-5 flex-grow pb-28">
            <!-- Section Stok (Fast Post) -->
            <section id="section-stok">
                <div class="shizuku-card">
                    <h2 class="text-[12px] font-bold mb-5 text-zinc-500 uppercase tracking-widest">Telegram Post</h2>
                    <form id="formStok" class="space-y-4">
                        <div class="ios-input-group">
                            <div class="ios-input-row">
                                <span class="row-label">Bukti Foto</span>
                                <label for="stokImage" class="flex justify-between items-center cursor-pointer py-1">
                                    <span id="label-stokImage" class="text-[15px] text-zinc-500">Pilih Foto...</span>
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-blue-500"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
                                    <input type="file" id="stokImage" accept="image/*" required class="hidden" onchange="handleFileSelect(this, 'label-stokImage')">
                                </label>
                            </div>
                            <div class="ios-input-row"><span class="row-label">Harga</span><input type="text" id="stokHarga" placeholder="Contoh: 50k" required></div>
                        </div>
                        <div class="ios-select-trigger" id="triggerStokInfo" onclick="openIOSPicker('STATUS INFORMASI', ['Mail fresh', 'Free change email'], 'stokInfo')">
                            <span id="labelStokInfo">Pilih Status...</span>
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#8e8e93" stroke-width="2.5"><path d="M6 9l6 6 6-6"/></svg>
                        </div>
                        <input type="hidden" id="stokInfo">
                        <button type="submit" class="pill-button mt-2">KIRIM KE CHANNEL</button>
                    </form>
                </div>
            </section>

            <!-- Section Testi -->
            <section id="section-testi" class="hidden">
                <div class="shizuku-card">
                    <h2 class="text-[12px] font-bold mb-5 text-zinc-500 uppercase tracking-widest">Testimoni Post</h2>
                    <form id="formTesti" class="space-y-4">
                        <div class="ios-input-group">
                            <div class="ios-input-row">
                                <span class="row-label">Bukti Transaksi</span>
                                <label for="testiImage" class="flex justify-between items-center cursor-pointer py-1">
                                    <span id="label-testiImage" class="text-[15px] text-zinc-500">Pilih Foto...</span>
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-blue-500"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
                                    <input type="file" id="testiImage" accept="image/*" required class="hidden" onchange="handleFileSelect(this, 'label-testiImage')">
                                </label>
                            </div>
                            <div class="ios-input-row" onclick="openIOSDatePicker()">
                                <span class="row-label">Tanggal</span>
                                <div class="flex justify-between items-center cursor-pointer">
                                    <span id="labelTestiTanggal" class="text-[15px] text-zinc-500">Pilih Tanggal...</span>
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#8e8e93" stroke-width="2.5"><path d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                                </div>
                                <input type="hidden" id="testiTanggal" required>
                            </div>
                            <div class="ios-input-row"><span class="row-label">Harga</span><input type="text" id="testiHarga" placeholder="Harga Transaksi" required></div>
                        </div>
                        <div class="ios-select-trigger" id="triggerTestiAkun" onclick="openTestimoniPicker()">
                            <span id="labelTestiAkun">Pilih Tingkatan...</span>
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#8e8e93" stroke-width="2.5"><path d="M6 9l6 6 6-6"/></svg>
                        </div>
                        <input type="hidden" id="testiAkun">
                        <button type="submit" class="pill-button !bg-green-500">POST TESTIMONI</button>
                    </form>
                </div>
            </section>

            <!-- Section Simpan ke DB -->
            <section id="section-save" class="hidden">
                <div class="shizuku-card">
                    <h2 id="saveFormTitle" class="text-[12px] font-bold mb-5 text-zinc-500 uppercase tracking-widest">Database Input</h2>
                    <form id="formSave" class="space-y-4">
                        <div class="ios-input-group">
                            <div class="ios-input-row">
                                <span class="row-label">Foto Akun</span>
                                <label for="saveImage" class="flex justify-between items-center cursor-pointer py-1">
                                    <span id="label-saveImage" class="text-[15px] text-zinc-500">Pilih Foto...</span>
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-blue-500"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
                                    <input type="file" id="saveImage" accept="image/*" class="hidden" onchange="handleFileSelect(this, 'label-saveImage')">
                                </label>
                            </div>
                        </div>
                        <div class="ios-select-trigger" id="triggerSaveType" onclick="openIOSPicker('JENIS AKUN', ['Mail fresh', 'Mail own', 'Monkos', 'Galver'], 'saveType', true)">
                            <span id="labelSaveType">Pilih Jenis Akun...</span>
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#8e8e93" stroke-width="2.5"><path d="M6 9l6 6 6-6"/></svg>
                        </div>
                        <input type="hidden" id="saveType">
                        <div id="dynamicFields" class="space-y-4"></div>
                        <button type="submit" class="pill-button mt-4 !bg-blue-600">SIMPAN KE CLOUD</button>
                    </form>
                </div>
            </section>

            <!-- Section Katalog DB -->
            <section id="section-db" class="hidden">
                <div class="flex justify-between items-center mb-5 px-1">
                    <h2 class="text-[12px] font-bold text-zinc-500 uppercase tracking-widest">Katalog Cloud</h2>
                    <span id="dbCount" class="text-[10px] bg-blue-500/20 text-blue-400 px-3 py-1 rounded-full font-extrabold">0 Item</span>
                </div>
                <div id="databaseGrid" class="db-grid"></div>
            </section>

            <div id="statusMsg" class="mt-6 p-4 rounded-xl hidden text-center text-[13px] font-semibold transition-all shadow-xl"></div>
        </main>
    </div>

    <!-- Modals -->
    <div id="modalOverlay" class="overlay"></div>
    
    <div id="iosPickerSheet" class="bottom-sheet">
        <div class="picker-header p-4 border-b border-white/5"><h3 id="pickerTitle" class="text-[13px] font-bold text-zinc-500 uppercase text-center">Judul</h3></div>
        <div id="pickerOptionsContainer" class="flex flex-col max-h-[60vh] overflow-y-auto"></div>
        <div class="px-4 pb-4"><button onclick="closeModals()" class="mt-2 w-full p-4 bg-zinc-800/80 rounded-2xl text-blue-500 font-bold">Batal</button></div>
    </div>

    <div id="iosDetailModal" class="centered-modal">
        <div class="p-6">
            <h3 id="modalTitle" class="text-lg font-bold mb-2 text-center">Judul Modal</h3>
            <div id="modalBody" class="space-y-4 max-h-[50vh] overflow-y-auto"></div>
        </div>
        <div class="flex border-t border-white/10">
            <button id="modalBtnCancel" onclick="closeModals()" class="flex-1 p-4 text-blue-500 font-medium border-r border-white/10">Tutup</button>
            <button id="modalBtnAction" class="flex-1 p-4 text-blue-500 font-bold hidden">Simpan</button>
        </div>
    </div>

    <div id="itemActionMenu" class="ios-popover" style="width: 200px;">
        <button onclick="handleAction('detail')" class="popover-item"><span>Detail Akun</span><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg></button>
        <button onclick="handleAction('edit')" class="popover-item"><span>Edit Data</span><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button>
        <button onclick="handleAction('sold')" class="popover-item"><span>Status Sold</span><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/></svg></button>
        <button onclick="handleAction('send_admin')" class="popover-item"><span>Kirim ke Admin</span><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 2 15 22 11 13 2 9 22 2"/></svg></button>
        <button onclick="handleAction('send_buyer')" class="popover-item"><span>Kirim ke Buyer</span><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/></svg></button>
        <button onclick="handleAction('delete')" class="popover-item !text-red-500"><span>Hapus</span><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/></svg></button>
    </div>

    <!-- Firebase SDK Modules -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, 
            GoogleAuthProvider, signInWithPopup, signOut 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, collection, addDoc, doc, onSnapshot, deleteDoc, updateDoc, query, orderBy 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- KONFIGURASI FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyBVk932P_IbgAh6hoZ9HhnPNzdYsthIl04",
            authDomain: "ahrastore-14913.firebaseapp.com",
            projectId: "ahrastore-14913",
            storageBucket: "ahrastore-14913.appspot.com",
            messagingSenderId: "751112680601",
            appId: "1:751112680601:web:efd16728078d392d67f408",
            measurementId: "G-JLFVMMRH8M"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'ahra-store-pro';

        let user = null;
        let accounts = [];
        let activeId = null;

        // --- AUTH OBSERVER ---
        onAuthStateChanged(auth, (u) => {
            user = u;
            const loader = document.getElementById('loadingScreen');
            const login = document.getElementById('loginScreen');
            const appEl = document.getElementById('app');

            if (u) {
                login.style.display = 'none';
                appEl.style.display = 'flex';
                appEl.classList.remove('hidden');
                document.getElementById('userLabel').innerText = u.email || "User Pro";
                initDatabase();
            } else {
                appEl.style.display = 'none';
                login.style.display = 'flex';
            }

            if (loader) {
                loader.style.opacity = '0';
                setTimeout(() => loader.style.display = 'none', 500);
            }
        });

        // --- AUTH ACTIONS ---
        window.handleEmailAuth = async (type) => {
            const e = document.getElementById('loginEmail').value;
            const p = document.getElementById('loginPass').value;
            if(!e || !p) return showStatus("Isi data lengkap", true);
            
            try {
                if(type === 'login') {
                    await signInWithEmailAndPassword(auth, e, p);
                } else {
                    await createUserWithEmailAndPassword(auth, e, p);
                    showStatus("Berhasil daftar!");
                }
            } catch(err) { 
                console.error(err);
                showStatus("Gagal: " + err.message, true); 
            }
        };

        window.handleGoogleAuth = async () => {
            try { 
                const provider = new GoogleAuthProvider();
                await signInWithPopup(auth, provider); 
            } catch(e) { 
                console.error(e);
                showStatus("Google Login Gagal", true); 
            }
        };

        window.handleLogout = () => { 
            if(confirm("Keluar dari aplikasi?")) signOut(auth); 
        };

        // --- FIRESTORE DATABASE LOGIC ---
        function initDatabase() {
            if(!user) return;
            const q = query(
                collection(db, 'artifacts', appId, 'users', user.uid, 'stok'),
                orderBy('timestamp', 'desc')
            );
            
            onSnapshot(q, (snap) => {
                accounts = [];
                snap.forEach(d => accounts.push({id: d.id, ...d.data()}));
                renderDatabase();
            }, (error) => {
                console.error(error);
                showStatus("Error sinkronisasi database", true);
            });
        }

        function renderDatabase() {
            const grid = document.getElementById('databaseGrid');
            grid.innerHTML = "";
            document.getElementById('dbCount').innerText = `${accounts.length} Item`;
            
            accounts.forEach(acc => {
                const card = document.createElement('div');
                card.className = "db-card";
                card.onclick = (e) => {
                    activeId = acc.id;
                    const menu = document.getElementById('itemActionMenu');
                    const rect = card.getBoundingClientRect();
                    const containerRect = document.querySelector('.app-container').getBoundingClientRect();
                    let topPos = rect.top - containerRect.top + 40;
                    let leftPos = rect.left - containerRect.left + 20;
                    if(leftPos + 200 > containerRect.width) leftPos = containerRect.width - 220;
                    
                    menu.style.top = `${topPos}px`;
                    menu.style.left = `${leftPos}px`;
                    menu.style.display = 'flex';
                    e.stopPropagation();
                };
                card.innerHTML = `
                    <div class="h-32 bg-zinc-900 rounded-xl mb-3 overflow-hidden relative flex items-center justify-center">
                        ${acc.isSold ? '<div class="sold-badge">SOLD</div>' : ''}
                        ${acc.image ? `<img src="${acc.image}" class="w-full h-full object-cover ${acc.isSold?'grayscale opacity-30':''}">` : '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#2c2c2e" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>'}
                    </div>
                    <p class="text-[13px] font-bold truncate px-1">${acc.dbEmail || acc.dbName || 'No Name'}</p>
                    <p class="text-[9px] text-zinc-500 font-bold uppercase mt-0.5 px-1">${acc.type}</p>
                `;
                grid.appendChild(card);
            });
        }

        // Action Handlers
        window.handleAction = async (type) => {
            const acc = accounts.find(a => a.id === activeId);
            document.getElementById('itemActionMenu').style.display = 'none';
            if(!acc) return;

            const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'stok', activeId);

            if(type === 'detail') {
                document.getElementById('modalTitle').innerText = "Detail Akun";
                let html = '<div class="ios-input-group">';
                const fields = { 'type': 'Jenis', 'dbEmail': 'Email', 'dbPassG': 'Password Google', 'dbPassM': 'Password Moonton', 'dbBackup': 'Kode Cadangan', 'dbName': 'Nama/ID', 'dbLoginVia': 'Login Via' };
                for(let key in fields) {
                    if(acc[key]) html += `<div class="ios-input-row"><span class="row-label">${fields[key]}</span><span class="text-sm font-medium break-all text-white/90">${acc[key]}</span></div>`;
                }
                html += '</div>';
                document.getElementById('modalBody').innerHTML = html;
                document.getElementById('modalBtnAction').classList.add('hidden');
                document.getElementById('modalOverlay').classList.add('active');
                document.getElementById('iosDetailModal').classList.add('active');
            } 
            else if (type === 'sold') {
                await updateDoc(docRef, { isSold: !acc.isSold });
                showStatus("Status diupdate");
            } 
            else if (type === 'delete') {
                if(confirm("Hapus stok ini permanen dari Cloud?")) await deleteDoc(docRef);
            }
            else if (type === 'send_admin') {
                 let text = `ðŸš€ <b>DETAIL AKUN (ADMIN)</b>\nJenis: ${acc.type}\n--------------------------------\n`;
                 ['dbEmail', 'dbPassG', 'dbPassM', 'dbLoginVia', 'dbName'].forEach(k => { if(acc[k]) text += `<b>${k.replace('db','')} :</b> <code>${acc[k]}</code>\n`; });
                 await sendAccountToTelegram('7423591679', text, acc.image);
            }
            else if (type === 'send_buyer') {
                document.getElementById('modalTitle').innerText = "Kirim ke Buyer";
                const body = document.getElementById('modalBody');
                body.innerHTML = `<div class="ios-input-group"><div class="ios-input-row"><span class="row-label">Username Buyer</span><input type="text" id="buyerUsername" placeholder="@username" required></div></div>`;
                const action = document.getElementById('modalBtnAction');
                action.innerText = "Kirim Data"; action.classList.remove('hidden');
                action.onclick = async () => {
                    const buyer = document.getElementById('buyerUsername').value;
                    if(!buyer) return;
                    let text = `âœ¨ <b>DETAIL AKUN BY AHRASTORE</b>\nBuyer: ${buyer}\n--------------------------------\n`;
                    ['dbEmail', 'dbPassG', 'dbPassM', 'dbLoginVia', 'dbName', 'dbBackup'].forEach(k => { if(acc[k]) text += `<b>${k.replace('db','')} :</b> <code>${acc[k]}</code>\n`; });
                    text += `\n--------------------------------\nStok: @StokAhraStore2`;
                    closeModals(); await sendAccountToTelegram('7423591679', text, acc.image);
                };
                document.getElementById('modalOverlay').classList.add('active');
                document.getElementById('iosDetailModal').classList.add('active');
            }
        };

        // --- TESTIMONI SPECIFIC PICKERS ---
        window.openIOSDatePicker = () => {
            const container = document.getElementById('pickerOptionsContainer');
            document.getElementById('pickerTitle').innerText = "PILIH TANGGAL";
            container.innerHTML = "";
            
            const dates = [];
            for(let i=0; i<30; i++){
                const d = new Date();
                d.setDate(d.getDate() - i);
                dates.push(d.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' }));
            }

            dates.forEach(date => {
                const btn = document.createElement('button');
                btn.className = "picker-option";
                btn.innerText = date;
                btn.onclick = () => {
                    document.getElementById('testiTanggal').value = date;
                    document.getElementById('labelTestiTanggal').innerText = date;
                    document.getElementById('labelTestiTanggal').style.color = "white";
                    closeModals();
                };
                container.appendChild(btn);
            });
            document.getElementById('modalOverlay').classList.add('active');
            document.getElementById('iosPickerSheet').classList.add('active');
        };

        window.openTestimoniPicker = () => {
            const levels = ["Junior", "Senior", "Ahli", "Ternama", "Terhormat", "Juragan", "Sultan"];
            const container = document.getElementById('pickerOptionsContainer');
            document.getElementById('pickerTitle').innerText = "PILIH TINGKATAN";
            container.innerHTML = "";

            levels.forEach(lvl => {
                const btn = document.createElement('button');
                btn.className = "picker-option";
                btn.innerText = lvl;
                btn.onclick = () => {
                    if(lvl === "Sultan") {
                        document.getElementById('testiAkun').value = lvl;
                        document.getElementById('labelTestiAkun').innerText = lvl;
                        document.getElementById('labelTestiAkun').style.color = "white";
                        closeModals();
                    } else {
                        // Jalankan step 2 (Pilih Angka)
                        openLevelNumberPicker(lvl);
                    }
                };
                container.appendChild(btn);
            });
            document.getElementById('modalOverlay').classList.add('active');
            document.getElementById('iosPickerSheet').classList.add('active');
        };

        function openLevelNumberPicker(lvlBase) {
            const container = document.getElementById('pickerOptionsContainer');
            document.getElementById('pickerTitle').innerText = `PILIH ANGKA ${lvlBase.toUpperCase()}`;
            container.innerHTML = "";

            [1, 2, 3, 4, 5].forEach(num => {
                const btn = document.createElement('button');
                btn.className = "picker-option";
                btn.innerText = num;
                btn.onclick = () => {
                    const finalValue = `${lvlBase} ${num}`;
                    document.getElementById('testiAkun').value = finalValue;
                    document.getElementById('labelTestiAkun').innerText = finalValue;
                    document.getElementById('labelTestiAkun').style.color = "white";
                    closeModals();
                };
                container.appendChild(btn);
            });
        }

        // --- FILE UI UTILS ---
        window.handleFileSelect = (input, labelId) => {
            const label = document.getElementById(labelId);
            if (input.files && input.files[0]) {
                label.innerText = input.files[0].name;
                label.style.color = "white";
            } else {
                label.innerText = "Pilih Foto...";
                label.style.color = "#8e8e93";
            }
        };

        // --- FORM HANDLERS ---
        document.getElementById('formTesti').onsubmit = async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            const tanggal = document.getElementById('testiTanggal').value;
            const harga = document.getElementById('testiHarga').value;
            const akun = document.getElementById('testiAkun').value;

            if(!tanggal || !harga || !akun) return showStatus("Lengkapi form testimoni", true);

            btn.disabled = true; btn.innerText = "Memproses...";

            const text = `âœ¨ <b>TESTIMONI TRANSAKSI AHRASTORE</b>\n\n` +
                         `ðŸ“… Tanggal : ${tanggal}\n` +
                         `â„¹ï¸ Info : Akun ${akun}\n` +
                         `ðŸ’¸ Harga : ${harga}\n\n` +
                         `ðŸ“¦ Stok lain nya cek di sini\n` +
                         `ðŸŒ https://t.me/StokAhraStore2\n` +
                         `ðŸ¤ Grub stok jual beli, taruh stok mu atau cari stok lain di sini\n` +
                         `ðŸŒ https://t.me/JBAKUNMLBYAHRASTORE\n` +
                         `ðŸ¤Ÿ Testimoni? cek\n` +
                         `ðŸŒ https://t.me/TESTIMONIAHRASTORE`;

            const photo = document.getElementById('testiImage').files[0];
            const formData = new FormData();
            formData.append('chat_id', '7423591679'); // Ganti dengan ID Channel Testimoni Anda
            formData.append('parse_mode', 'HTML');
            formData.append('caption', text);
            if(photo) formData.append('photo', photo);

            try {
                await fetch(`https://api.telegram.org/bot7699614697:AAH3nlKT-dKETar5GEDPy6k2cVRyZpuLuao/${photo?'sendPhoto':'sendMessage'}`, {
                    method: 'POST',
                    body: formData
                });
                showStatus("Testimoni terkirim!");
                e.target.reset();
                document.getElementById('labelTestiTanggal').innerText = "Pilih Tanggal...";
                document.getElementById('labelTestiAkun').innerText = "Pilih Tingkatan...";
                document.getElementById('label-testiImage').innerText = "Pilih Foto...";
            } catch(e) {
                showStatus("Gagal kirim testimoni", true);
            }
            btn.disabled = false; btn.innerText = "POST TESTIMONI";
        };

        document.getElementById('formSave').onsubmit = async (e) => {
            e.preventDefault();
            const type = document.getElementById('saveType').value;
            if(!type) return showStatus("Pilih jenis akun", true);
            
            const btn = e.target.querySelector('button');
            btn.disabled = true; btn.innerText = "Menyimpan...";

            const data = { type, timestamp: Date.now(), isSold: false };
            ['dbEmail', 'dbPassG', 'dbPassM', 'dbBackup', 'dbName', 'dbKet', 'dbLoginVia'].forEach(f => {
                const el = document.getElementById(f); if(el) data[f] = el.value;
            });

            const file = document.getElementById('saveImage').files[0];
            if(file) data.image = await new Promise(r => { const fr = new FileReader(); fr.onload = () => r(fr.result); fr.readAsDataURL(file); });

            try {
                await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'stok'), data);
                showStatus("Data tersimpan di Cloud");
                e.target.reset(); 
                document.getElementById('dynamicFields').innerHTML = "";
                document.getElementById('labelSaveType').innerText = "Pilih Jenis Akun...";
                document.getElementById('label-saveImage').innerText = "Pilih Foto...";
                switchTab('db');
            } catch(err) { showStatus("Gagal Menginput Data", true); }
            btn.disabled = false; btn.innerText = "SIMPAN KE CLOUD";
        };

        document.getElementById('formStok').onsubmit = async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            btn.disabled = true; btn.innerText = "Mengirim...";
            const harga = document.getElementById('stokHarga').value;
            const info = document.getElementById('stokInfo').value;

            const text = `â€¼ï¸NEW ACCOUNT FROM AHRASTOREâ€¼ï¸\n\n` +
            `ðŸ’¸Price : ${harga}\n` +
            `â„¹ï¸Info Akun : ${info}\n\n` +
            `ðŸ›’Order? Chat Admin AHRASTORE\n` +
            `ðŸŒ https://t.me/zaaamyy\n\n` +
            `ðŸ“¦Stok lain nya cek di sini\n` +
            `ðŸŒ https://t.me/StokAhraStore2\n` +
            `ðŸ¤Grub stok jual beli, taruh stok mu atau cari stok lain di sini\n` +
            `ðŸŒ https://t.me/JBAKUNMLBYAHRASTORE\n` +
            `ðŸ¤ŸTestimoni? cek\n` +
            `ðŸŒ https://t.me/TESTIMONIAHRASTORE`;

            const formData = new FormData();
            formData.append('chat_id', '7423591679');
            formData.append('caption', text);
            const photo = document.getElementById('stokImage').files[0];
            if (photo) formData.append('photo', photo);

            try {
                await fetch(`https://api.telegram.org/bot7699614697:AAH3nlKT-dKETar5GEDPy6k2cVRyZpuLuao/${photo ? 'sendPhoto' : 'sendMessage'}`, {
                    method: 'POST',
                    body: formData
                });
                showStatus("Terkirim ke Telegram");
                e.target.reset();
                document.getElementById('label-stokImage').innerText = "Pilih Foto...";
            } catch (e) {
                showStatus("Gagal kirim Telegram", true);
            }
            btn.disabled = false; btn.innerText = "KIRIM KE CHANNEL";
        };

        // --- GLOBAL UI UTILS ---
        window.switchTab = (tab) => {
            ['stok', 'testi', 'save', 'db'].forEach(t => {
                document.getElementById(`section-${t}`).classList.toggle('hidden', t !== tab);
                document.getElementById(`tab-${t}`).classList.toggle('tab-active', t === tab);
            });
            window.scrollTo(0,0);
        };

        window.toggleAhraPopover = (id) => {
            const el = document.getElementById(id);
            el.style.display = el.style.display === 'flex' ? 'none' : 'flex';
        };

        window.closeModals = () => {
            document.querySelectorAll('.overlay, .bottom-sheet, .centered-modal').forEach(m => m.classList.remove('active'));
            setTimeout(() => { 
                const btn = document.getElementById('modalBtnAction');
                if(btn) btn.classList.add('hidden'); 
            }, 300);
        };
        document.getElementById('modalOverlay').onclick = closeModals;

        window.showStatus = (msg, isError = false) => {
            const el = document.getElementById('statusMsg'); el.innerText = msg;
            el.className = `mt-6 p-4 rounded-xl text-center text-[13px] font-bold border ${isError ? 'bg-red-500/10 text-red-500 border-red-500/20' : 'bg-green-500/10 text-blue-500 border-blue-500/20'}`;
            el.classList.remove('hidden'); setTimeout(() => el.classList.add('hidden'), 3000);
        };

        window.exportJSON = () => {
            const blob = new Blob([JSON.stringify(accounts, null, 2)], { type: "application/json" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `AhraStore_Cloud_Backup_${Date.now()}.json`;
            link.click();
        };

        window.openIOSPicker = (title, options, targetId, isDynamic = false) => {
            const container = document.getElementById('pickerOptionsContainer');
            document.getElementById('pickerTitle').innerText = title;
            container.innerHTML = "";
            options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = "picker-option"; btn.innerText = opt;
                btn.onclick = () => {
                    document.getElementById(targetId).value = opt;
                    const label = document.getElementById('label' + targetId.charAt(0).toUpperCase() + targetId.slice(1));
                    if(label) { label.innerText = opt; label.style.color = "white"; }
                    if (isDynamic && targetId === 'saveType') handleDynamicFields(opt);
                    closeModals();
                };
                container.appendChild(btn);
            });
            document.getElementById('modalOverlay').classList.add('active');
            document.getElementById('iosPickerSheet').classList.add('active');
        };

        function handleDynamicFields(type) {
            const container = document.getElementById('dynamicFields');
            let html = '<div class="ios-input-group">';
            if (type === "Mail fresh" || type === "Mail own") {
                html += `<div class="ios-input-row"><span class="row-label">Email Akun</span><input type="text" id="dbEmail" placeholder="Email" required></div>
                         <div class="ios-input-row"><span class="row-label">Password Google</span><input type="text" id="dbPassG" placeholder="Pass Google" required></div>
                         <div class="ios-input-row"><span class="row-label">Password Moonton</span><input type="text" id="dbPassM" placeholder="Pass Moonton" required></div>`;
                if(type === "Mail own") html += `<div class="ios-input-row"><span class="row-label">Kode Cadangan</span><textarea id="dbBackup" placeholder="Backup Code"></textarea></div>`;
            } else if (type === "Monkos") {
                html += `<div class="ios-input-row"><span class="row-label">Email</span><input type="text" id="dbEmail" placeholder="Email" required></div>
                         <div class="ios-input-row"><span class="row-label">Login Via</span><input type="text" id="dbLoginVia" placeholder="TikTok/FB/Google"></div>`;
            } else if (type === "Galver") {
                html += `<div class="ios-input-row"><span class="row-label">Nama/ID</span><input type="text" id="dbName" placeholder="Nama Akun"></div>
                         <div class="ios-input-row"><span class="row-label">Password Moonton</span><input type="text" id="dbPassM" placeholder="Password"></div>`;
            }
            html += '</div>';
            container.innerHTML = html;
        }

        async function sendAccountToTelegram(chatId, text, imageBase64) {
            const formData = new FormData();
            formData.append('chat_id', chatId); formData.append('parse_mode', 'HTML');
            if (imageBase64) {
                const arr = imageBase64.split(','), mime = arr[0].match(/:(.*?);/)[1], bstr = atob(arr[1]);
                let n = bstr.length; const u8arr = new Uint8Array(n); while(n--){ u8arr[n] = bstr.charCodeAt(n); }
                formData.append('photo', new Blob([u8arr], {type:mime}), 'img.png');
                formData.append('caption', text);
            } else { formData.append('text', text); }
            try { await fetch(`https://api.telegram.org/bot7699614697:AAH3nlKT-dKETar5GEDPy6k2cVRyZpuLuao/${imageBase64?'sendPhoto':'sendMessage'}`, { method: 'POST', body: formData }); showStatus("Terkirim"); } catch(e) { showStatus("Error", true); }
        }

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.ios-popover') && !e.target.closest('#settingsBtn') && !e.target.closest('.db-card')) {
                document.querySelectorAll('.ios-popover').forEach(m => m.style.display = 'none');
            }
        });
    </script>
</body>
</html>

