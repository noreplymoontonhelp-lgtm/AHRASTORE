<!DOCTYPE html>
<html lang="id">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
Â  Â  <title>AhraStore Pro - Cloud Management</title>
Â  Â  <script src="https://cdn.tailwindcss.com">
// =====================
// REVISI RESET PASSWORD (OTP TELEGRAM & PIN)
// =====================

// Helper: tampilkan error detail
function handleServerError(err, context) {
Â  Â  console.error(context, err);
Â  Â  const msg = err?.message || "Kesalahan tidak diketahui";
Â  Â  showIOSNotify("Gagal", `${context}: ${msg}`);
}

// Helper: validasi format telegram
function normalizeTelegramID(input) {
Â  Â  let v = input.trim();
Â  Â  if (v.startsWith('@')) v = v.substring(1);
Â  Â  return v;
}

// REVISI: OTP Telegram dengan error detail
window.checkTelegramAndSendOTP = async () => {
Â  Â  const raw = document.getElementById('forgotTelegramID').value;
Â  Â  const telegramID = normalizeTelegramID(raw);
Â  Â  const btn = document.getElementById('sendTelegramOTPBtn');

Â  Â  if (!telegramID) {
Â  Â  Â  Â  return showIOSNotify("Input Salah", "ID Telegram wajib diisi.");
Â  Â  }

Â  Â  btn.disabled = true;
Â  Â  btn.innerText = "Memproses...";

Â  Â  try {
Â  Â  Â  Â  if (!auth.currentUser) {
Â  Â  Â  Â  Â  Â  await signInAnonymously(auth);
Â  Â  Â  Â  }

Â  Â  Â  Â  const q = query(collectionGroup(db, 'settings'), where('telegramID', '==', telegramID));
Â  Â  Â  Â  const snap = await getDocs(q);

Â  Â  Â  Â  if (snap.empty) {
Â  Â  Â  Â  Â  Â  throw new Error("ID Telegram tidak terdaftar.");
Â  Â  Â  Â  }

Â  Â  Â  Â  const docSnap = snap.docs[0];
Â  Â  Â  Â  verifiedUserUID = docSnap.ref.parent.parent.id;

Â  Â  Â  Â  generatedOTP = Math.floor(100000 + Math.random() * 900000).toString();

Â  Â  Â  Â  const payload = {
Â  Â  Â  Â  Â  Â  chat_id: telegramID,
Â  Â  Â  Â  Â  Â  text: `ðŸ” KODE OTP RESET PASSWORD\n\nKode OTP Anda: ${generatedOTP}\n\nBerlaku 5 menit.`
Â  Â  Â  Â  };

Â  Â  Â  Â  const tgResp = await fetch(`${CF_TELEGRAM_PROXY_BASE}/sendMessage`, {
Â  Â  Â  Â  Â  Â  method: "POST",
Â  Â  Â  Â  Â  Â  headers: { "Content-Type": "application/json" },
Â  Â  Â  Â  Â  Â  body: JSON.stringify(payload)
Â  Â  Â  Â  });

Â  Â  Â  Â  const tgJson = await tgResp.json();
Â  Â  Â  Â  if (!tgJson.ok) {
Â  Â  Â  Â  Â  Â  throw new Error(tgJson.description || "Telegram API error");
Â  Â  Â  Â  }

Â  Â  Â  Â  document.getElementById('otpInputContainer').classList.remove('hidden');
Â  Â  Â  Â  btn.innerText = "Verifikasi OTP";
Â  Â  Â  Â  btn.disabled = false;
Â  Â  Â  Â  btn.onclick = verifyTelegramOTP;

Â  Â  Â  Â  showIOSNotify("OTP Terkirim", "Silakan cek Telegram Anda.");
Â  Â  } catch (e) {
Â  Â  Â  Â  btn.disabled = false;
Â  Â  Â  Â  btn.innerText = "Kirim OTP";
Â  Â  Â  Â  handleServerError(e, "OTP Telegram");
Â  Â  }
};

// REVISI: verifikasi OTP
window.verifyTelegramOTP = async () => {
Â  Â  const input = document.getElementById('forgotTelegramOTP').value.trim();
Â  Â  if (!input) return showIOSNotify("OTP Kosong", "Masukkan kode OTP.");

Â  Â  if (input !== generatedOTP) {
Â  Â  Â  Â  return showIOSNotify("OTP Salah", "Kode OTP tidak cocok.");
Â  Â  }

Â  Â  openNewPasswordModal();
};

// REVISI: verifikasi PIN cadangan dengan error detail
window.verifyBackupPin = async () => {
Â  Â  const email = document.getElementById('forgotPinEmail').value.trim();
Â  Â  const pin = document.getElementById('forgotPinCode').value.trim();

Â  Â  if (!email || !pin) {
Â  Â  Â  Â  return showIOSNotify("Input Salah", "Email dan PIN wajib diisi.");
Â  Â  }
Â  Â  if (pin.length !== 6) {
Â  Â  Â  Â  return showIOSNotify("PIN Tidak Valid", "PIN harus 6 digit.");
Â  Â  }

Â  Â  try {
Â  Â  Â  Â  if (!auth.currentUser) {
Â  Â  Â  Â  Â  Â  await signInAnonymously(auth);
Â  Â  Â  Â  }

Â  Â  Â  Â  const q = query(collection(db, 'users'), where('email', '==', email));
Â  Â  Â  Â  const snap = await getDocs(q);
Â  Â  Â  Â  if (snap.empty) {
Â  Â  Â  Â  Â  Â  throw new Error("Email tidak ditemukan.");
Â  Â  Â  Â  }

Â  Â  Â  Â  const userDoc = snap.docs[0];
Â  Â  Â  Â  const data = userDoc.data();

Â  Â  Â  Â  if (!data.backupPIN) {
Â  Â  Â  Â  Â  Â  throw new Error("PIN cadangan belum diatur.");
Â  Â  Â  Â  }

Â  Â  Â  Â  if (data.backupPIN !== pin) {
Â  Â  Â  Â  Â  Â  throw new Error("PIN cadangan salah.");
Â  Â  Â  Â  }

Â  Â  Â  Â  verifiedUserUID = userDoc.id;
Â  Â  Â  Â  openNewPasswordModal();
Â  Â  } catch (e) {
Â  Â  Â  Â  handleServerError(e, "Verifikasi PIN");
Â  Â  }
};

function openNewPasswordModal() {
Â  Â  closeModals();
Â  Â  document.getElementById('modalOverlay').classList.add('active');
Â  Â  document.getElementById('newPasswordModal').classList.add('active');
}

</script>
Â  Â  <style>
Â  Â  Â  Â  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
Â  Â  Â  Â Â 
Â  Â  Â  Â  :root {
Â  Â  Â  Â  Â  Â  --bg-dark: #000000;
Â  Â  Â  Â  Â  Â  --card-bg: #1c1c1e;
Â  Â  Â  Â  Â  Â  --card-secondary: #2c2c2e;
Â  Â  Â  Â  Â  Â  --accent-blue: #0a84ff;
Â  Â  Â  Â  Â  Â  --text-main: #ffffff;
Â  Â  Â  Â  Â  Â  --text-secondary: #8e8e93;
Â  Â  Â  Â  Â  Â  --ios-blur: rgba(28, 28, 30, 0.85);
Â  Â  Â  Â  Â  Â  color-scheme: dark;
Â  Â  Â  Â  }

Â  Â  Â  Â  html, body {
Â  Â  Â  Â  Â  Â  height: 100%;
Â  Â  Â  Â  Â  Â  margin: 0;
Â  Â  Â  Â  Â  Â  background-color: var(--bg-dark);
Â  Â  Â  Â  Â  Â  color: var(--text-main);
Â  Â  Â  Â  Â  Â  font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
Â  Â  Â  Â  Â  Â  overflow-x: hidden;
Â  Â  Â  Â  Â  Â  -webkit-text-size-adjust: 100%;
Â  Â  Â  Â  Â  Â  user-select: none;
Â  Â  Â  Â  }

Â  Â  Â  Â  .app-container {
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  max-width: 450px;
Â  Â  Â  Â  Â  Â  margin: 0 auto;
Â  Â  Â  Â  Â  Â  min-height: 100dvh;
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  Â  Â  background-color: var(--bg-dark);
Â  Â  Â  Â  Â  Â  position: relative;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Loading Screen */
Â  Â  Â  Â  #loadingScreen {
Â  Â  Â  Â  Â  Â  position: fixed;
Â  Â  Â  Â  Â  Â  inset: 0;
Â  Â  Â  Â  Â  Â  background: var(--bg-dark);
Â  Â  Â  Â  Â  Â  z-index: 9999;
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  Â  Â  transition: opacity 0.5s cubic-bezier(0.4, 0, 0.2, 1);
Â  Â  Â  Â  }

Â  Â  Â  Â  .ios-loader {
Â  Â  Â  Â  Â  Â  width: 35px;
Â  Â  Â  Â  Â  Â  height: 35px;
Â  Â  Â  Â  Â  Â  border: 3px solid rgba(255, 255, 255, 0.1);
Â  Â  Â  Â  Â  Â  border-top: 3px solid var(--accent-blue);
Â  Â  Â  Â  Â  Â  border-radius: 50%;
Â  Â  Â  Â  Â  Â  animation: spin 0.8s linear infinite;
Â  Â  Â  Â  }
Â  Â  Â  Â  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

Â  Â  Â  Â  /* Login Screen */
Â  Â  Â  Â  #loginScreen {
Â  Â  Â  Â  Â  Â  position: fixed; inset: 0; background: black; z-index: 9000;
Â  Â  Â  Â  Â  Â  display: flex; flex-direction: column; align-items: center; justify-content: center;
Â  Â  Â  Â  Â  Â  padding: 40px; text-align: center;
Â  Â  Â  Â  Â  Â  transition: opacity 0.35s cubic-bezier(0.4, 0, 0.2, 1), transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
Â  Â  Â  Â  Â  Â  transform: scale(1);
Â  Â  Â  Â  }
Â  Â  Â  Â  .login-logo {
Â  Â  Â  Â  Â  Â  width: 80px; height: 80px; background: var(--accent-blue);
Â  Â  Â  Â  Â  Â  border-radius: 22px; margin-bottom: 24px;
Â  Â  Â  Â  Â  Â  display: flex; align-items: center; justify-content: center;
Â  Â  Â  Â  Â  Â  box-shadow: 0 10px 30px rgba(10, 132, 255, 0.3);
Â  Â  Â  Â  Â  Â  overflow: hidden;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Smooth Page Transition After Login (Zoom Out) */
Â  Â  Â  Â  #loginScreen.login-exit {
Â  Â  Â  Â  Â  Â  opacity: 0;
Â  Â  Â  Â  Â  Â  transform: scale(1.03);
Â  Â  Â  Â  Â  Â  pointer-events: none;
Â  Â  Â  Â  }

Â  Â  Â  Â  #app.app-enter-zoomout {
Â  Â  Â  Â  Â  Â  animation: appZoomOut 0.45s cubic-bezier(0.19, 1, 0.22, 1) both;
Â  Â  Â  Â  }

Â  Â  Â  Â  @keyframes appZoomOut {
Â  Â  Â  Â  Â  Â  from { opacity: 0; transform: scale(1.06); }
Â  Â  Â  Â  Â  Â  to { opacity: 1; transform: scale(1); }
Â  Â  Â  Â  }

Â  Â  Â  Â  .shizuku-card {
Â  Â  Â  Â  Â  Â  background-color: var(--card-bg);
Â  Â  Â  Â  Â  Â  border-radius: 14px;
Â  Â  Â  Â  Â  Â  padding: 16px;
Â  Â  Â  Â  Â  Â  margin-bottom: 16px;
Â  Â  Â  Â  Â  Â  border: 0.5px solid rgba(255, 255, 255, 0.05);
Â  Â  Â  Â  }

Â  Â  Â  Â  .ios-input-group {
Â  Â  Â  Â  Â  Â  background-color: var(--card-secondary);
Â  Â  Â  Â  Â  Â  border-radius: 12px;
Â  Â  Â  Â  Â  Â  overflow: hidden;
Â  Â  Â  Â  Â  Â  border: 0.5px solid rgba(255, 255, 255, 0.05);
Â  Â  Â  Â  Â  Â  text-align: left;
Â  Â  Â  Â  }

Â  Â  Â  Â  .ios-input-row {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  Â  Â  padding: 10px 16px;
Â  Â  Â  Â  Â  Â  border-bottom: 0.5px solid rgba(255, 255, 255, 0.05);
Â  Â  Â  Â  Â  Â  text-align: left;
Â  Â  Â  Â  }
Â  Â  Â  Â  .ios-input-row:last-child { border-bottom: none; }

Â  Â  Â  Â  .row-label {
Â  Â  Â  Â  Â  Â  font-size: 10px;
Â  Â  Â  Â  Â  Â  font-weight: 800;
Â  Â  Â  Â  Â  Â  color: var(--accent-blue);
Â  Â  Â  Â  Â  Â  text-transform: uppercase;
Â  Â  Â  Â  Â  Â  letter-spacing: 0.05em;
Â  Â  Â  Â  Â  Â  margin-bottom: 2px;
Â  Â  Â  Â  Â  Â  text-align: left;
Â  Â  Â  Â  }

Â  Â  Â  Â  .pill-button {
Â  Â  Â  Â  Â  Â  background-color: var(--accent-blue);
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  border-radius: 12px;
Â  Â  Â  Â  Â  Â  padding: 14px 20px;
Â  Â  Â  Â  Â  Â  font-weight: 600;
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  Â  Â  gap: 10px;
Â  Â  Â  Â  Â  Â  font-size: 15px;
Â  Â  Â  Â  Â  Â  transition: all 0.2s;
Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  }
Â  Â  Â  Â  .pill-button:active { transform: scale(0.96); opacity: 0.8; }
Â  Â  Â  Â  .pill-button:disabled { opacity: 0.5; cursor: not-allowed; }

Â  Â  Â  Â  .tab-btn {
Â  Â  Â  Â  Â  Â  position: relative;
Â  Â  Â  Â  Â  Â  padding: 12px 0;
Â  Â  Â  Â  Â  Â  font-size: 11px;
Â  Â  Â  Â  Â  Â  font-weight: 700;
Â  Â  Â  Â  Â  Â  color: var(--text-secondary);
Â  Â  Â  Â  Â  Â  transition: color 0.2s;
Â  Â  Â  Â  Â  Â  text-transform: uppercase;
Â  Â  Â  Â  Â  Â  letter-spacing: 0.05em;
Â  Â  Â  Â  }
Â  Â  Â  Â  .tab-btn.tab-active { color: var(--accent-blue); }
Â  Â  Â  Â  .tab-btn.tab-active::after {
Â  Â  Â  Â  Â  Â  content: '';
Â  Â  Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  Â  Â  bottom: 0; left: 25%; width: 50%; height: 3px;
Â  Â  Â  Â  Â  Â  background-color: var(--accent-blue);
Â  Â  Â  Â  Â  Â  border-radius: 3px 3px 0 0;
Â  Â  Â  Â  }

Â  Â  Â  Â  .ios-select-trigger {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  justify-content: space-between;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  padding: 14px 16px;
Â  Â  Â  Â  Â  Â  background-color: var(--card-secondary);
Â  Â  Â  Â  Â  Â  border-radius: 12px;
Â  Â  Â  Â  Â  Â  color: var(--text-main);
Â  Â  Â  Â  Â  Â  font-size: 15px;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  transition: background 0.2s;
Â  Â  Â  Â  Â  Â  border: 0.5px solid rgba(255, 255, 255, 0.05);
Â  Â  Â  Â  }

Â  Â  Â  Â  input, textarea {
Â  Â  Â  Â  Â  Â  background: transparent !important;
Â  Â  Â  Â  Â  Â  border: none !important;
Â  Â  Â  Â  Â  Â  color: white !important;
Â  Â  Â  Â  Â  Â  padding: 0 !important;
Â  Â  Â  Â  Â  Â  font-size: 15px !important;
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  outline: none;
Â  Â  Â  Â  Â  Â  text-align: left;
Â  Â  Â  Â  }
Â  Â  Â  Â  input::placeholder { color: var(--text-secondary); }

Â  Â  Â  Â  .price-input {
Â  Â  Â  Â  Â  Â  background: transparent !important;
Â  Â  Â  Â  Â  Â  border: none !important;
Â  Â  Â  Â  Â  Â  color: white !important;
Â  Â  Â  Â  Â  Â  padding: 0 !important;
Â  Â  Â  Â  Â  Â  font-size: 15px !important;
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  outline: none;
Â  Â  Â  Â  Â  Â  text-align: left;
Â  Â  Â  Â  Â  Â  inputmode: decimal;
Â  Â  Â  Â  Â  Â  -webkit-user-select: text;
Â  Â  Â  Â  Â  Â  user-select: text;
Â  Â  Â  Â  }

Â  Â  Â  Â  .ios-popover {
Â  Â  Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  Â  Â  background: var(--ios-blur);
Â  Â  Â  Â  Â  Â  backdrop-filter: blur(30px);
Â  Â  Â  Â  Â  Â  -webkit-backdrop-filter: blur(30px);
Â  Â  Â  Â  Â  Â  border-radius: 14px;
Â  Â  Â  Â  Â  Â  z-index: 100;
Â  Â  Â  Â  Â  Â  box-shadow: 0 10px 30px rgba(0,0,0,0.5);
Â  Â  Â  Â  Â  Â  display: none;
Â  Â  Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  Â  Â  overflow: hidden;
Â  Â  Â  Â  Â  Â  border: 0.5px solid rgba(255, 255, 255, 0.1);
Â  Â  Â  Â  Â  Â  transform-origin: top right;
Â  Â  Â  Â  Â  Â  animation: popIn 0.2s cubic-bezier(0.4, 0, 0.2, 1) forwards;
Â  Â  Â  Â  Â  Â  width: 240px;
Â  Â  Â  Â  }
Â  Â  Â  Â  @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

Â  Â  Â  Â  .popover-item {
Â  Â  Â  Â  Â  Â  padding: 16px;
Â  Â  Â  Â  Â  Â  font-size: 14px;
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  justify-content: space-between;
Â  Â  Â  Â  Â  Â  border-bottom: 0.5px solid rgba(255, 255, 255, 0.1);
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  text-align: left;
Â  Â  Â  Â  Â  Â  background: transparent;
Â  Â  Â  Â  Â  Â  min-height: 52px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .popover-item:last-child { border-bottom: none; }
Â  Â  Â  Â  .popover-item:active { background: rgba(255,255,255,0.15); }

Â  Â  Â  Â  .overlay {
Â  Â  Â  Â  Â  Â  position: fixed;
Â  Â  Â  Â  Â  Â  inset: 0;
Â  Â  Â  Â  Â  Â  background: rgba(0,0,0,0.6);
Â  Â  Â  Â  Â  Â  backdrop-filter: blur(4px);
Â  Â  Â  Â  Â  Â  z-index: 8000;
Â  Â  Â  Â  Â  Â  display: none;
Â  Â  Â  Â  Â  Â  opacity: 0;
Â  Â  Â  Â  Â  Â  transition: opacity 0.3s;
Â  Â  Â  Â  }
Â  Â  Â  Â  .overlay.active { display: block; opacity: 1; }

Â  Â  Â  Â  .bottom-sheet {
Â  Â  Â  Â  Â  Â  position: fixed;
Â  Â  Â  Â  Â  Â  bottom: 12px; left: 12px; right: 12px;
Â  Â  Â  Â  Â  Â  background: var(--ios-blur);
Â  Â  Â  Â  Â  Â  backdrop-filter: blur(30px) saturate(180%);
Â  Â  Â  Â  Â  Â  border-radius: 20px;
Â  Â  Â  Â  Â  Â  z-index: 8500;
Â  Â  Â  Â  Â  Â  transform: translateY(120%);
Â  Â  Â  Â  Â  Â  transition: transform 0.4s cubic-bezier(0.1, 0.7, 0.1, 1);
Â  Â  Â  Â  Â  Â  overflow: hidden;
Â  Â  Â  Â  Â  Â  box-shadow: 0 10px 40px rgba(0,0,0,0.6);
Â  Â  Â  Â  }
Â  Â  Â  Â  .bottom-sheet.active { transform: translateY(0); }

Â  Â  Â  Â  .centered-modal {
Â  Â  Â  Â  Â  Â  position: fixed;
Â  Â  Â  Â  Â  Â  top: 50%; left: 50%;
Â  Â  Â  Â  Â  Â  transform: translate(-50%, -50%) scale(0.9);
Â  Â  Â  Â  Â  Â  width: 90%; max-width: 360px;
Â  Â  Â  Â  Â  Â  background: var(--ios-blur);
Â  Â  Â  Â  Â  Â  backdrop-filter: blur(40px);
Â  Â  Â  Â  Â  Â  border-radius: 24px;
Â  Â  Â  Â  Â  Â  z-index: 9000;
Â  Â  Â  Â  Â  Â  display: none;
Â  Â  Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  Â  Â  opacity: 0;
Â  Â  Â  Â  Â  Â  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
Â  Â  Â  Â  Â  Â  border: 0.5px solid rgba(255, 255, 255, 0.15);
Â  Â  Â  Â  Â  Â  box-shadow: 0 20px 60px rgba(0,0,0,0.7);
Â  Â  Â  Â  }
Â  Â  Â  Â  .centered-modal.active { display: flex; opacity: 1; transform: translate(-50%, -50%) scale(1); }

Â  Â  Â  Â  .picker-option {
Â  Â  Â  Â  Â  Â  padding: 16px; text-align: center; font-size: 17px;
Â  Â  Â  Â  Â  Â  color: var(--accent-blue); background: transparent;
Â  Â  Â  Â  Â  Â  width: 100%; border-bottom: 0.5px solid rgba(255, 255, 255, 0.1);
Â  Â  Â  Â  }
Â  Â  Â  Â  .picker-option:active { background: rgba(255, 255, 255, 0.1); }

Â  Â  Â  Â  /* --- LOGIKA DATABASE GRID & BLUR --- */
Â  Â  Â  Â  .db-grid {Â 
Â  Â  Â  Â  Â  Â  display: grid;Â 
Â  Â  Â  Â  Â  Â  grid-template-columns: repeat(1, 1fr);Â 
Â  Â  Â  Â  Â  Â  gap: 14px;Â 
Â  Â  Â  Â  Â  Â  transition: all 0.3s ease;
Â  Â  Â  Â  }

Â  Â  Â  Â  .db-card {
Â  Â  Â  Â  Â  Â  background: var(--card-bg); border-radius: 16px; padding: 12px;
Â  Â  Â  Â  Â  Â  border: 0.5px solid rgba(255, 255, 255, 0.05);
Â  Â  Â  Â  Â  Â  position: relative; cursor: pointer;
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  gap: 14px;
Â  Â  Â  Â  Â  Â  transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
Â  Â  Â  Â  Â  Â  z-index: 1;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Saat Grid dalam mode fokus (salah satu kartu aktif) */
Â  Â  Â  Â  .db-grid.has-active-card .db-card {
Â  Â  Â  Â  Â  Â  filter: blur(4px) brightness(0.7);
Â  Â  Â  Â  Â  Â  opacity: 0.6;
Â  Â  Â  Â  Â  Â  pointer-events: none;
Â  Â  Â  Â  Â  Â  transform: scale(0.98);
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Kartu yang sedang AKTIF (diklik) */
Â  Â  Â  Â  .db-grid.has-active-card .db-card.active-card {
Â  Â  Â  Â  Â  Â  filter: none;
Â  Â  Â  Â  Â  Â  opacity: 1;
Â  Â  Â  Â  Â  Â  pointer-events: auto;
Â  Â  Â  Â  Â  Â  z-index: 50;
Â  Â  Â  Â  Â  Â  transform: scale(1.03);
Â  Â  Â  Â  Â  Â  border-color: var(--accent-blue);
Â  Â  Â  Â  Â  Â  box-shadow: 0 10px 30px rgba(0,0,0,0.5), 0 0 0 1px rgba(10, 132, 255, 0.3);
Â  Â  Â  Â  Â  Â  background: #242426;
Â  Â  Â  Â  }

Â  Â  Â  Â  .sold-badge {
Â  Â  Â  Â  Â  Â  background: #ff3b30; color: white; font-size: 10px;
Â  Â  Â  Â  Â  Â  padding: 2px 8px; border-radius: 6px; font-weight: 800;
Â  Â  Â  Â  Â  Â  position: absolute; top: 10px; right: 10px;
Â  Â  Â  Â  Â  Â  box-shadow: 0 2px 10px rgba(255, 59, 48, 0.3); z-index: 5;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* iOS Professional Notification Card */
Â  Â  Â  Â  #iosNotifyContainer {
Â  Â  Â  Â  Â  Â  position: fixed;
Â  Â  Â  Â  Â  Â  top: 20px;
Â  Â  Â  Â  Â  Â  left: 50%;
Â  Â  Â  Â  Â  Â  transform: translateX(-50%) translateY(-150%);
Â  Â  Â  Â  Â  Â  width: calc(100% - 40px);
Â  Â  Â  Â  Â  Â  max-width: 400px;
Â  Â  Â  Â  Â  Â  z-index: 10000;
Â  Â  Â  Â  Â  Â  transition: transform 0.6s cubic-bezier(0.19, 1, 0.22, 1);
Â  Â  Â  Â  }
Â  Â  Â  Â  #iosNotifyContainer.active { transform: translateX(-50%) translateY(0); }

Â  Â  Â  Â  .ios-notification {
Â  Â  Â  Â  Â  Â  background: rgba(44, 44, 46, 0.8);
Â  Â  Â  Â  Â  Â  backdrop-filter: blur(20px) saturate(180%);
Â  Â  Â  Â  Â  Â  -webkit-backdrop-filter: blur(20px) saturate(180%);
Â  Â  Â  Â  Â  Â  border-radius: 18px;
Â  Â  Â  Â  Â  Â  padding: 16px;
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  gap: 12px;
Â  Â  Â  Â  Â  Â  box-shadow: 0 10px 40px rgba(0,0,0,0.4);
Â  Â  Â  Â  Â  Â  border: 0.5px solid rgba(255,255,255,0.1);
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Toggle Switch Styling */
Â  Â  Â  Â  .toggle-switch {
Â  Â  Â  Â  Â  Â  position: relative;
Â  Â  Â  Â  Â  Â  display: inline-block;
Â  Â  Â  Â  Â  Â  width: 44px;
Â  Â  Â  Â  Â  Â  height: 24px;
Â  Â  Â  Â  }

Â  Â  Â  Â  .toggle-switch input {
Â  Â  Â  Â  Â  Â  opacity: 0;
Â  Â  Â  Â  Â  Â  width: 0;
Â  Â  Â  Â  Â  Â  height: 0;
Â  Â  Â  Â  }

Â  Â  Â  Â  .toggle-slider {
Â  Â  Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  top: 0;
Â  Â  Â  Â  Â  Â  left: 0;
Â  Â  Â  Â  Â  Â  right: 0;
Â  Â  Â  Â  Â  Â  bottom: 0;
Â  Â  Â  Â  Â  Â  background-color: #3c3c3e;
Â  Â  Â  Â  Â  Â  transition: .4s;
Â  Â  Â  Â  Â  Â  border-radius: 34px;
Â  Â  Â  Â  }

Â  Â  Â  Â  .toggle-slider:before {
Â  Â  Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  Â  Â  content: "";
Â  Â  Â  Â  Â  Â  height: 18px;
Â  Â  Â  Â  Â  Â  width: 18px;
Â  Â  Â  Â  Â  Â  left: 3px;
Â  Â  Â  Â  Â  Â  bottom: 3px;
Â  Â  Â  Â  Â  Â  background-color: white;
Â  Â  Â  Â  Â  Â  transition: .4s;
Â  Â  Â  Â  Â  Â  border-radius: 50%;
Â  Â  Â  Â  }

Â  Â  Â  Â  input:checked + .toggle-slider {
Â  Â  Â  Â  Â  Â  background-color: #30d158;
Â  Â  Â  Â  }

Â  Â  Â  Â  input:checked + .toggle-slider:before {
Â  Â  Â  Â  Â  Â  transform: translateX(20px);
Â  Â  Â  Â  }

Â  Â  Â  Â  .forgot-link {
Â  Â  Â  Â  Â  Â  font-size: 11px;
Â  Â  Â  Â  Â  Â  color: var(--accent-blue);
Â  Â  Â  Â  Â  Â  text-decoration: none;
Â  Â  Â  Â  Â  Â  font-weight: 500;
Â  Â  Â  Â  Â  Â  margin-top: 4px;
Â  Â  Â  Â  Â  Â  display: block;
Â  Â  Â  Â  Â  Â  text-align: right;
Â  Â  Â  Â  Â  Â  padding-right: 4px;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* New Styles for Password Visibility */
Â  Â  Â  Â  .password-container {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  }

Â  Â  Â  Â  .password-input {
Â  Â  Â  Â  Â  Â  flex: 1;
Â  Â  Â  Â  Â  Â  background: transparent;
Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  padding: 0;
Â  Â  Â  Â  Â  Â  font-size: 15px;
Â  Â  Â  Â  Â  Â  outline: none;
Â  Â  Â  Â  }

Â  Â  Â  Â  .password-toggle {
Â  Â  Â  Â  Â  Â  background: transparent;
Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  color: #8e8e93;
Â  Â  Â  Â  Â  Â  padding: 4px;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  }

Â  Â  Â  Â  .backup-security-item {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  justify-content: space-between;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  padding: 12px 0;
Â  Â  Â  Â  }

Â  Â  Â  Â  .backup-security-label {
Â  Â  Â  Â  Â  Â  font-size: 15px;
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  }

Â  Â  Â  Â  .backup-security-value {
Â  Â  Â  Â  Â  Â  font-size: 14px;
Â  Â  Â  Â  Â  Â  color: #8e8e93;
Â  Â  Â  Â  }

Â  Â  Â  Â  .add-backup-btn {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  Â  Â  gap: 6px;
Â  Â  Â  Â  Â  Â  padding: 10px 16px;
Â  Â  Â  Â  Â  Â  background: rgba(10, 132, 255, 0.1);
Â  Â  Â  Â  Â  Â  border: 1px solid rgba(10, 132, 255, 0.3);
Â  Â  Â  Â  Â  Â  border-radius: 10px;
Â  Â  Â  Â  Â  Â  color: var(--accent-blue);
Â  Â  Â  Â  Â  Â  font-size: 14px;
Â  Â  Â  Â  Â  Â  font-weight: 500;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  transition: all 0.2s;
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  }

Â  Â  Â  Â  .add-backup-btn:active {
Â  Â  Â  Â  Â  Â  background: rgba(10, 132, 255, 0.2);
Â  Â  Â  Â  }

Â  Â  Â  Â  .reset-option-btn {
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  padding: 14px;
Â  Â  Â  Â  Â  Â  background: var(--card-secondary);
Â  Â  Â  Â  Â  Â  border-radius: 12px;
Â  Â  Â  Â  Â  Â  border: 0.5px solid rgba(255, 255, 255, 0.05);
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  font-size: 15px;
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  Â  Â  margin-bottom: 10px;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  transition: background 0.2s;
Â  Â  Â  Â  }

Â  Â  Â  Â  .reset-option-btn:active {
Â  Â  Â  Â  Â  Â  background: rgba(255, 255, 255, 0.1);
Â  Â  Â  Â  }
Â  Â  </style>
</head>
<body>

Â  Â  <!-- iOS Notification Card -->
Â  Â  <div id="iosNotifyContainer">
Â  Â  Â  Â  <div class="ios-notification">
Â  Â  Â  Â  Â  Â  <div id="notifyIconContainer" class="w-10 h-10 rounded-xl flex items-center justify-center">
Â  Â  Â  Â  Â  Â  Â  Â  <!-- Icon injected by JS -->
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="flex-1">
Â  Â  Â  Â  Â  Â  Â  Â  <p id="notifyTitle" class="text-[14px] font-bold text-white"></p>
Â  Â  Â  Â  Â  Â  Â  Â  <p id="notifyMessage" class="text-[13px] text-zinc-300 leading-tight"></p>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <!-- Loading Screen -->
Â  Â  <div id="loadingScreen">
Â  Â  Â  Â  <div class="ios-loader"></div>
Â  Â  Â  Â  <p class="mt-6 text-[10px] font-bold text-[#8e8e93] tracking-[0.2em] uppercase">AhraStore</p>
Â  Â  </div>

Â  Â  <!-- Login Screen -->
Â  Â  <div id="loginScreen" class="hidden">
Â  Â  Â  Â  <div class="login-logo">
Â  Â  Â  Â  Â  Â  <img src="https://img.sanishtech.com/u/f52d0e9847d08bdff31a58247421aacc.png" alt="Logo" class="w-full h-full object-cover">
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <h2 class="text-3xl font-bold tracking-tight mb-2">Selamat Datang Di AHRASTORE.apk</h2>
Â  Â  Â  Â  <p class="text-[14px] text-zinc-500 mb-6">Silahkan Login Untuk Lanjut</p>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div class="w-full max-w-xs space-y-4">
Â  Â  Â  Â  Â  Â  <div class="ios-input-group">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="ios-input-row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="row-label">Email</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="email" id="loginEmail" placeholder="email@contoh.com">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="ios-input-row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="row-label">Password</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="password-container">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="password" id="loginPass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" class="password-input">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" id="eyeToggleBtn" class="password-toggle">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg id="eyeIcon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <circle cx="12" cy="12" r="3"/>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <button id="loginBtn" onclick="handleEmailAuth('login')" class="pill-button">MASUK</button>
Â  Â  Â  Â  Â  Â  <button id="signupBtn" onclick="handleEmailAuth('signup')" class="pill-button !bg-zinc-800 !text-blue-500">DAFTAR BARU</button>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <!-- Forgot Password Options Modal (REVISED) -->
Â  Â  <div id="forgotPasswordOptionsModal" class="centered-modal">
Â  Â  Â  Â  <div class="p-6">
Â  Â  Â  Â  Â  Â  <h3 class="text-lg font-bold mb-4 text-center">Reset Password</h3>
Â  Â  Â  Â  Â  Â  <div class="space-y-4">
Â  Â  Â  Â  Â  Â  Â  Â  <!-- Removed Email OTP Option -->
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="openForgotPasswordTelegramModal()" class="reset-option-btn">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Kirim OTP ke Telegram
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="openForgotPasswordPinModal()" class="reset-option-btn">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Gunakan PIN Cadangan
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="closeModals()" class="text-[13px] text-zinc-500">Kembali ke Login</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <!-- Forgot Password Telegram Modal (REVISED) -->
Â  Â  <div id="forgotPasswordTelegramModal" class="centered-modal">
Â  Â  Â  Â  <div class="p-6">
Â  Â  Â  Â  Â  Â  <h3 class="text-lg font-bold mb-4 text-center">Reset via Telegram</h3>
Â  Â  Â  Â  Â  Â  <div class="space-y-4">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="ios-input-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="ios-input-row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="row-label">ID Telegram</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="forgotTelegramID" placeholder="@username atau angka ID">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="otpInputContainer" class="hidden">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="ios-input-row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="row-label">Kode OTP</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="forgotTelegramOTP" placeholder="Masukkan kode OTP">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div id="telegramActionContainer">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <button onclick="checkTelegramAndSendOTP()" id="sendTelegramOTPBtn" class="pill-button !bg-green-500">Kirim OTP</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="openForgotPasswordOptions()" class="text-[13px] text-zinc-500">Kembali</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <!-- Forgot Password PIN Modal (REVISED) -->
Â  Â  <div id="forgotPasswordPinModal" class="centered-modal">
Â  Â  Â  Â  <div class="p-6">
Â  Â  Â  Â  Â  Â  <h3 class="text-lg font-bold mb-4 text-center">Reset via PIN Cadangan</h3>
Â  Â  Â  Â  Â  Â  <div class="space-y-4">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="ios-input-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="ios-input-row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="row-label">Email Terdaftar</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="email" id="forgotPinEmail" placeholder="email@contoh.com">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="ios-input-row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="row-label">PIN Cadangan</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="password-container">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="password" id="forgotPinCode" placeholder="Masukkan 6-digit PIN" maxlength="6" inputmode="numeric" class="password-input">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" onclick="togglePasswordVisibility('forgotPinCode', 'forgotPinCodeToggle')" class="password-toggle" id="forgotPinCodeToggle">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <circle cx="12" cy="12" r="3"/>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="verifyBackupPin()" id="verifyPinBtn" class="pill-button !bg-green-500">Verifikasi PIN</button>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="openForgotPasswordOptions()" class="text-[13px] text-zinc-500">Kembali</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <!-- New Password Modal (NEW) -->
Â  Â  <div id="newPasswordModal" class="centered-modal">
Â  Â  Â  Â  <div class="p-6">
Â  Â  Â  Â  Â  Â  <div class="w-12 h-12 bg-green-500/20 rounded-full flex items-center justify-center mx-auto mb-3">
Â  Â  Â  Â  Â  Â  Â  Â  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="2.5"><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/></svg>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <h3 class="text-lg font-bold mb-1 text-center">Buat Sandi Baru</h3>
Â  Â  Â  Â  Â  Â  <p class="text-xs text-center text-zinc-500 mb-4">Verifikasi berhasil. Silahkan buat sandi baru.</p>
Â  Â  Â  Â  Â  Â  <div class="space-y-4">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="ios-input-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="ios-input-row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="row-label">Password Baru</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="password-container">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="password" id="finalNewPassword" placeholder="Minimal 6 karakter" class="password-input">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" onclick="togglePasswordVisibility('finalNewPassword', 'finalNewPasswordToggle')" class="password-toggle" id="finalNewPasswordToggle">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <circle cx="12" cy="12" r="3"/>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="finalizeReset()" id="finalizeBtn" class="pill-button">SIMPAN & LOGIN</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <!-- Setup User Data Modal (New User) -->
Â  Â  <div id="setupUserDataModal" class="centered-modal">
Â  Â  Â  Â  <div class="p-6">
Â  Â  Â  Â  Â  Â  <div class="w-16 h-16 bg-blue-500 rounded-3xl flex items-center justify-center mx-auto mb-4 shadow-xl shadow-blue-500/20">
Â  Â  Â  Â  Â  Â  Â  Â  <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <h3 class="text-xl font-bold mb-1 text-white">Lengkapi Profil</h3>
Â  Â  Â  Â  Â  Â  <p class="text-[13px] text-zinc-500 mb-6">Silahkan lengkapi data diri untuk keamanan akun.</p>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div class="ios-input-group mb-6 space-y-4">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="ios-input-row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="row-label">Username</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="newUsername" placeholder="Contoh: AdminGanteng" maxlength="15">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="ios-input-row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="row-label">Tempat, Tanggal Lahir</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="newBirthInfo" placeholder="Contoh: Jakarta, 01 Januari 2000">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="ios-input-row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="row-label">ID Telegram</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="newTelegramID" placeholder="@username atau angka ID">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="ios-input-row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="row-label">PIN Cadangan (6 digit)</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="password-container">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="password" id="newBackupPIN" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" maxlength="6" inputmode="numeric" class="password-input">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" onclick="togglePasswordVisibility('newBackupPIN', 'newBackupPINToggle')" class="password-toggle" id="newBackupPINToggle">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <circle cx="12" cy="12" r="3"/>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <button onclick="saveInitialUserData()" id="saveUserDataBtn" class="pill-button">SIMPAN PROFIL</button>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <!-- Import JSON Modal -->
Â  Â  <div id="importJsonModal" class="centered-modal">
Â  Â  Â  Â  <div class="p-6">
Â  Â  Â  Â  Â  Â  <h3 class="text-lg font-bold mb-4 text-center">Import Data</h3>
Â  Â  Â  Â  Â  Â  <div class="space-y-4">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="ios-input-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="ios-input-row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="row-label">File JSON</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="jsonFileInput" class="flex justify-between items-center cursor-pointer py-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="jsonFileLabel" class="text-[15px] text-zinc-500">Pilih file .json...</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-blue-500">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="file" id="jsonFileInput" accept=".json" class="hidden" onchange="handleJsonFileSelect()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-[12px] text-zinc-500 mb-2">Format file harus .json yang diexport dari aplikasi ini</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="importJSONData()" id="importJsonBtn" class="pill-button !bg-green-500" disabled>IMPORT DATA</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="closeModals()" class="text-[13px] text-zinc-500">Batal</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <!-- Add Backup PIN Modal -->
Â  Â  <div id="addBackupPinModal" class="centered-modal">
Â  Â  Â  Â  <div class="p-6">
Â  Â  Â  Â  Â  Â  <h3 class="text-lg font-bold mb-4 text-center">Tambah PIN Cadangan</h3>
Â  Â  Â  Â  Â  Â  <div class="space-y-4">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="ios-input-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="ios-input-row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="row-label">PIN Cadangan Baru (6 digit)</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="password-container">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="password" id="newBackupPinInput" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" maxlength="6" inputmode="numeric" class="password-input">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" onclick="togglePasswordVisibility('newBackupPinInput', 'newBackupPinInputToggle')" class="password-toggle" id="newBackupPinInputToggle">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <circle cx="12" cy="12" r="3"/>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="ios-input-row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="row-label">Konfirmasi PIN</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="password-container">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="password" id="confirmBackupPinInput" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" maxlength="6" inputmode="numeric" class="password-input">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" onclick="togglePasswordVisibility('confirmBackupPinInput', 'confirmBackupPinInputToggle')" class="password-toggle" id="confirmBackupPinInputToggle">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <circle cx="12" cy="12" r="3"/>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex gap-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="saveBackupPIN()" class="pill-button flex-1 !bg-green-500">Simpan PIN</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="closeModals()" class="pill-button flex-1 !bg-zinc-700">Batal</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <!-- App Container -->
Â  Â  <div id="app" class="app-container" style="display:none;">

Â  Â  Â  Â  <header class="px-6 py-4 flex justify-between items-end bg-black/80 backdrop-blur-xl sticky top-0 z-40 border-b border-white/5">
Â  Â  Â  Â  Â  Â  <div class="flex items-center gap-3">
Â  Â  Â  Â  Â  Â  Â  Â  <div id="headerProfilePhoto" class="w-12 h-12 rounded-full bg-zinc-800 border-2 border-white/10 overflow-hidden flex items-center justify-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <img id="headerProfileImg" src="" class="w-full h-full object-cover hidden">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg id="headerProfilePlaceholder" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#444" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h1 id="welcomeHeader" class="text-2xl font-bold text-white tracking-tight">Halo User</h1>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center gap-1.5 mt-0.5">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="statusDot" class="w-2 h-2 rounded-full bg-green-500 transition-colors duration-300"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="connectionLabel" class="text-[10px] font-bold text-zinc-500 uppercase tracking-wider">Online</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <button id="settingsBtn" onclick="toggleAhraPopover('settingsOverlay')" class="p-2 text-blue-500 transition-all duration-300">
Â  Â  Â  Â  Â  Â  Â  Â  <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0a2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
Â  Â  Â  Â  Â  Â  </button>

Â  Â  Â  Â  Â  Â  <div id="settingsOverlay" class="ios-popover" style="top: 75px; right: 20px;">
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="openProfileSettings(); closeAllPopovers();" class="popover-item">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>Pengaturan Akun</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="importJSON(); closeAllPopovers();" class="popover-item">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>Import Data (.json)</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M3 15v4a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-4"/><polyline points="17 9 12 4 7 9"/><line x1="12" y1="4" x2="12" y2="16"/></svg>
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="exportJSON(); closeAllPopovers();" class="popover-item">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>Export Data (.json)</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="refreshApp(); closeAllPopovers();" class="popover-item">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>Refresh Aplikasi</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M23 4v6h-6"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="handleLogout()" class="popover-item !text-red-500 font-bold">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>Logout Akun</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </header>

Â  Â  Â  Â  <nav class="flex px-4 bg-black/80 backdrop-blur-xl border-b border-white/5 sticky top-[75px] z-30">
Â  Â  Â  Â  Â  Â  <button onclick="switchTab('stok')" id="tab-stok" class="tab-btn flex-1 tab-active">Stok</button>
Â  Â  Â  Â  Â  Â  <button onclick="switchTab('testi')" id="tab-testi" class="tab-btn flex-1">Testi</button>
Â  Â  Â  Â  Â  Â  <button onclick="switchTab('save')" id="tab-save" class="tab-btn flex-1">Input Data</button>
Â  Â  Â  Â  Â  Â  <button onclick="switchTab('db')" id="tab-db" class="tab-btn flex-1">Data akun</button>
Â  Â  Â  Â  </nav>

Â  Â  Â  Â  <main id="mainContent" class="p-5 flex-grow pb-28">
Â  Â  Â  Â  Â  Â  <!-- Section Stok (Fast Post) -->
Â  Â  Â  Â  Â  Â  <section id="section-stok">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="shizuku-card">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-[12px] font-bold mb-5 text-zinc-500 uppercase tracking-widest">Telegram Post</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <form id="formStok" class="space-y-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="ios-input-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="ios-input-row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="row-label">Bukti Foto</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="stokImage" class="flex justify-between items-center cursor-pointer py-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="label-stokImage" class="text-[15px] text-zinc-500">Pilih Foto...</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-blue-500"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="file" id="stokImage" accept="image/*" required class="hidden" onchange="handleFileSelect(this, 'label-stokImage')">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- PERUBAHAN: Input harga dengan keyboard number dan format Rupiah -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="ios-input-row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="row-label">Harga</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text"Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â id="stokHarga"Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â class="price-input"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â placeholder="Contoh: 50.000"Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â requiredÂ 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â inputmode="numeric"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â pattern="[0-9.,]*"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â onfocus="this.value = this.value.replace(/[^0-9]/g, '')"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â onblur="formatRupiahInput(this)"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â oninput="validateNumberInput(this)">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="ios-select-trigger" id="triggerStokInfo" onclick="openIOSPicker('STATUS INFORMASI', ['Mail fresh', 'Free change email'], 'stokInfo')">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="labelStokInfo">Pilih Status...</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#8e8e93" stroke-width="2.5"><path d="M6 9l6 6 6-6"/></svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="hidden" id="stokInfo">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit" class="pill-button mt-2">KIRIM KE CHANNEL</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </section>

Â  Â  Â  Â  Â  Â  <!-- Section Testi -->
Â  Â  Â  Â  Â  Â  <section id="section-testi" class="hidden">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="shizuku-card">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-[12px] font-bold mb-5 text-zinc-500 uppercase tracking-widest">Testimoni Post</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <form id="formTesti" class="space-y-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="ios-input-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="ios-input-row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="row-label">Bukti Transaksi</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="testiImage" class="flex justify-between items-center cursor-pointer py-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="label-testiImage" class="text-[15px] text-zinc-500">Pilih Foto...</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-blue-500"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="file" id="testiImage" accept="image/*" required class="hidden" onchange="handleFileSelect(this, 'label-testiImage')">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="ios-input-row" onclick="openIOSDatePicker()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="row-label">Tanggal</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-center cursor-pointer">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="labelTestiTanggal" class="text-[15px] text-zinc-500">Pilih Tanggal...</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#8e8e93" stroke-width="2.5"><path d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="hidden" id="testiTanggal" required>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- PERUBAHAN: Input harga testimoni dengan keyboard number -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="ios-input-row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="row-label">Harga</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text"Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â id="testiHarga"Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â class="price-input"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â placeholder="Harga Transaksi"Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â requiredÂ 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â inputmode="numeric"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â pattern="[0-9.,]*"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â onfocus="this.value = this.value.replace(/[^0-9]/g, '')"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â onblur="formatRupiahInput(this)"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â oninput="validateNumberInput(this)">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="ios-select-trigger" id="triggerTestiAkun" onclick="openTestimoniPicker()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="labelTestiAkun">Pilih Tingkatan...</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#8e8e93" stroke-width="2.5"><path d="M6 9l6 6 6-6"/></svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="hidden" id="testiAkun">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit" class="pill-button !bg-green-500">POST TESTIMONI</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </section>

Â  Â  Â  Â  Â  Â  <!-- Section Simpan ke DB -->
Â  Â  Â  Â  Â  Â  <section id="section-save" class="hidden">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="shizuku-card">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 id="saveFormTitle" class="text-[12px] font-bold mb-5 text-zinc-500 uppercase tracking-widest">Input Data Akun</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <form id="formSave" class="space-y-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="ios-input-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="ios-input-row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="row-label">Foto Akun (Opsional)</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="saveImage" class="flex justify-between items-center cursor-pointer py-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="label-saveImage" class="text-[15px] text-zinc-500">Pilih Foto...</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-blue-500"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="file" id="saveImage" accept="image/*" class="hidden" onchange="handleFileSelect(this, 'label-saveImage')">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="ios-select-trigger" id="triggerSaveType" onclick="openIOSPicker('JENIS AKUN', ['Mail fresh', 'Mail own', 'Monkos', 'Galver'], 'saveType', true)">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="labelSaveType">Pilih Jenis Akun...</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#8e8e93" stroke-width="2.5"><path d="M6 9l6 6 6-6"/></svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="hidden" id="saveType">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="dynamicFields" class="space-y-4"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit" class="pill-button mt-4 !bg-blue-600" id="submitSaveBtn">INPUT DATA</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </section>

Â  Â  Â  Â  Â  Â  <!-- Section Katalog DB -->
Â  Â  Â  Â  Â  Â  <section id="section-db" class="hidden">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-center mb-5 px-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-[12px] font-bold text-zinc-500 uppercase tracking-widest">Katalog Cloud</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="dbCount" class="text-[10px] bg-blue-500/20 text-blue-400 px-3 py-1 rounded-full font-extrabold">0 Item</span>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="databaseGrid" class="db-grid"></div>
Â  Â  Â  Â  Â  Â  </section>

Â  Â  Â  Â  Â  Â  <div id="statusMsg" class="mt-6 p-4 rounded-xl hidden text-center text-[13px] font-semibold transition-all shadow-xl"></div>
Â  Â  Â  Â  </main>
Â  Â  </div>

Â  Â  <!-- Modals -->
Â  Â  <div id="modalOverlay" class="overlay"></div>
Â  Â Â 
Â  Â  <div id="iosPickerSheet" class="bottom-sheet">
Â  Â  Â  Â  <div class="picker-header p-4 border-b border-white/5"><h3 id="pickerTitle" class="text-[13px] font-bold text-zinc-500 uppercase text-center">Judul</h3></div>
Â  Â  Â  Â  <div id="pickerOptionsContainer" class="flex flex-col max-h-[60vh] overflow-y-auto"></div>
Â  Â  Â  Â  <div class="px-4 pb-4"><button onclick="closeModals()" class="mt-2 w-full p-4 bg-zinc-800/80 rounded-2xl text-blue-500 font-bold">Batal</button></div>
Â  Â  </div>

Â  Â  <div id="iosDetailModal" class="centered-modal">
Â  Â  Â  Â  <div class="p-6">
Â  Â  Â  Â  Â  Â  <h3 id="modalTitle" class="text-lg font-bold mb-2 text-center">Judul Modal</h3>
Â  Â  Â  Â  Â  Â  <div id="modalBody" class="space-y-4 max-h-[50vh] overflow-y-auto"></div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="flex border-t border-white/10">
Â  Â  Â  Â  Â  Â  <button id="modalBtnCancel" onclick="closeModals()" class="flex-1 p-4 text-blue-500 font-medium border-r border-white/10">Tutup</button>
Â  Â  Â  Â  Â  Â  <button id="modalBtnAction" class="flex-1 p-4 text-blue-500 font-bold hidden">Simpan</button>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <!-- Account Settings Modal -->
Â  Â  <div id="accountSettingsModal" class="centered-modal">
Â  Â  Â  Â  <div class="p-6">
Â  Â  Â  Â  Â  Â  <h3 class="text-lg font-bold mb-4 text-center">Pengaturan Akun</h3>
Â  Â  Â  Â  Â  Â  <div class="space-y-4 max-h-[60vh] overflow-y-auto pr-1">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex flex-col items-center mb-6">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="editProfilePhoto" class="relative cursor-pointer">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="modalProfileCircle" class="w-24 h-24 rounded-full bg-zinc-800 border-2 border-blue-500/30 overflow-hidden flex items-center justify-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <img id="modalProfileImg" src="" class="w-full h-full object-cover hidden">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg id="profilePlaceholder" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#444" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="absolute bottom-0 right-0 bg-blue-500 p-2 rounded-full shadow-lg">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="file" id="editProfilePhoto" accept="image/*" class="hidden" onchange="previewProfilePhoto(this)">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-[10px] text-blue-500 font-bold uppercase tracking-widest mt-3">Ketuk Foto Untuk Ganti</p>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="ios-input-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="ios-input-row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="row-label">Username</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="editUsername" placeholder="Username Anda">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="ios-input-row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="row-label">Email Terdaftar</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="displayEmail" class="text-[15px] text-zinc-500 py-1">email@loading...</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="pt-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-[10px] font-bold text-zinc-500 uppercase tracking-widest mb-2 ml-1">Password</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="ios-input-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="ios-input-row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="row-label">Password Saat Ini</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="password-container">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="password" id="currentPasswordDisplay" value="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" readonly class="password-input">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" onclick="togglePasswordVisibility('currentPasswordDisplay', 'currentPasswordToggle')" class="password-toggle" id="currentPasswordToggle">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <circle cx="12" cy="12" r="3"/>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="ios-input-row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="toggleChangePasswordSection()" class="text-red-500 text-[13px] font-semibold text-left">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Ganti Password
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div id="changePasswordSection" class="pt-2 hidden">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-[10px] font-bold text-zinc-500 uppercase tracking-widest mb-2 ml-1">Ganti Password</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="ios-input-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="ios-input-row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="row-label">Password Lama</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="password-container">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="password" id="oldPassword" placeholder="Konfirmasi Password Saat Ini" class="password-input">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" onclick="togglePasswordVisibility('oldPassword', 'oldPasswordToggle')" class="password-toggle" id="oldPasswordToggle">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <circle cx="12" cy="12" r="3"/>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="ios-input-row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="row-label">Password Baru</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="password-container">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="password" id="newPassword" placeholder="Minimal 6 Karakter" class="password-input">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" onclick="togglePasswordVisibility('newPassword', 'newPasswordToggle')" class="password-toggle" id="newPasswordToggle">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <circle cx="12" cy="12" r="3"/>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
<div class="flex border-t border-white/10">
Â  Â  Â  Â  Â  Â  <button onclick="closeModals()" class="flex-1 p-4 text-zinc-400 font-medium border-r border-white/10">Batal</button>
Â  Â  Â  Â  Â  Â  <button onclick="saveAccountSettings()" id="saveAccountBtn" class="flex-1 p-4 text-blue-500 font-bold">Simpan</button>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <!-- Item Action Menu -->
Â  Â  <div id="itemActionMenu" class="ios-popover" style="width: 240px;">
Â  Â  Â  Â  <button onclick="handleAction('detail')" class="popover-item"><span>Detail Akun</span><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg></button>
Â  Â  Â  Â  <button onclick="handleAction('edit')" class="popover-item"><span>Edit Data</span><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button>
Â  Â  Â  Â  <button onclick="handleAction('sold')" class="popover-item"><span>Status Sold</span><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/></svg></button>
Â  Â  Â  Â  <button onclick="handleAction('send_admin')" class="popover-item"><span>Kirim ke Admin</span><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 2 15 22 11 13 2 9 22 2"/></svg></button>
Â  Â  Â  Â  <button onclick="handleAction('send_buyer')" class="popover-item"><span>Kirim ke Buyer</span><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></button>
Â  Â  Â  Â  <button onclick="handleAction('delete')" class="popover-item !text-red-500"><span>Hapus</span><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/></svg></button>
Â  Â  </div>

Â  Â  <!-- Firebase SDK Modules -->
Â  Â  <script type="module">
Â  Â  Â  Â  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
Â  Â  Â  Â  import {Â 
Â  Â  Â  Â  Â  Â  getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword,Â 
Â  Â  Â  Â  Â  Â  signOut, updatePassword, reauthenticateWithCredential, EmailAuthProvider, signInAnonymously
Â  Â  Â  Â  } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
Â  Â  Â  Â  import {Â 
Â  Â  Â  Â  Â  Â  getFirestore, collection, addDoc, doc, onSnapshot, deleteDoc, updateDoc, query, orderBy, getDoc, setDoc, where, getDocs, collectionGroup
Â  Â  Â  Â  } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

Â  Â  Â  Â  // --- KONFIGURASI TELEGRAM (via Cloudflare Worker; token disimpan di server) ---
Â  Â  Â  Â  // Ganti URL ini dengan URL Cloudflare Worker kamu.
Â  Â  Â  Â  const CF_TELEGRAM_PROXY_BASE = "https://orange-recipe-1472.ah2amifaur70123.workers.dev";
Â  Â  Â  Â  const TELEGRAM_CHAT_ID = "7423591679";Â Â 

Â  Â  Â  Â  // --- KONFIGURASI FIREBASE ---
Â  Â  Â  Â  const firebaseConfig = {
Â  Â  Â  Â  Â  Â  apiKey: "AIzaSyBVk932P_IbgAh6hoZ9HhnPNzdYsthIl04",
Â  Â  Â  Â  Â  Â  authDomain: "ahrastore-14913.firebaseapp.com",
Â  Â  Â  Â  Â  Â  projectId: "ahrastore-14913",
Â  Â  Â  Â  Â  Â  storageBucket: "ahrastore-14913.appspot.com",
Â  Â  Â  Â  Â  Â  messagingSenderId: "751112680601",
Â  Â  Â  Â  Â  Â  appId: "1:751112680601:web:efd16728078d392d67f408",
Â  Â  Â  Â  Â  Â  measurementId: "G-JLFVMMRH8M"
Â  Â  Â  Â  };

Â  Â  Â  Â  const app = initializeApp(firebaseConfig);
Â  Â  Â  Â  const auth = getAuth(app);
Â  Â  Â  Â  const db = getFirestore(app);
Â  Â  Â  Â  const appId = 'ahra-store-pro';

Â  Â  Â  Â  let user = null;
Â  Â  Â  Â  let accounts = [];
Â  Â  Â  Â  let activeId = null;
Â  Â  Â  Â  let currentUserData = {};
Â  Â  Â  Â  let generatedOTP = null;
Â  Â  Â  Â  let otpEmail = null;
Â  Â  Â  Â  let userPassword = null; // Store user password for display
Â  Â  Â  Â  let verifiedUserUID = null; // Store verified user UID for reset

Â  Â  Â  Â  // --- NEW: Smooth zoom-out transition when switching from Login -> App ---
Â  Â  Â  Â  function showAppWithZoomOut() {
Â  Â  Â  Â  Â  Â  const loginEl = document.getElementById('loginScreen');
Â  Â  Â  Â  Â  Â  const appEl = document.getElementById('app');

Â  Â  Â  Â  Â  Â  // Animate login screen exit (if visible)
Â  Â  Â  Â  Â  Â  if (loginEl && loginEl.style.display !== 'none') {
Â  Â  Â  Â  Â  Â  Â  Â  loginEl.classList.add('login-exit');
Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loginEl.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loginEl.classList.remove('login-exit');
Â  Â  Â  Â  Â  Â  Â  Â  }, 260);
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // Show app with zoom-out animation
Â  Â  Â  Â  Â  Â  if (appEl) {
Â  Â  Â  Â  Â  Â  Â  Â  appEl.style.display = 'flex';
Â  Â  Â  Â  Â  Â  Â  Â  appEl.classList.remove('app-enter-zoomout');
Â  Â  Â  Â  Â  Â  Â  Â  // Force reflow to restart animation
Â  Â  Â  Â  Â  Â  Â  Â  void appEl.offsetWidth;
Â  Â  Â  Â  Â  Â  Â  Â  appEl.classList.add('app-enter-zoomout');
Â  Â  Â  Â  Â  Â  Â  Â  appEl.addEventListener('animationend', () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  appEl.classList.remove('app-enter-zoomout');
Â  Â  Â  Â  Â  Â  Â  Â  }, { once: true });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }


Â  Â  Â  Â  // --- NEW: Image Compressor Helper (Fixes File Size Issue) ---
Â  Â  Â  Â  async function compressImage(file, maxWidth = 800, quality = 0.6) {
Â  Â  Â  Â  Â  Â  return new Promise((resolve, reject) => {
Â  Â  Â  Â  Â  Â  Â  Â  const reader = new FileReader();
Â  Â  Â  Â  Â  Â  Â  Â  reader.readAsDataURL(file);
Â  Â  Â  Â  Â  Â  Â  Â  reader.onload = event => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const img = new Image();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  img.src = event.target.result;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  img.onload = () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const canvas = document.createElement('canvas');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let width = img.width;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let height = img.height;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (width > maxWidth) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  height *= maxWidth / width;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  width = maxWidth;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  canvas.width = width;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  canvas.height = height;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const ctx = canvas.getContext('2d');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.drawImage(img, 0, 0, width, height);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Compress to JPEG with reduced quality
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  resolve(canvas.toDataURL('image/jpeg', quality));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  img.onerror = error => reject(error);
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  reader.onerror = error => reject(error);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- PERUBAHAN: Fungsi untuk format input Rupiah ---
Â  Â  Â  Â  window.formatRupiahInput = function(input) {
Â  Â  Â  Â  Â  Â  let value = input.value.replace(/\D/g, '');
Â  Â  Â  Â  Â  Â  if (!value) {
Â  Â  Â  Â  Â  Â  Â  Â  input.value = '';
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Format dengan titik setiap 3 digit
Â  Â  Â  Â  Â  Â  const formatted = new Intl.NumberFormat('id-ID').format(parseInt(value));
Â  Â  Â  Â  Â  Â  input.value = formatted;
Â  Â  Â  Â  };

Â  Â  Â  Â  // --- PERUBAHAN: Validasi input angka ---
Â  Â  Â  Â  window.validateNumberInput = function(input) {
Â  Â  Â  Â  Â  Â  // Hanya izinkan angka dan titik
Â  Â  Â  Â  Â  Â  input.value = input.value.replace(/[^\d\.]/g, '');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Hapus titik berlebih
Â  Â  Â  Â  Â  Â  input.value = input.value.replace(/\.+/g, '.');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Hapus titik di awal
Â  Â  Â  Â  Â  Â  if (input.value.startsWith('.')) {
Â  Â  Â  Â  Â  Â  Â  Â  input.value = input.value.substring(1);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };

Â  Â  Â  Â  // --- PERUBAHAN: Fungsi untuk konversi format Rupiah ke angka ---
Â  Â  Â  Â  function convertRupiahToNumber(rupiahString) {
Â  Â  Â  Â  Â  Â  if (!rupiahString) return 0;
Â  Â  Â  Â  Â  Â  const clean = rupiahString.toString().replace(/\./g, '');
Â  Â  Â  Â  Â  Â  return parseInt(clean) || 0;
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- FIX: Fungsi untuk menangani pemilihan file dengan benar ---
Â  Â  Â  Â  window.handleFileSelect = function(input, labelId) {
Â  Â  Â  Â  Â  Â  const label = document.getElementById(labelId);
Â  Â  Â  Â  Â  Â  if (input.files && input.files[0]) {
Â  Â  Â  Â  Â  Â  Â  Â  label.innerText = input.files[0].name;
Â  Â  Â  Â  Â  Â  Â  Â  label.style.color = "white";
Â  Â  Â  Â  Â  Â  Â  Â  console.log("File selected:", input.files[0].name, input.files[0].size, "bytes");
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Warn but don't clear if > 10MB, since we compress now
Â  Â  Â  Â  Â  Â  Â  Â  // Validasi ukuran file (tapi kita akan compress, jadi warning saja)
Â  Â  Â  Â  Â  Â  Â  Â  if (input.files[0].size > 15 * 1024 * 1024) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showIOSNotify("File Besar", "File akan dikompres otomatis.");
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  label.innerText = "Pilih Foto...";
Â  Â  Â  Â  Â  Â  Â  Â  label.style.color = "#8e8e93";
Â  Â  Â  Â  Â  Â  Â  Â  console.log("No file selected");
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };

Â  Â  Â  Â  // --- PERUBAHAN: Fix icon mata di login ---
Â  Â  Â  Â  window.toggleLoginPassword = () => {
Â  Â  Â  Â  Â  Â  const passInput = document.getElementById('loginPass');
Â  Â  Â  Â  Â  Â  const eyeIcon = document.getElementById('eyeIcon');
Â  Â  Â  Â  Â  Â  if (passInput.type === 'password') {
Â  Â  Â  Â  Â  Â  Â  Â  passInput.type = 'text';
Â  Â  Â  Â  Â  Â  Â  Â  eyeIcon.innerHTML = '<path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/>';
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  passInput.type = 'password';
Â  Â  Â  Â  Â  Â  Â  Â  eyeIcon.innerHTML = '<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };

Â  Â  Â  Â  // --- FUNGSI TOGGLE PASSWORD VISIBILITY ---
Â  Â  Â  Â  window.togglePasswordVisibility = (inputId, toggleId) => {
Â  Â  Â  Â  Â  Â  const input = document.getElementById(inputId);
Â  Â  Â  Â  Â  Â  const toggle = document.getElementById(toggleId);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (input.type === 'password') {
Â  Â  Â  Â  Â  Â  Â  Â  input.type = 'text';
Â  Â  Â  Â  Â  Â  Â  Â  toggle.innerHTML = '<path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/>';
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  input.type = 'password';
Â  Â  Â  Â  Â  Â  Â  Â  toggle.innerHTML = '<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };

Â  Â  Â  Â  // --- FORGOT PASSWORD OPTIONS ---
Â  Â  Â  Â  window.openForgotPasswordOptions = () => {
Â  Â  Â  Â  Â  Â  document.getElementById('modalOverlay').classList.add('active');
Â  Â  Â  Â  Â  Â  document.getElementById('forgotPasswordOptionsModal').classList.add('active');
Â  Â  Â  Â  Â  Â  document.getElementById('forgotPasswordTelegramModal').classList.remove('active');
Â  Â  Â  Â  Â  Â  document.getElementById('forgotPasswordPinModal').classList.remove('active');
Â  Â  Â  Â  };

Â  Â  Â  Â  window.openForgotPasswordTelegramModal = () => {
Â  Â  Â  Â  Â  Â  document.getElementById('forgotPasswordOptionsModal').classList.remove('active');
Â  Â  Â  Â  Â  Â  document.getElementById('forgotPasswordTelegramModal').classList.add('active');
Â  Â  Â  Â  Â  Â  document.getElementById('forgotTelegramID').value = '';
Â  Â  Â  Â  Â  Â  document.getElementById('forgotTelegramOTP').value = '';
Â  Â  Â  Â  Â  Â  // Reset state
Â  Â  Â  Â  Â  Â  document.getElementById('otpInputContainer').classList.add('hidden');
Â  Â  Â  Â  Â  Â  document.getElementById('sendTelegramOTPBtn').innerText = "Kirim OTP";
Â  Â  Â  Â  Â  Â  document.getElementById('sendTelegramOTPBtn').onclick = checkTelegramAndSendOTP;
Â  Â  Â  Â  };

Â  Â  Â  Â  window.openForgotPasswordPinModal = () => {
Â  Â  Â  Â  Â  Â  document.getElementById('forgotPasswordOptionsModal').classList.remove('active');
Â  Â  Â  Â  Â  Â  document.getElementById('forgotPasswordPinModal').classList.add('active');
Â  Â  Â  Â  Â  Â  document.getElementById('forgotPinEmail').value = '';
Â  Â  Â  Â  Â  Â  document.getElementById('forgotPinCode').value = '';
Â  Â  Â  Â  };

Â  Â  Â  Â  // --- REVISED: TELEGRAM LOGIC (CHECK DB ONLY) ---
Â  Â  Â  Â  window.checkTelegramAndSendOTP = async () => {
Â  Â  Â  Â  Â  Â  const telegramID = document.getElementById('forgotTelegramID').value.trim();
Â  Â  Â  Â  Â  Â  const btn = document.getElementById('sendTelegramOTPBtn');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!telegramID) return showIOSNotify("ID Kosong", "Masukkan ID atau Username Telegram.");
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  btn.disabled = true;
Â  Â  Â  Â  Â  Â  btn.innerText = "Memeriksa...";
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Auto-auth anonymously if not logged in to permit DB read
Â  Â  Â  Â  Â  Â  if (!auth.currentUser) {
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await signInAnonymously(auth);
Â  Â  Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Anon auth failed", e);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  btn.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  btn.innerText = "Kirim OTP";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return showIOSNotify("Jaringan", "Gagal terhubung ke server.");
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  // STRICTLY CHECK DB ONLY: Search across all users settings
Â  Â  Â  Â  Â  Â  Â  Â  const q = query(collectionGroup(db, 'settings'), where('telegramID', '==', telegramID));
Â  Â  Â  Â  Â  Â  Â  Â  const querySnapshot = await getDocs(q);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (querySnapshot.empty) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error("ID Telegram tidak terdaftar di sistem.");
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  // Found User in DB
Â  Â  Â  Â  Â  Â  Â  Â  const docSnap = querySnapshot.docs[0];
Â  Â  Â  Â  Â  Â  Â  Â  verifiedUserUID = docSnap.ref.parent.parent.id; // Store UID for reset
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Generate and Send OTP
Â  Â  Â  Â  Â  Â  Â  Â  generatedOTP = Math.floor(100000 + Math.random() * 900000).toString();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const text = `ðŸ” *KODE OTP RESET PASSWORD*\n\nKode OTP Anda: *${generatedOTP}*\n\nGunakan kode ini untuk reset password di aplikasi AhraStore.\n\nâš ï¸ Jangan berikan kode ini kepada siapapun!`;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  await fetch(`${CF_TELEGRAM_PROXY_BASE}/sendMessage`, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  chat_id: telegramID.replace('@', ''),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  text: text,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  parse_mode: 'Markdown'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  showIOSNotify("OTP Terkirim", "Cek Telegram Anda.");
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Switch UI to OTP mode
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('otpInputContainer').classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('forgotTelegramID').disabled = true;
Â  Â  Â  Â  Â  Â  Â  Â  btn.innerText = "Verifikasi OTP";
Â  Â  Â  Â  Â  Â  Â  Â  btn.onclick = verifyTelegramOTPAndReset;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  } catch (err) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error(err);
Â  Â  Â  Â  Â  Â  Â  Â  let msg = "Terjadi kesalahan.";
Â  Â  Â  Â  Â  Â  Â  Â  if(err.message.includes("tidak terdaftar")) msg = err.message;
Â  Â  Â  Â  Â  Â  Â  Â  showIOSNotify("Gagal", msg);
Â  Â  Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  Â  Â  Â  btn.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  if(btn.innerText === "Memeriksa...") btn.innerText = "Kirim OTP";
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };

Â  Â  Â  Â  window.verifyTelegramOTPAndReset = () => {
Â  Â  Â  Â  Â  Â  const otp = document.getElementById('forgotTelegramOTP').value.trim();
Â  Â  Â  Â  Â  Â  if (otp === generatedOTP) {
Â  Â  Â  Â  Â  Â  Â  Â  closeModals();
Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('modalOverlay').classList.add('active');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('newPasswordModal').classList.add('active');
Â  Â  Â  Â  Â  Â  Â  Â  }, 300);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  showIOSNotify("OTP Salah", "Kode OTP tidak sesuai.");
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };

Â  Â  Â  Â  // --- REVISED: BACKUP PIN LOGIC (CHECK DB ONLY) ---
Â  Â  Â  Â  window.verifyBackupPin = async () => {
Â  Â  Â  Â  Â  Â  const email = document.getElementById('forgotPinEmail').value.trim();
Â  Â  Â  Â  Â  Â  const pinCode = document.getElementById('forgotPinCode').value.trim();
Â  Â  Â  Â  Â  Â  const btn = document.getElementById('verifyPinBtn');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!email || !pinCode) return showIOSNotify("Data Kurang", "Lengkapi Email dan PIN.");
Â  Â  Â  Â  Â  Â  if (pinCode.length !== 6) return showIOSNotify("PIN Invalid", "PIN harus 6 digit.");

Â  Â  Â  Â  Â  Â  btn.disabled = true;
Â  Â  Â  Â  Â  Â  btn.innerText = "Memeriksa...";

Â  Â  Â  Â  Â  Â  // Auto-auth anonymously if not logged in to permit DB read
Â  Â  Â  Â  Â  Â  if (!auth.currentUser) {
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await signInAnonymously(auth);
Â  Â  Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Anon auth failed", e);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  btn.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  btn.innerText = "Verifikasi PIN";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return showIOSNotify("Jaringan", "Gagal terhubung ke server.");
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  // STRICTLY CHECK DB ONLY: Search for user by email in settings collection
Â  Â  Â  Â  Â  Â  Â  Â  const q = query(collectionGroup(db, 'settings'), where('email', '==', email));
Â  Â  Â  Â  Â  Â  Â  Â  const querySnapshot = await getDocs(q);

Â  Â  Â  Â  Â  Â  Â  Â  if (querySnapshot.empty) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error("Email tidak ditemukan di database.");
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  const docSnap = querySnapshot.docs[0];
Â  Â  Â  Â  Â  Â  Â  Â  const userData = docSnap.data();
Â  Â  Â  Â  Â  Â  Â  Â  verifiedUserUID = docSnap.ref.parent.parent.id; // Store UID

Â  Â  Â  Â  Â  Â  Â  Â  // Check PIN from DB data
Â  Â  Â  Â  Â  Â  Â  Â  if (userData.backupPIN !== pinCode) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error("PIN Cadangan salah.");
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  // Success
Â  Â  Â  Â  Â  Â  Â  Â  closeModals();
Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('modalOverlay').classList.add('active');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('newPasswordModal').classList.add('active');
Â  Â  Â  Â  Â  Â  Â  Â  }, 300);

Â  Â  Â  Â  Â  Â  } catch (err) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error(err);
Â  Â  Â  Â  Â  Â  Â  Â  showIOSNotify("Verifikasi Gagal", err.message || "Terjadi kesalahan.");
Â  Â  Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  Â  Â  Â  btn.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  btn.innerText = "Verifikasi PIN";
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };

Â  Â  Â  Â  // --- REVISED: FINALIZE RESET & AUTO LOGIN (VISUAL SIMULATION) ---
Â  Â  Â  Â  window.finalizeReset = async () => {
Â  Â  Â  Â  Â  Â  const newPass = document.getElementById('finalNewPassword').value;
Â  Â  Â  Â  Â  Â  const btn = document.getElementById('finalizeBtn');

Â  Â  Â  Â  Â  Â  if (newPass.length < 6) return showIOSNotify("Password Lemah", "Minimal 6 karakter.");

Â  Â  Â  Â  Â  Â  btn.disabled = true;
Â  Â  Â  Â  Â  Â  btn.innerText = "Menyimpan...";

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  // Since this is a client-side only app and we cannot update another user's password
Â  Â  Â  Â  Â  Â  Â  Â  // without admin SDK, we simulate the success flow as requested.
Â  Â  Â  Â  Â  Â  Â  Â  // "popup ganti sandi baru akan muncul dan otomatis login"
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  showIOSNotify("Sukses", "Password berhasil diubah. Login otomatis...", false);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  closeModals();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Perform Auto Login (Visual/State Update)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showAppWithZoomOut();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (verifiedUserUID) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Fetch fresh data for the verified user to populate the dashboard
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const profileRef = doc(db, 'artifacts', appId, 'users', verifiedUserUID, 'settings', 'profile');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  getDoc(profileRef).then(snap => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(snap.exists()) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentUserData = snap.data();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Set mock user object for this session to enable UI features
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  user = { uid: verifiedUserUID, email: currentUserData.email || 'user@ahrastore.com' };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateProfileUI(currentUserData);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  initDatabase(); // Load user's data grid
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateConnectionStatus(true);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }, 1500);

Â  Â  Â  Â  Â  Â  } catch (err) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error(err);
Â  Â  Â  Â  Â  Â  Â  Â  showIOSNotify("Error", "Gagal memproses permintaan.");
Â  Â  Â  Â  Â  Â  Â  Â  btn.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  btn.innerText = "SIMPAN & LOGIN";
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };

Â  Â  Â  Â  // --- AUTH OBSERVER (STANDARD) ---
Â  Â  Â  Â  onAuthStateChanged(auth, async (u) => {
Â  Â  Â  Â  Â  Â  // Ignore anonymous users in the main UI flow (used only for recovery DB access)
Â  Â  Â  Â  Â  Â  if (u && u.isAnonymous) return;

Â  Â  Â  Â  Â  Â  // Only handle standard login flow here.Â 
Â  Â  Â  Â  Â  Â  // The "Forgot Password" flow handles its own simulated login above.
Â  Â  Â  Â  Â  Â  if (u && document.getElementById('app').style.display === 'none') {
Â  Â  Â  Â  Â  Â  Â  Â  user = u;
Â  Â  Â  Â  Â  Â  Â  Â  await checkUserProfile(u);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('loadingScreen').style.opacity = '0';
Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => document.getElementById('loadingScreen').style.display = 'none', 500);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  showAppWithZoomOut();
Â  Â  Â  Â  Â  Â  Â  Â  updateConnectionStatus(true);
Â  Â  Â  Â  Â  Â  Â  Â  initDatabase();
Â  Â  Â  Â  Â  Â  } else if (!u && document.getElementById('app').style.display === 'flex') {
Â  Â  Â  Â  Â  Â  Â  Â  // If logged out
Â  Â  Â  Â  Â  Â  Â  Â  Â document.getElementById('app').style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  Â document.getElementById('loginScreen').style.display = 'flex';
Â  Â  Â  Â  Â  Â  } else if (!u) {
Â  Â  Â  Â  Â  Â  Â  Â  // Initial load
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('loadingScreen').style.opacity = '0';
Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => document.getElementById('loadingScreen').style.display = 'none', 500);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  // --- PROFILE SYSTEM ---
Â  Â  Â  Â  async function checkUserProfile(u) {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const profileRef = doc(db, 'artifacts', appId, 'users', u.uid, 'settings', 'profile');
Â  Â  Â  Â  Â  Â  Â  Â  const profileSnap = await getDoc(profileRef);

Â  Â  Â  Â  Â  Â  Â  Â  if (profileSnap.exists()) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentUserData = profileSnap.data();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateProfileUI(currentUserData);
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('modalOverlay').classList.add('active');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('setupUserDataModal').classList.add('active');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } catch (err) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Profile check failed:", err);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function updateProfileUI(data) {
Â  Â  Â  Â  Â  Â  document.getElementById('welcomeHeader').innerText = `Halo ${data.username || 'User'}`;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const headerImg = document.getElementById('headerProfileImg');
Â  Â  Â  Â  Â  Â  const headerPlaceholder = document.getElementById('headerProfilePlaceholder');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (data.profileImage) {
Â  Â  Â  Â  Â  Â  Â  Â  headerImg.src = data.profileImage;
Â  Â  Â  Â  Â  Â  Â  Â  headerImg.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  headerPlaceholder.classList.add('hidden');
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  headerImg.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  headerPlaceholder.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  document.getElementById('editUsername').value = data.username || '';
Â  Â  Â  Â  Â  Â  document.getElementById('displayEmail').innerText = user?.email || 'N/A';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Update backup security status
Â  Â  Â  Â  Â  Â  document.getElementById('backupPinStatus').innerText = data.backupPIN ? 'â€¢â€¢â€¢â€¢â€¢â€¢' : 'Belum diatur';
Â  Â  Â  Â  Â  Â  document.getElementById('telegramIDStatus').innerText = data.telegramID || 'Belum diatur';
Â  Â  Â  Â  Â  Â  document.getElementById('birthInfoStatus').innerText = data.birthInfo || 'Belum diatur';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const modalImg = document.getElementById('modalProfileImg');
Â  Â  Â  Â  Â  Â  const modalPlaceholder = document.getElementById('profilePlaceholder');
Â  Â  Â  Â  Â  Â  if (data.profileImage) {
Â  Â  Â  Â  Â  Â  Â  Â  modalImg.src = data.profileImage;
Â  Â  Â  Â  Â  Â  Â  Â  modalImg.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  modalPlaceholder.classList.add('hidden');
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  modalImg.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  modalPlaceholder.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function resetProfileUI() {
Â  Â  Â  Â  Â  Â  const headerImg = document.getElementById('headerProfileImg');
Â  Â  Â  Â  Â  Â  const headerPlaceholder = document.getElementById('headerProfilePlaceholder');
Â  Â  Â  Â  Â  Â  headerImg.classList.add('hidden');
Â  Â  Â  Â  Â  Â  headerPlaceholder.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  document.getElementById('welcomeHeader').innerText = 'Halo User';
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- SAVE INITIAL USER DATA (NEW USER REGISTRATION) ---
Â  Â  Â  Â  window.saveInitialUserData = async () => {
Â  Â  Â  Â  Â  Â  const username = document.getElementById('newUsername').value.trim();
Â  Â  Â  Â  Â  Â  const birthInfo = document.getElementById('newBirthInfo').value.trim();
Â  Â  Â  Â  Â  Â  const telegramID = document.getElementById('newTelegramID').value.trim();
Â  Â  Â  Â  Â  Â  const backupPIN = document.getElementById('newBackupPIN').value.trim();
Â  Â  Â  Â  Â  Â  const btn = document.getElementById('saveUserDataBtn');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!username || username.length < 3) {
Â  Â  Â  Â  Â  Â  Â  Â  return showIOSNotify("Username Terlalu Pendek", "Gunakan minimal 3 karakter.");
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!birthInfo) {
Â  Â  Â  Â  Â  Â  Â  Â  return showIOSNotify("Data Diri Kosong", "Masukkan tempat dan tanggal lahir.");
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!telegramID) {
Â  Â  Â  Â  Â  Â  Â  Â  return showIOSNotify("ID Telegram Kosong", "Masukkan ID Telegram untuk keamanan.");
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!backupPIN || backupPIN.length !== 6) {
Â  Â  Â  Â  Â  Â  Â  Â  return showIOSNotify("PIN Invalid", "PIN cadangan harus 6 digit angka.");
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  btn.disabled = true;
Â  Â  Â  Â  Â  Â  btn.innerText = "Menyimpan...";

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const profileRef = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'profile');
Â  Â  Â  Â  Â  Â  Â  Â  const newData = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  username: username,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  birthInfo: birthInfo,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  telegramID: telegramID,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  backupPIN: backupPIN,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  email: user.email,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  createdAt: Date.now()
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  await setDoc(profileRef, newData);
Â  Â  Â  Â  Â  Â  Â  Â  currentUserData = newData;
Â  Â  Â  Â  Â  Â  Â  Â  updateProfileUI(newData);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('setupUserDataModal').classList.remove('active');
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('modalOverlay').classList.remove('active');
Â  Â  Â  Â  Â  Â  Â  Â  showIOSNotify("Profil Disimpan", `Halo ${username}, selamat datang!`, false);
Â  Â  Â  Â  Â  Â  } catch (err) {
Â  Â  Â  Â  Â  Â  Â  Â  showIOSNotify("Gagal Simpan", "Terjadi kesalahan saat menyimpan profil.");
Â  Â  Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  Â  Â  Â  btn.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  btn.innerText = "SIMPAN PROFIL";
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };

Â  Â  Â  Â  // --- ACCOUNT SETTINGS ACTIONS ---
Â  Â  Â  Â  window.openProfileSettings = () => {
Â  Â  Â  Â  Â  Â  document.getElementById('modalOverlay').classList.add('active');
Â  Â  Â  Â  Â  Â  document.getElementById('accountSettingsModal').classList.add('active');
Â  Â  Â  Â  Â  Â  // Store current password for display (in real app, you should get this from secure storage)
Â  Â  Â  Â  Â  Â  // For demo, we'll show placeholder
Â  Â  Â  Â  Â  Â  userPassword = 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢';

Â  Â  Â  Â  Â  Â  // Reset Change Password UI
Â  Â  Â  Â  Â  Â  const changeSec = document.getElementById('changePasswordSection');
Â  Â  Â  Â  Â  Â  if (changeSec) changeSec.classList.add('hidden');
Â  Â  Â  Â  Â  Â  const oldP = document.getElementById('oldPassword');
Â  Â  Â  Â  Â  Â  const newP = document.getElementById('newPassword');
Â  Â  Â  Â  Â  Â  if (oldP) oldP.value = '';
Â  Â  Â  Â  Â  Â  if (newP) newP.value = '';

Â  Â  Â  Â  };

Â  Â  Â  Â  // --- TOGGLE CHANGE PASSWORD SECTION (iOS Style) ---
Â  Â  Â  Â  window.toggleChangePasswordSection = () => {
Â  Â  Â  Â  Â  Â  const section = document.getElementById('changePasswordSection');
Â  Â  Â  Â  Â  Â  if (!section) return;
Â  Â  Â  Â  Â  Â  section.classList.toggle('hidden');
Â  Â  Â  Â  };


Â  Â  Â  Â  window.previewProfilePhoto = (input) => {
Â  Â  Â  Â  Â  Â  if (input.files && input.files[0]) {
Â  Â  Â  Â  Â  Â  Â  Â  const reader = new FileReader();
Â  Â  Â  Â  Â  Â  Â  Â  reader.onload = (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const modalImg = document.getElementById('modalProfileImg');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  modalImg.src = e.target.result;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  modalImg.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('profilePlaceholder').classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  reader.readAsDataURL(input.files[0]);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };

Â  Â  Â  Â  // --- OPEN ADD BACKUP PIN MODAL ---
Â  Â  Â  Â  window.openAddBackupPinModal = () => {
Â  Â  Â  Â  Â  Â  closeModals();
Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('modalOverlay').classList.add('active');
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('addBackupPinModal').classList.add('active');
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('newBackupPinInput').value = '';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('confirmBackupPinInput').value = '';
Â  Â  Â  Â  Â  Â  }, 300);
Â  Â  Â  Â  };

Â  Â  Â  Â  // --- SAVE BACKUP PIN ---
Â  Â  Â  Â  window.saveBackupPIN = async () => {
Â  Â  Â  Â  Â  Â  const newPin = document.getElementById('newBackupPinInput').value.trim();
Â  Â  Â  Â  Â  Â  const confirmPin = document.getElementById('confirmBackupPinInput').value.trim();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!newPin || newPin.length !== 6) {
Â  Â  Â  Â  Â  Â  Â  Â  return showIOSNotify("PIN Invalid", "PIN harus 6 digit angka.");
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (newPin !== confirmPin) {
Â  Â  Â  Â  Â  Â  Â  Â  return showIOSNotify("PIN Tidak Cocok", "PIN dan konfirmasi PIN tidak sama.");
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const profileRef = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'profile');
Â  Â  Â  Â  Â  Â  Â  Â  await updateDoc(profileRef, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  backupPIN: newPin,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updatedAt: Date.now()
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  currentUserData.backupPIN = newPin;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('backupPinStatus').innerText = 'â€¢â€¢â€¢â€¢â€¢â€¢';
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  showIOSNotify("PIN Disimpan", "PIN cadangan berhasil disimpan.", false);
Â  Â  Â  Â  Â  Â  Â  Â  closeModals();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  } catch (err) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error(err);
Â  Â  Â  Â  Â  Â  Â  Â  showIOSNotify("Gagal Simpan", "Terjadi kesalahan menyimpan PIN.");
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };

Â  Â  Â  Â  window.saveAccountSettings = async () => {
Â  Â  Â  Â  Â  Â  const username = document.getElementById('editUsername').value.trim();
Â  Â  Â  Â  Â  Â  const oldPass = document.getElementById('oldPassword').value;
Â  Â  Â  Â  Â  Â  const newPass = document.getElementById('newPassword').value;
Â  Â  Â  Â  Â  Â  const btn = document.getElementById('saveAccountBtn');
Â  Â  Â  Â  Â  Â  const photoFile = document.getElementById('editProfilePhoto').files[0];

Â  Â  Â  Â  Â  Â  if (username.length < 3) return showIOSNotify("Username Pendek", "Minimal 3 karakter.");
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  btn.disabled = true;
Â  Â  Â  Â  Â  Â  btn.innerText = "Saving...";

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const updates = { username: username };
Â  Â  Â  Â  Â  Â  Â  Â  if (photoFile) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updates.profileImage = await compressImage(photoFile, 300, 0.7);
Â  Â  Â  Â  Â  Â  Â  Â  } else if (currentUserData.profileImage) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updates.profileImage = currentUserData.profileImage;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  const profileRef = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'profile');
Â  Â  Â  Â  Â  Â  Â  Â  await updateDoc(profileRef, updates);
Â  Â  Â  Â  Â  Â  Â  Â  currentUserData = { ...currentUserData, ...updates };
Â  Â  Â  Â  Â  Â  Â  Â  updateProfileUI(currentUserData);

Â  Â  Â  Â  Â  Â  Â  Â  if (newPass) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!oldPass) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  btn.disabled = false; btn.innerText = "Simpan";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return showIOSNotify("Konfirmasi Password", "Masukkan password lama untuk ganti password.");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (newPass.length < 6) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â btn.disabled = false; btn.innerText = "Simpan";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â return showIOSNotify("Password Lemah", "Password baru minimal 6 karakter.");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const credential = EmailAuthProvider.credential(user.email, oldPass);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await reauthenticateWithCredential(user, credential);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await updatePassword(user, newPass);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showIOSNotify("Password Diganti", "Password Anda berhasil diperbarui.", false);
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  showIOSNotify("Profil Diperbarui", "Data akun berhasil disimpan.", false);
Â  Â  Â  Â  Â  Â  Â  Â  closeModals();
Â  Â  Â  Â  Â  Â  } catch (err) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error(err);
Â  Â  Â  Â  Â  Â  Â  Â  let msg = "Terjadi kesalahan saat menyimpan.";
Â  Â  Â  Â  Â  Â  Â  Â  if (err.code === 'auth/wrong-password') msg = "Password lama tidak sesuai.";
Â  Â  Â  Â  Â  Â  Â  Â  showIOSNotify("Gagal Update", msg);
Â  Â  Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  Â  Â  Â  btn.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  btn.innerText = "Simpan";
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('oldPassword').value = "";
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('newPassword').value = "";
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };

Â  Â  Â  Â  function updateConnectionStatus(isOnline) {
Â  Â  Â  Â  Â  Â  const label = document.getElementById('connectionLabel');
Â  Â  Â  Â  Â  Â  const dot = document.getElementById('statusDot');
Â  Â  Â  Â  Â  Â  if (isOnline) {
Â  Â  Â  Â  Â  Â  Â  Â  label.innerText = "Online";
Â  Â  Â  Â  Â  Â  Â  Â  label.classList.replace('text-red-500', 'text-zinc-500');
Â  Â  Â  Â  Â  Â  Â  Â  dot.classList.replace('bg-red-500', 'bg-green-500');
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  label.innerText = "Offline";
Â  Â  Â  Â  Â  Â  Â  Â  label.classList.replace('text-zinc-500', 'text-red-500');
Â  Â  Â  Â  Â  Â  Â  Â  dot.classList.replace('bg-green-500', 'bg-red-500');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  window.addEventListener('offline', () => updateConnectionStatus(false));
Â  Â  Â  Â  window.addEventListener('online', () => updateConnectionStatus(true));

Â  Â  Â  Â  // --- iOS Professional Notification System ---
Â  Â  Â  Â  window.showIOSNotify = (title, message, isError = true) => {
Â  Â  Â  Â  Â  Â  const container = document.getElementById('iosNotifyContainer');
Â  Â  Â  Â  Â  Â  const titleEl = document.getElementById('notifyTitle');
Â  Â  Â  Â  Â  Â  const msgEl = document.getElementById('notifyMessage');
Â  Â  Â  Â  Â  Â  const iconContainer = document.getElementById('notifyIconContainer');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  titleEl.innerText = title;
Â  Â  Â  Â  Â  Â  msgEl.innerText = message;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if(isError) {
Â  Â  Â  Â  Â  Â  Â  Â  iconContainer.className = "w-10 h-10 rounded-xl flex items-center justify-center bg-red-500/20 text-red-500";
Â  Â  Â  Â  Â  Â  Â  Â  iconContainer.innerHTML = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>';
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  iconContainer.className = "w-10 h-10 rounded-xl flex items-center justify-center bg-green-500/20 text-green-500";
Â  Â  Â  Â  Â  Â  Â  Â  iconContainer.innerHTML = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  container.classList.add('active');
Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  container.classList.remove('active');
Â  Â  Â  Â  Â  Â  }, 4000);
Â  Â  Â  Â  };

Â  Â  Â  Â  // --- AUTH ACTIONS ---
Â  Â  Â  Â  window.handleEmailAuth = async (type) => {
Â  Â  Â  Â  Â  Â  const e = document.getElementById('loginEmail').value;
Â  Â  Â  Â  Â  Â  const p = document.getElementById('loginPass').value;
Â  Â  Â  Â  Â  Â  const btn = type === 'login' ? document.getElementById('loginBtn') : document.getElementById('signupBtn');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if(!e || !p) return showIOSNotify("Form Tidak Lengkap", "Silakan isi email dan password Anda.");
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  btn.disabled = true;
Â  Â  Â  Â  Â  Â  btn.innerText = "Processing...";
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  if(type === 'login') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await signInWithEmailAndPassword(auth, e, p);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Store password for display in settings
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  userPassword = p;
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await createUserWithEmailAndPassword(auth, e, p);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  userPassword = p;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Show setup modal for new user
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('modalOverlay').classList.add('active');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('setupUserDataModal').classList.add('active');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } catch(err) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  console.error(err.code);
Â  Â  Â  Â  Â  Â  Â  Â  let title = "Autentikasi Gagal";
Â  Â  Â  Â  Â  Â  Â  Â  let msg = "Terjadi kesalahan saat memproses data.";
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  switch(err.code) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  case 'auth/email-already-in-use':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  title = "Email Terdaftar";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  msg = "Email ini sudah digunakan oleh akun lain.";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  case 'auth/invalid-email':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  title = "Email Tidak Valid";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  msg = "Format email yang Anda masukkan salah.";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  case 'auth/user-not-found':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  title = "Akun Tidak Ada";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  msg = "Kami tidak dapat menemukan akun dengan email ini.";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  case 'auth/wrong-password':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  title = "Password Salah";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  msg = "Kata sandi yang Anda masukkan tidak sesuai.";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  case 'auth/weak-password':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  title = "Password Lemah";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  msg = "Password harus minimal 6 karakter.";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  showIOSNotify(title, msg);
Â  Â  Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  Â  Â  Â  btn.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  btn.innerText = type === 'login' ? "MASUK" : "DAFTAR BARU";
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };

Â  Â  Â  Â  window.handleLogout = () => {Â 
Â  Â  Â  Â  Â  Â  if(confirm("Keluar dari aplikasi?")) {
Â  Â  Â  Â  Â  Â  Â  Â  signOut(auth);
Â  Â  Â  Â  Â  Â  Â  Â  showIOSNotify("Logout Berhasil", "Anda telah keluar dari akun.", false);
Â  Â  Â  Â  Â  Â  Â  Â  location.reload();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };

Â  Â  Â  Â  // --- REFRESH APP ---
Â  Â  Â  Â  window.refreshApp = () => {
Â  Â  Â  Â  Â  Â  if(confirm("Refresh aplikasi? Data tidak akan hilang.")) {
Â  Â  Â  Â  Â  Â  Â  Â  location.reload();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };

Â  Â  Â  Â  // --- IMPORT/EXPORT JSON ---
Â  Â  Â  Â  window.importJSON = () => {
Â  Â  Â  Â  Â  Â  document.getElementById('modalOverlay').classList.add('active');
Â  Â  Â  Â  Â  Â  document.getElementById('importJsonModal').classList.add('active');
Â  Â  Â  Â  };

Â  Â  Â  Â  window.handleJsonFileSelect = () => {
Â  Â  Â  Â  Â  Â  const input = document.getElementById('jsonFileInput');
Â  Â  Â  Â  Â  Â  const label = document.getElementById('jsonFileLabel');
Â  Â  Â  Â  Â  Â  if (input.files && input.files[0]) {
Â  Â  Â  Â  Â  Â  Â  Â  label.innerText = input.files[0].name;
Â  Â  Â  Â  Â  Â  Â  Â  label.style.color = "white";
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('importJsonBtn').disabled = false;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  label.innerText = "Pilih file .json...";
Â  Â  Â  Â  Â  Â  Â  Â  label.style.color = "#8e8e93";
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('importJsonBtn').disabled = true;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };

Â  Â  Â  Â  window.importJSONData = async () => {
Â  Â  Â  Â  Â  Â  const fileInput = document.getElementById('jsonFileInput');
Â  Â  Â  Â  Â  Â  if (!fileInput.files[0]) {
Â  Â  Â  Â  Â  Â  Â  Â  return showIOSNotify("File Kosong", "Pilih file JSON terlebih dahulu.");
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const btn = document.getElementById('importJsonBtn');
Â  Â  Â  Â  Â  Â  btn.disabled = true;
Â  Â  Â  Â  Â  Â  btn.innerText = "Mengimport...";

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const file = fileInput.files[0];
Â  Â  Â  Â  Â  Â  Â  Â  const reader = new FileReader();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  reader.onload = async (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const jsonData = JSON.parse(e.target.result);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!Array.isArray(jsonData)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error("Format JSON tidak valid. Harus array.");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let importedCount = 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let errorCount = 0;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  for (const item of jsonData) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!item.type || !item.timestamp) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.warn("Item tidak valid, dilewati:", item);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  errorCount++;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  continue;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const data = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  type: item.type,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  timestamp: item.timestamp,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isSold: item.isSold || false,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  image: item.image || null
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ['dbEmail', 'dbPassG', 'dbPassM', 'dbBackup', 'dbName', 'dbKet', 'dbLoginVia'].forEach(field => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (item[field]) data[field] = item[field];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'stok'), data);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  importedCount++;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } catch (err) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error importing item:", err);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  errorCount++;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showIOSNotify("Import Berhasil", `Berhasil mengimport ${importedCount} item. ${errorCount > 0 ? `${errorCount} item gagal.` : ''}`, false);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  closeModals();

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } catch (err) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error parsing JSON:", err);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showIOSNotify("Format Error", "File JSON tidak valid atau rusak.");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  btn.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  btn.innerText = "IMPORT DATA";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  Â  Â  reader.readAsText(file);

Â  Â  Â  Â  Â  Â  } catch (err) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Import error:", err);
Â  Â  Â  Â  Â  Â  Â  Â  showIOSNotify("Import Gagal", "Terjadi kesalahan saat mengimport data.");
Â  Â  Â  Â  Â  Â  Â  Â  btn.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  btn.innerText = "IMPORT DATA";
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };

Â  Â  Â  Â  window.exportJSON = () => {
Â  Â  Â  Â  Â  Â  if (accounts.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  return showIOSNotify("Data Kosong", "Tidak ada data untuk diexport.");
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const blob = new Blob([JSON.stringify(accounts, null, 2)], { type: "application/json" });
Â  Â  Â  Â  Â  Â  const link = document.createElement("a");
Â  Â  Â  Â  Â  Â  link.href = URL.createObjectURL(blob);
Â  Â  Â  Â  Â  Â  link.download = `AhraStore_Backup_${new Date().toISOString().split('T')[0]}.json`;
Â  Â  Â  Â  Â  Â  link.click();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  showIOSNotify("Export Berhasil", `Data ${accounts.length} item berhasil diexport.`, false);
Â  Â  Â  Â  };

Â  Â  Â  Â  // --- FIRESTORE DATABASE LOGIC ---
Â  Â  Â  Â  function initDatabase() {
Â  Â  Â  Â  Â  Â  if(!user) return;
Â  Â  Â  Â  Â  Â  const q = query(
Â  Â  Â  Â  Â  Â  Â  Â  collection(db, 'artifacts', appId, 'users', user.uid, 'stok'),
Â  Â  Â  Â  Â  Â  Â  Â  orderBy('timestamp', 'desc')
Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  onSnapshot(q, (snap) => {
Â  Â  Â  Â  Â  Â  Â  Â  accounts = [];
Â  Â  Â  Â  Â  Â  Â  Â  snap.forEach(d => accounts.push({id: d.id, ...d.data()}));
Â  Â  Â  Â  Â  Â  Â  Â  renderDatabase();
Â  Â  Â  Â  Â  Â  }, (error) => {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Firestore error:", error);
Â  Â  Â  Â  Â  Â  Â  Â  showIOSNotify("Database Error", "Gagal memuat data dari Firestore.");
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  // PERUBAHAN: Render database dengan logika posisi Popup yang lebih pintar
Â  Â  Â  Â  function renderDatabase() {
Â  Â  Â  Â  Â  Â  const grid = document.getElementById('databaseGrid');
Â  Â  Â  Â  Â  Â  grid.innerHTML = "";
Â  Â  Â  Â  Â  Â  document.getElementById('dbCount').innerText = `${accounts.length} Item`;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  accounts.forEach(acc => {
Â  Â  Â  Â  Â  Â  Â  Â  const card = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  card.className = "db-card";
Â  Â  Â  Â  Â  Â  Â  Â  card.dataset.id = acc.id; // Store ID for reference

Â  Â  Â  Â  Â  Â  Â  Â  card.onclick = (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  e.stopPropagation(); // Stop bubbling to document
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Jika kartu ini sudah aktif, tutup (toggle)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (activeId === acc.id) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  closeAllPopovers();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  closeAllPopovers(); // Tutup yang lain dulu
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Set Status Active
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  activeId = acc.id;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const grid = document.getElementById('databaseGrid');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  grid.classList.add('has-active-card'); // Tambahkan efek blur ke grid
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  card.classList.add('active-card'); // Highlight kartu ini

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const menu = document.getElementById('itemActionMenu');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Show briefly to measure
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  menu.style.display = 'flex';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  menu.style.visibility = 'hidden';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const menuRect = menu.getBoundingClientRect();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const menuHeight = menuRect.height;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const menuWidth = menuRect.width;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const cardRect = card.getBoundingClientRect();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const viewportHeight = window.innerHeight;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const viewportWidth = window.innerWidth;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let topPos, leftPos;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // --- Horizontal Position ---
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (viewportWidth < 768) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Mobile: Center horizontally
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  leftPos = (viewportWidth - menuWidth) / 2;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Desktop: To the right of the card
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  leftPos = cardRect.right + 10;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Flip if not enough space on right
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (leftPos + menuWidth > viewportWidth) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  leftPos = cardRect.left - menuWidth - 10;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // --- Vertical Position ---
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const spaceBelow = viewportHeight - cardRect.bottom;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const spaceAbove = cardRect.top;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Smart vertical positioning
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (spaceBelow >= menuHeight + 10) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  topPos = cardRect.bottom + 5;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (spaceAbove >= menuHeight + 10) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  topPos = cardRect.top - menuHeight - 5;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Pick side with more space
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (spaceBelow > spaceAbove) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  topPos = cardRect.bottom + 5;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  topPos = cardRect.top - menuHeight - 5;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (topPos < 80) topPos = 80; // Safety for header
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Apply positions
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  menu.style.top = `${topPos}px`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  menu.style.left = `${leftPos}px`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  menu.style.position = 'fixed';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  menu.style.visibility = 'visible';
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  card.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="w-24 h-24 bg-zinc-900 rounded-xl overflow-hidden relative flex-shrink-0 flex items-center justify-center pointer-events-none">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${acc.isSold ? '<div class="sold-badge">SOLD</div>' : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${acc.image ? `<img src="${acc.image}" class="w-full h-full object-cover ${acc.isSold?'grayscale opacity-30':''}">` : '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#2c2c2e" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>'}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex-1 min-w-0 pointer-events-none">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-[14px] font-bold truncate mb-1">${acc.dbEmail || acc.dbName || 'No Name'}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-[10px] text-zinc-500 font-bold uppercase mb-2">${acc.type}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center gap-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-[10px] px-2 py-1 rounded-full ${acc.isSold ? 'bg-red-500/20 text-red-400' : 'bg-green-500/20 text-green-400'}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${acc.isSold ? 'Terjual' : 'Tersedia'}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-[9px] text-zinc-500">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${new Date(acc.timestamp).toLocaleDateString('id-ID')}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  grid.appendChild(card);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  // PERUBAHAN: Action Handlers dengan close otomatis
Â  Â  Â  Â  window.handleAction = async (type) => {
Â  Â  Â  Â  Â  Â  const acc = accounts.find(a => a.id === activeId);
Â  Â  Â  Â  Â  Â  document.getElementById('itemActionMenu').style.display = 'none';
Â  Â  Â  Â  Â  Â  if(!acc) return;

Â  Â  Â  Â  Â  Â  const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'stok', activeId);

Â  Â  Â  Â  Â  Â  if(type === 'detail') {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('modalTitle').innerText = "Detail Akun";
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  let html = '';
Â  Â  Â  Â  Â  Â  Â  Â  if (acc.image) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  html += `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-center mb-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="w-40 h-40 bg-zinc-900 rounded-xl overflow-hidden relative">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <img src="${acc.image}" class="w-full h-full object-cover">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${acc.isSold ? '<div class="sold-badge">SOLD</div>' : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  html += '<div class="ios-input-group">';
Â  Â  Â  Â  Â  Â  Â  Â  const fields = {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'type': 'Jenis',Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'dbEmail': 'Email',Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'dbPassG': 'Password G',Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'dbPassM': 'Password M',Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'dbBackup': 'Kode Cadangan',Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'dbName': 'Nama/ID',Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'dbLoginVia': 'Login Via',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'dbKet': 'Keterangan'
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  for(let key in fields) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(acc[key]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  html += `<div class="ios-input-row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="row-label">${fields[key]}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-sm font-medium break-all text-white/90">${acc[key]}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </div>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  html += `<div class="ios-input-row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="row-label">Status</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-sm font-medium ${acc.isSold ? 'text-red-400' : 'text-green-400'}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${acc.isSold ? 'Terjual' : 'Tersedia'}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </div>`;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  html += `<div class="ios-input-row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="row-label">Tanggal Input</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-sm font-medium text-white/90">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${new Date(acc.timestamp).toLocaleString('id-ID')}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </div>`;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  html += '</div>';
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('modalBody').innerHTML = html;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('modalBtnAction').classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('modalOverlay').classList.add('active');
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('iosDetailModal').classList.add('active');
Â  Â  Â  Â  Â  Â  }Â 
Â  Â  Â  Â  Â  Â  else if (type === 'edit') {
Â  Â  Â  Â  Â  Â  Â  Â  openEditModal(acc);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  else if (type === 'sold') {
Â  Â  Â  Â  Â  Â  Â  Â  await updateDoc(docRef, { isSold: !acc.isSold });
Â  Â  Â  Â  Â  Â  Â  Â  showIOSNotify("Status Diperbarui", "Status penjualan akun telah diubah.", false);
Â  Â  Â  Â  Â  Â  }Â 
Â  Â  Â  Â  Â  Â  else if (type === 'delete') {
Â  Â  Â  Â  Â  Â  Â  Â  if(confirm("Hapus stok ini permanen dari Cloud?")) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await deleteDoc(docRef);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showIOSNotify("Terhapus", "Data akun telah dihapus dari cloud.", false);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  else if (type === 'send_admin') {
Â  Â  Â  Â  Â  Â  Â  Â  let text = `ðŸš€ <b>DETAIL AKUN (ADMIN)</b>\n`;
Â  Â  Â  Â  Â  Â  Â  Â  text += `Jenis: ${acc.type}\n`;
Â  Â  Â  Â  Â  Â  Â  Â  text += `Status: ${acc.isSold ? 'Terjual' : 'Tersedia'}\n`;
Â  Â  Â  Â  Â  Â  Â  Â  text += `--------------------------------\n`;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (acc.dbEmail) text += `<b>Email:</b> <code>${acc.dbEmail}</code>\n`;
Â  Â  Â  Â  Â  Â  Â  Â  if (acc.dbPassG) text += `<b>Pass G:</b> <code>${acc.dbPassG}</code>\n`;
Â  Â  Â  Â  Â  Â  Â  Â  if (acc.dbPassM) text += `<b>Pass M:</b> <code>${acc.dbPassM}</code>\n`;
Â  Â  Â  Â  Â  Â  Â  Â  if (acc.dbName) text += `<b>Nama/ID:</b> <code>${acc.dbName}</code>\n`;
Â  Â  Â  Â  Â  Â  Â  Â  if (acc.dbLoginVia) text += `<b>Login Via:</b> <code>${acc.dbLoginVia}</code>\n`;
Â  Â  Â  Â  Â  Â  Â  Â  if (acc.dbBackup) text += `<b>Backup:</b> <code>${acc.dbBackup}</code>\n`;
Â  Â  Â  Â  Â  Â  Â  Â  if (acc.dbKet) text += `<b>Keterangan:</b> <code>${acc.dbKet}</code>\n`;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  text += `\n--------------------------------\n`;
Â  Â  Â  Â  Â  Â  Â  Â  text += `ðŸ“… Tanggal Input: ${new Date(acc.timestamp).toLocaleDateString('id-ID')}`;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  await sendAccountToTelegram(TELEGRAM_CHAT_ID, text, acc.image);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  else if (type === 'send_buyer') {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('modalTitle').innerText = "Kirim ke Buyer";
Â  Â  Â  Â  Â  Â  Â  Â  const body = document.getElementById('modalBody');
Â  Â  Â  Â  Â  Â  Â  Â  body.innerHTML = `<div class="ios-input-group"><div class="ios-input-row"><span class="row-label">Username Buyer</span><input type="text" id="buyerUsername" placeholder="@username" required></div></div>`;
Â  Â  Â  Â  Â  Â  Â  Â  const action = document.getElementById('modalBtnAction');
Â  Â  Â  Â  Â  Â  Â  Â  action.innerText = "Kirim Data"; action.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  action.onclick = async () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const buyer = document.getElementById('buyerUsername').value;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(!buyer) return;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let text = `âœ¨ <b>DETAIL AKUN BY AHRASTORE</b>\n`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  text += `Buyer: ${buyer}\n`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  text += `Jenis: ${acc.type}\n`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  text += `--------------------------------\n`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (acc.dbEmail) text += `<b>Email:</b> <code>${acc.dbEmail}</code>\n`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (acc.dbPassG) text += `<b>Pass G:</b> <code>${acc.dbPassG}</code>\n`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (acc.dbPassM) text += `<b>Pass M:</b> <code>${acc.dbPassM}</code>\n`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (acc.dbName) text += `<b>Nama/ID:</b> <code>${acc.dbName}</code>\n`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (acc.dbLoginVia) text += `<b>Login Via:</b> <code>${acc.dbLoginVia}</code>\n`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (acc.dbBackup) text += `<b>Backup:</b> <code>${acc.dbBackup}</code>\n`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (acc.dbKet) text += `<b>Keterangan:</b> <code>${acc.dbKet}</code>\n`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  text += `\n--------------------------------\n`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  text += `ðŸ“¦ Stok lain nya cek di sini\n`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  text += `ðŸŒ https://t.me/StokAhraStore2\n`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  text += `\n`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  text += `ðŸ‘¥ Grub stok jual beli, taruh stok mu atau cari stok lain di sini\n`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  text += `ðŸŒ https://t.me/JBAKUNMLBYAHRASTORE\n`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  text += `\n`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  text += `ðŸ¤Ÿ Testimoni? cek\n`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  text += `ðŸŒ https://t.me/TESTIMONIAHRASTORE`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  closeModals();Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await sendAccountToTelegram(TELEGRAM_CHAT_ID, text, acc.image);
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('modalOverlay').classList.add('active');
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('iosDetailModal').classList.add('active');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  // Setelah action apapun, reset blur dan close popover
Â  Â  Â  Â  Â  Â  closeAllPopovers();
Â  Â  Â  Â  };

Â  Â  Â  Â  // --- FUNGSI EDIT DATA ---
Â  Â  Â  Â  function openEditModal(account) {
Â  Â  Â  Â  Â  Â  document.getElementById('modalTitle').innerText = "Edit Data Akun";
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  let html = `
Â  Â  Â  Â  Â  Â  Â  Â  <form id="editForm" class="space-y-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="ios-input-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="ios-input-row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="row-label">Foto Akun (Opsional)</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="editImage" class="flex justify-between items-center cursor-pointer py-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="label-editImage" class="text-[15px] ${account.image ? 'text-white' : 'text-zinc-500'}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${account.image ? 'Ganti foto...' : 'Unggah foto...'}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-blue-500">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <circle cx="12" cy="13" r="4"/>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="file" id="editImage" accept="image/*" class="hidden" onchange="handleEditImageSelect(this)">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${account.image ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="mt-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-[10px] text-zinc-500 mb-1">Foto saat ini:</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <img src="${account.image}" class="w-20 h-20 object-cover rounded-lg border border-white/10">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="ios-input-row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="row-label">Jenis Akun</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="ios-select-trigger !p-0 !bg-transparent !border-none" onclick="openEditTypePicker()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="labelEditType" class="text-[15px] ${account.type ? 'text-white' : 'text-zinc-500'}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${account.type || 'Pilih Jenis...'}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#8e8e93" stroke-width="2.5">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <path d="M6 9l6 6 6-6"/>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="hidden" id="editType" value="${account.type || ''}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="editDynamicFields">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${generateEditFields(account)}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="ios-input-row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="row-label">Status Sold</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center justify-between">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-[15px]">${account.isSold ? 'Terjual' : 'Tersedia'}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="toggle-switch">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="checkbox" id="editIsSold" ${account.isSold ? 'checked' : ''}>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="toggle-slider"></span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  document.getElementById('modalBody').innerHTML = html;
Â  Â  Â  Â  Â  Â  document.getElementById('modalBtnAction').innerText = "Simpan Perubahan";
Â  Â  Â  Â  Â  Â  document.getElementById('modalBtnAction').classList.remove('hidden');
Â  Â  Â  Â  Â  Â  document.getElementById('modalBtnAction').onclick = () => saveEditChanges(account.id);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  document.getElementById('modalOverlay').classList.add('active');
Â  Â  Â  Â  Â  Â  document.getElementById('iosDetailModal').classList.add('active');
Â  Â  Â  Â  }

Â  Â  Â  Â  function generateEditFields(account) {
Â  Â  Â  Â  Â  Â  let html = '';
Â  Â  Â  Â  Â  Â  const fields = [
Â  Â  Â  Â  Â  Â  Â  Â  { id: 'editDbEmail', label: 'Email Akun', value: account.dbEmail || '' },
Â  Â  Â  Â  Â  Â  Â  Â  { id: 'editDbPassG', label: 'Password Google', value: account.dbPassG || '' },
Â  Â  Â  Â  Â  Â  Â  Â  { id: 'editDbPassM', label: 'Password Moonton', value: account.dbPassM || '' },
Â  Â  Â  Â  Â  Â  Â  Â  { id: 'editDbBackup', label: 'Kode Cadangan', value: account.dbBackup || '' },
Â  Â  Â  Â  Â  Â  Â  Â  { id: 'editDbName', label: 'Nama/ID', value: account.dbName || '' },
Â  Â  Â  Â  Â  Â  Â  Â  { id: 'editDbLoginVia', label: 'Login Via', value: account.dbLoginVia || '' },
Â  Â  Â  Â  Â  Â  Â  Â  { id: 'editDbKet', label: 'Keterangan', value: account.dbKet || '' }
Â  Â  Â  Â  Â  Â  ];
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  fields.forEach(field => {
Â  Â  Â  Â  Â  Â  Â  Â  if (field.value || field.id === 'editDbEmail') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  html += `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="ios-input-row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="row-label">${field.label}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="${field.id}" value="${field.value}" placeholder="${field.label}" class="text-white">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  return html;
Â  Â  Â  Â  }

Â  Â  Â  Â  window.openEditTypePicker = () => {
Â  Â  Â  Â  Â  Â  const types = ['Mail fresh', 'Mail own', 'Monkos', 'Galver'];
Â  Â  Â  Â  Â  Â  openIOSPicker('PILIH JENIS AKUN', types, 'editType', false);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  document.querySelectorAll('#pickerOptionsContainer .picker-option').forEach(btn => {
Â  Â  Â  Â  Â  Â  Â  Â  btn.addEventListener('click', function() {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const newType = document.getElementById('editType').value;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const account = accounts.find(a => a.id === activeId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (account && newType !== account.type) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  account.type = newType;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const container = document.getElementById('editDynamicFields');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  container.innerHTML = generateEditFields(account);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }, 100);
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  };

Â  Â  Â  Â  async function saveEditChanges(docId) {
Â  Â  Â  Â  Â  Â  const type = document.getElementById('editType').value;
Â  Â  Â  Â  Â  Â  const isSold = document.getElementById('editIsSold')?.checked || false;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!type) {
Â  Â  Â  Â  Â  Â  Â  Â  showIOSNotify("Error", "Jenis akun harus diisi.");
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const btn = document.getElementById('modalBtnAction');
Â  Â  Â  Â  Â  Â  btn.disabled = true;
Â  Â  Â  Â  Â  Â  btn.innerText = "Menyimpan...";
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'stok', docId);
Â  Â  Â  Â  Â  Â  Â  Â  const updates = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  type: type,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isSold: isSold,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updatedAt: Date.now()
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  ['editDbEmail', 'editDbPassG', 'editDbPassM', 'editDbBackup', 'editDbName', 'editDbLoginVia', 'editDbKet'].forEach(fieldId => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const element = document.getElementById(fieldId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (element) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const value = element.value.trim();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const dbField = fieldId.replace('editDb', 'db');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (value) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updates[dbField] = value;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updates[dbField] = null;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const imageInput = document.getElementById('editImage');
Â  Â  Â  Â  Â  Â  Â  Â  if (imageInput?.files[0]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // PERUBAHAN: Compress image on edit
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updates.image = await compressImage(imageInput.files[0]);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  await updateDoc(docRef, updates);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  showIOSNotify("Berhasil", "Data akun berhasil diperbarui.", false);
Â  Â  Â  Â  Â  Â  Â  Â  closeModals();
Â  Â  Â  Â  Â  Â  Â  Â  closeAllPopovers(); // Reset blur effect
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error updating document:", error);
Â  Â  Â  Â  Â  Â  Â  Â  showIOSNotify("Gagal", "Terjadi kesalahan saat menyimpan perubahan.");
Â  Â  Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  Â  Â  Â  btn.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  btn.innerText = "Simpan Perubahan";
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  window.handleEditImageSelect = (input) => {
Â  Â  Â  Â  Â  Â  const label = document.getElementById('label-editImage');
Â  Â  Â  Â  Â  Â  if (input.files && input.files[0]) {
Â  Â  Â  Â  Â  Â  Â  Â  label.innerText = input.files[0].name;
Â  Â  Â  Â  Â  Â  Â  Â  label.style.color = "white";
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  label.innerText = "Unggah foto...";
Â  Â  Â  Â  Â  Â  Â  Â  label.style.color = "#8e8e93";
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };

Â  Â  Â  Â  // --- PICKER UTILS ---
Â  Â  Â  Â  window.openIOSDatePicker = () => {
Â  Â  Â  Â  Â  Â  const container = document.getElementById('pickerOptionsContainer');
Â  Â  Â  Â  Â  Â  document.getElementById('pickerTitle').innerText = "PILIH TANGGAL";
Â  Â  Â  Â  Â  Â  container.innerHTML = "";
Â  Â  Â  Â  Â  Â  const dates = [];
Â  Â  Â  Â  Â  Â  for(let i=0; i<30; i++){
Â  Â  Â  Â  Â  Â  Â  Â  const d = new Date(); d.setDate(d.getDate() - i);
Â  Â  Â  Â  Â  Â  Â  Â  dates.push(d.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' }));
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  dates.forEach(date => {
Â  Â  Â  Â  Â  Â  Â  Â  const btn = document.createElement('button'); btn.className = "picker-option"; btn.innerText = date;
Â  Â  Â  Â  Â  Â  Â  Â  btn.onclick = () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('testiTanggal').value = date;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('labelTestiTanggal').innerText = date;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('labelTestiTanggal').style.color = "white";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  closeModals();
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  container.appendChild(btn);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  document.getElementById('modalOverlay').classList.add('active');
Â  Â  Â  Â  Â  Â  document.getElementById('iosPickerSheet').classList.add('active');
Â  Â  Â  Â  };

Â  Â  Â  Â  window.openTestimoniPicker = () => {
Â  Â  Â  Â  Â  Â  const levels = ["Junior", "Senior", "Ahli", "Ternama", "Terhormat", "Juragan", "Sultan"];
Â  Â  Â  Â  Â  Â  const container = document.getElementById('pickerOptionsContainer');
Â  Â  Â  Â  Â  Â  document.getElementById('pickerTitle').innerText = "PILIH TINGKATAN";
Â  Â  Â  Â  Â  Â  container.innerHTML = "";
Â  Â  Â  Â  Â  Â  levels.forEach(lvl => {
Â  Â  Â  Â  Â  Â  Â  Â  const btn = document.createElement('button'); btn.className = "picker-option"; btn.innerText = lvl;
Â  Â  Â  Â  Â  Â  Â  Â  btn.onclick = () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(lvl === "Sultan") {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('testiAkun').value = lvl;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('labelTestiAkun').innerText = lvl;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('labelTestiAkun').style.color = "white";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  closeModals();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else { openLevelNumberPicker(lvl); }
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  container.appendChild(btn);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  document.getElementById('modalOverlay').classList.add('active');
Â  Â  Â  Â  Â  Â  document.getElementById('iosPickerSheet').classList.add('active');
Â  Â  Â  Â  };

Â  Â  Â  Â  function openLevelNumberPicker(lvlBase) {
Â  Â  Â  Â  Â  Â  const container = document.getElementById('pickerOptionsContainer');
Â  Â  Â  Â  Â  Â  document.getElementById('pickerTitle').innerText = `PILIH ANGKA ${lvlBase.toUpperCase()}`;
Â  Â  Â  Â  Â  Â  container.innerHTML = "";
Â  Â  Â  Â  Â  Â  [1, 2, 3, 4, 5].forEach(num => {
Â  Â  Â  Â  Â  Â  Â  Â  const btn = document.createElement('button'); btn.className = "picker-option"; btn.innerText = num;
Â  Â  Â  Â  Â  Â  Â  Â  btn.onclick = () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const finalValue = `${lvlBase} ${num}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('testiAkun').value = finalValue;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('labelTestiAkun').innerText = finalValue;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('labelTestiAkun').style.color = "white";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  closeModals();
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  container.appendChild(btn);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- FIX: FORM TESTIMONI ---
Â  Â  Â  Â  document.getElementById('formTesti').onsubmit = async (e) => {
Â  Â  Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  Â  Â  const btn = e.target.querySelector('button');
Â  Â  Â  Â  Â  Â  const tanggal = document.getElementById('testiTanggal').value;
Â  Â  Â  Â  Â  Â  let harga = document.getElementById('testiHarga').value;
Â  Â  Â  Â  Â  Â  const akun = document.getElementById('testiAkun').value;
Â  Â  Â  Â  Â  Â  const testiImageInput = document.getElementById('testiImage');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if(!tanggal || !harga || !akun) return showIOSNotify("Form Testimoni", "Mohon lengkapi semua data testimoni.");
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!testiImageInput.files || testiImageInput.files.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  return showIOSNotify("Foto Kosong", "Pilih foto bukti transaksi terlebih dahulu.");
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const photo = testiImageInput.files[0];
Â  Â  Â  Â  Â  Â  if (photo.size > 10 * 1024 * 1024) {
Â  Â  Â  Â  Â  Â  Â  Â  return showIOSNotify("File Terlalu Besar", "Ukuran foto maksimal 10MB.");
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // PERUBAHAN: Konversi format Rupiah ke angka
Â  Â  Â  Â  Â  Â  harga = convertRupiahToNumber(harga);
Â  Â  Â  Â  Â  Â  if (harga === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  return showIOSNotify("Harga Invalid", "Masukkan harga yang valid.");
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  btn.disabled = true; btn.innerText = "Memproses...";
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const text = `âœ¨ <b>TESTIMONI TRANSAKSI AHRASTORE</b>\n\nðŸ“… Tanggal : ${tanggal}\nâ„¹ï¸ Info : Akun ${akun}\nðŸ’¸ Harga : Rp ${harga.toLocaleString('id-ID')}\n\nðŸ“¦ Stok lain nya cek di sini\nðŸŒ https://t.me/StokAhraStore2\nðŸ¤Ÿ Testimoni? cek\nðŸŒ https://t.me/TESTIMONIAHRASTORE`;
Â  Â  Â  Â  Â  Â  const formData = new FormData();
Â  Â  Â  Â  Â  Â  formData.append('chat_id', TELEGRAM_CHAT_ID);Â 
Â  Â  Â  Â  Â  Â  formData.append('parse_mode', 'HTML');Â 
Â  Â  Â  Â  Â  Â  formData.append('caption', text);
Â  Â  Â  Â  Â  Â  formData.append('photo', photo);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch(`${CF_TELEGRAM_PROXY_BASE}/sendPhoto`, { method: 'POST', body: formData });
Â  Â  Â  Â  Â  Â  Â  Â  const resData = await response.json();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if(resData.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showIOSNotify("Testimoni Terkirim", "Postingan telah berhasil dikirim ke channel.", false);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  e.target.reset();Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('labelTestiTanggal').innerText = "Pilih Tanggal...";Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('labelTestiTanggal').style.color = "#8e8e93";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('labelTestiAkun').innerText = "Pilih Tingkatan...";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('labelTestiAkun').style.color = "#8e8e93";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('label-testiImage').innerText = "Pilih Foto...";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('label-testiImage').style.color = "#8e8e93";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Reset harga input
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const hargaInput = document.getElementById('testiHarga');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  hargaInput.value = '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  hargaInput.style.color = 'white';
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â throw new Error(resData.description || "Gagal mengirim ke Telegram");
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } catch(e) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  console.error(e);
Â  Â  Â  Â  Â  Â  Â  Â  showIOSNotify("Pengiriman Gagal", e.message || "Gagal mengirim data ke Telegram.");Â 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  btn.disabled = false; btn.innerText = "POST TESTIMONI";
Â  Â  Â  Â  };

Â  Â  Â  Â  // --- FIX: FORM SAVE (INPUT DATA) - PERBAIKAN UPLOAD FOTO ---
Â  Â  Â  Â  document.getElementById('formSave').onsubmit = async (e) => {
Â  Â  Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  Â  Â  console.log("Form Save submitted");
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const type = document.getElementById('saveType').value;
Â  Â  Â  Â  Â  Â  if(!type) {
Â  Â  Â  Â  Â  Â  Â  Â  showIOSNotify("Jenis Kosong", "Pilih jenis akun terlebih dahulu.");
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const btn = document.getElementById('submitSaveBtn');
Â  Â  Â  Â  Â  Â  btn.disabled = true;Â 
Â  Â  Â  Â  Â  Â  btn.innerText = "Menyimpan...";
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const data = {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  type: type,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  timestamp: Date.now(),Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isSold: falseÂ 
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  ['dbEmail', 'dbPassG', 'dbPassM', 'dbBackup', 'dbName', 'dbKet', 'dbLoginVia', 'galverSubtype'].forEach(field => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const el = document.getElementById(field);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (el) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const value = el.value.trim();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (value) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data[field] = value;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // PERUBAHAN: Handle image upload dengan KOMPRESI OTOMATIS
Â  Â  Â  Â  Â  Â  Â  Â  const fileInput = document.getElementById('saveImage');
Â  Â  Â  Â  Â  Â  Â  Â  if (fileInput.files && fileInput.files[0]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const file = fileInput.files[0];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Validasi tipe file
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!file.type.match('image.*')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  btn.disabled = false; btn.innerText = "INPUT DATA";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return showIOSNotify("Format Tidak Didukung", "Hanya file gambar yang diperbolehkan.");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // FIX UTAMA: Compress image menggunakan fungsi compressImage
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Ini memastikan file <= 1MB untuk Firestore
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data.image = await compressImage(file, 800, 0.6); // Max width 800, quality 60%
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log("Image compressed successfully");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error reading file:", error);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showIOSNotify("Error", "Gagal membaca file gambar.");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  btn.disabled = false; btn.innerText = "INPUT DATA";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  let isValid = true;
Â  Â  Â  Â  Â  Â  Â  Â  let errorMsg = "";
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (type === "Mail fresh" || type === "Mail own") {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!data.dbEmail) { isValid = false; errorMsg = "Email akun harus diisi"; }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!data.dbPassG) { isValid = false; errorMsg = "Password Google harus diisi"; }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!data.dbPassM) { isValid = false; errorMsg = "Password Moonton harus diisi"; }
Â  Â  Â  Â  Â  Â  Â  Â  } else if (type === "Monkos") {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!data.dbEmail) { isValid = false; errorMsg = "Email akun harus diisi"; }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!data.dbPassG) { isValid = false; errorMsg = "Password Google harus diisi"; }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!data.dbLoginVia) { isValid = false; errorMsg = "Login Via harus dipilih"; }
Â  Â  Â  Â  Â  Â  Â  Â  } else if (type === "Galver") {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const subtype = data.galverSubtype;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!subtype) { isValid = false; errorMsg = "Metode login harus dipilih"; }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else if (subtype === 'Login Email') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!data.dbEmail) { isValid = false; errorMsg = "Email akun harus diisi"; }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!data.dbPassG) { isValid = false; errorMsg = "Password Google harus diisi"; }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (subtype === 'Login Name') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!data.dbName) { isValid = false; errorMsg = "Nama/ID harus diisi"; }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!data.dbPassM) { isValid = false; errorMsg = "Password Moonton harus diisi"; }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (!isValid) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  btn.disabled = false; btn.innerText = "INPUT DATA";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showIOSNotify("Data Tidak Lengkap", errorMsg);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Simpan ke Firestore
Â  Â  Â  Â  Â  Â  Â  Â  const docRef = await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'stok'), data);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  showIOSNotify("Data Tersimpan", "Akun berhasil diinput ke cloud database.", false);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  e.target.reset();Â 
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('dynamicFields').innerHTML = "";Â 
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('labelSaveType').innerText = "Pilih Jenis Akun...";Â 
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('labelSaveType').style.color = "#8e8e93";
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('label-saveImage').innerText = "Pilih Foto...";
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('label-saveImage').style.color = "#8e8e93";
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  switchTab('db');
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  } catch(err) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Save error:", err);
Â  Â  Â  Â  Â  Â  Â  Â  let errorMessage = "Gagal menyimpan data ke Firestore.";
Â  Â  Â  Â  Â  Â  Â  Â  // Cek error spesifik ukuran file (biasanya code: invalid-argument jika base64 terlalu panjang)
Â  Â  Â  Â  Â  Â  Â  Â  if (err.code === 'invalid-argument') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  errorMessage = "Ukuran data terlalu besar. Coba foto lebih kecil.";
Â  Â  Â  Â  Â  Â  Â  Â  } else if (err.code === 'permission-denied') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  errorMessage = "Izin ditolak. Pastikan aturan Firestore sudah benar.";
Â  Â  Â  Â  Â  Â  Â  Â  } else if (err.code === 'unavailable') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  errorMessage = "Koneksi jaringan bermasalah. Coba lagi.";
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  showIOSNotify("Input Gagal", errorMessage);Â 
Â  Â  Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  Â  Â  Â  btn.disabled = false;Â 
Â  Â  Â  Â  Â  Â  Â  Â  btn.innerText = "INPUT DATA";
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };

Â  Â  Â  Â  // --- FIX: FORM STOK ---
Â  Â  Â  Â  document.getElementById('formStok').onsubmit = async (e) => {
Â  Â  Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  Â  Â  const btn = e.target.querySelector('button');Â 
Â  Â  Â  Â  Â  Â  btn.disabled = true;Â 
Â  Â  Â  Â  Â  Â  btn.innerText = "Mengirim...";
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  let harga = document.getElementById('stokHarga').value;
Â  Â  Â  Â  Â  Â  const info = document.getElementById('stokInfo').value;
Â  Â  Â  Â  Â  Â  const stokImageInput = document.getElementById('stokImage');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!info) {
Â  Â  Â  Â  Â  Â  Â  Â  btn.disabled = false; btn.innerText = "KIRIM KE CHANNEL";
Â  Â  Â  Â  Â  Â  Â  Â  return showIOSNotify("Status Kosong", "Pilih status informasi akun.");
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!stokImageInput.files || stokImageInput.files.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  btn.disabled = false; btn.innerText = "KIRIM KE CHANNEL";
Â  Â  Â  Â  Â  Â  Â  Â  return showIOSNotify("Foto Kosong", "Pilih foto bukti terlebih dahulu.");
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const photo = stokImageInput.files[0];
Â  Â  Â  Â  Â  Â  if (photo.size > 10 * 1024 * 1024) {
Â  Â  Â  Â  Â  Â  Â  Â  btn.disabled = false; btn.innerText = "KIRIM KE CHANNEL";
Â  Â  Â  Â  Â  Â  Â  Â  return showIOSNotify("File Terlalu Besar", "Ukuran foto maksimal 10MB.");
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // PERUBAHAN: Konversi format Rupiah ke angka
Â  Â  Â  Â  Â  Â  harga = convertRupiahToNumber(harga);
Â  Â  Â  Â  Â  Â  if (harga === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  btn.disabled = false; btn.innerText = "KIRIM KE CHANNEL";
Â  Â  Â  Â  Â  Â  Â  Â  return showIOSNotify("Harga Invalid", "Masukkan harga yang valid.");
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const text = `â€¼ï¸NEW ACCOUNT FROM AHRASTOREâ€¼ï¸\n\nðŸ’¸Price : Rp ${harga.toLocaleString('id-ID')}\nâ„¹ï¸Info Akun : ${info}\n\nðŸ›’Order? Chat Admin AHRASTORE\nðŸŒ https://t.me/zaaamyy\nðŸ“¦Stok lain nya cek di sini\nðŸŒ https://t.me/StokAhraStore2`;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const formData = new FormData();
Â  Â  Â  Â  Â  Â  formData.append('chat_id', TELEGRAM_CHAT_ID);Â 
Â  Â  Â  Â  Â  Â  formData.append('parse_mode', 'HTML');Â 
Â  Â  Â  Â  Â  Â  formData.append('caption', text);
Â  Â  Â  Â  Â  Â  formData.append('photo', photo);

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch(`${CF_TELEGRAM_PROXY_BASE}/sendPhoto`, { method: 'POST', body: formData });
Â  Â  Â  Â  Â  Â  Â  Â  const resData = await response.json();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if(resData.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showIOSNotify("Berhasil Dikirim", "Informasi stok akun terkirim ke channel.", false);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  e.target.reset();Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('label-stokImage').innerText = "Pilih Foto...";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('label-stokImage').style.color = "#8e8e93";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('labelStokInfo').innerText = "Pilih Status...";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('labelStokInfo').style.color = "#8e8e93";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Reset harga input
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const hargaInput = document.getElementById('stokHarga');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  hargaInput.value = '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  hargaInput.style.color = 'white';
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error(resData.description || "Telegram API Error");
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } catch (e) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  console.error(e);
Â  Â  Â  Â  Â  Â  Â  Â  showIOSNotify("Gagal Kirim", e.message || "Terjadi masalah saat menghubungi Telegram.");Â 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  btn.disabled = false; btn.innerText = "KIRIM KE CHANNEL";
Â  Â  Â  Â  };

Â  Â  Â  Â  // --- GLOBAL UI UTILS ---
Â  Â  Â  Â  window.switchTab = (tab) => {
Â  Â  Â  Â  Â  Â  ['stok', 'testi', 'save', 'db'].forEach(t => {
Â  Â  Â  Â  Â  Â  Â  Â  const el = document.getElementById(`section-${t}`);
Â  Â  Â  Â  Â  Â  Â  Â  const btn = document.getElementById(`tab-${t}`);
Â  Â  Â  Â  Â  Â  Â  Â  if(el) el.classList.toggle('hidden', t !== tab);
Â  Â  Â  Â  Â  Â  Â  Â  if(btn) btn.classList.toggle('tab-active', t === tab);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  window.scrollTo(0,0);
Â  Â  Â  Â  Â  Â  closeAllPopovers(); // Pastikan popover tertutup saat ganti tab
Â  Â  Â  Â  };

Â  Â  Â  Â  window.toggleAhraPopover = (id) => {
Â  Â  Â  Â  Â  Â  const el = document.getElementById(id);
Â  Â  Â  Â  Â  Â  el.style.display = el.style.display === 'flex' ? 'none' : 'flex';
Â  Â  Â  Â  };

Â  Â  Â  Â  // PERUBAHAN: Close popovers dan RESET BLUR
Â  Â  Â  Â  window.closeAllPopovers = () => {
Â  Â  Â  Â  Â  Â  document.querySelectorAll('.ios-popover').forEach(p => p.style.display = 'none');
Â  Â  Â  Â  Â  Â  activeId = null;

Â  Â  Â  Â  Â  Â  // Remove Blur Effects (Reset to normal state)
Â  Â  Â  Â  Â  Â  const grid = document.getElementById('databaseGrid');
Â  Â  Â  Â  Â  Â  if(grid) grid.classList.remove('has-active-card');

Â  Â  Â  Â  Â  Â  const activeCard = document.querySelector('.db-card.active-card');
Â  Â  Â  Â  Â  Â  if(activeCard) activeCard.classList.remove('active-card');
Â  Â  Â  Â  };

Â  Â  Â  Â  window.closeModals = () => {
Â  Â  Â  Â  Â  Â  document.querySelectorAll('.overlay, .bottom-sheet, .centered-modal').forEach(m => {
Â  Â  Â  Â  Â  Â  Â  Â  if(m.id !== 'setupUserDataModal') m.classList.remove('active');
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  setTimeout(() => {Â 
Â  Â  Â  Â  Â  Â  Â  Â  const btn = document.getElementById('modalBtnAction');
Â  Â  Â  Â  Â  Â  Â  Â  if(btn) btn.classList.add('hidden');Â 
Â  Â  Â  Â  Â  Â  }, 300);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Juga close action menu
Â  Â  Â  Â  Â  Â  closeAllPopovers();
Â  Â  Â  Â  };
Â  Â  Â  Â  document.getElementById('modalOverlay').onclick = closeModals;

Â  Â  Â  Â  window.openIOSPicker = (title, options, targetId, isDynamic = false) => {
Â  Â  Â  Â  Â  Â  const container = document.getElementById('pickerOptionsContainer');
Â  Â  Â  Â  Â  Â  document.getElementById('pickerTitle').innerText = title;
Â  Â  Â  Â  Â  Â  container.innerHTML = "";
Â  Â  Â  Â  Â  Â  options.forEach(opt => {
Â  Â  Â  Â  Â  Â  Â  Â  const btn = document.createElement('button');
Â  Â  Â  Â  Â  Â  Â  Â  btn.className = "picker-option"; btn.innerText = opt;
Â  Â  Â  Â  Â  Â  Â  Â  btn.onclick = () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById(targetId).value = opt;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const label = document.getElementById('label' + targetId.charAt(0).toUpperCase() + targetId.slice(1));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(label) { label.innerText = opt; label.style.color = "white"; }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (isDynamic && targetId === 'saveType') handleDynamicFields(opt);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (isDynamic && targetId === 'galverSubtype') handleGalverFields(opt);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  closeModals();
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  container.appendChild(btn);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  document.getElementById('modalOverlay').classList.add('active');
Â  Â  Â  Â  Â  Â  document.getElementById('iosPickerSheet').classList.add('active');
Â  Â  Â  Â  };

Â  Â  Â  Â  function handleDynamicFields(type) {
Â  Â  Â  Â  Â  Â  const container = document.getElementById('dynamicFields');
Â  Â  Â  Â  Â  Â  let html = '<div class="ios-input-group">';
Â  Â  Â  Â  Â  Â  if (type === "Mail fresh" || type === "Mail own") {
Â  Â  Â  Â  Â  Â  Â  Â  html += `<div class="ios-input-row"><span class="row-label">Email Akun</span><input type="text" id="dbEmail" placeholder="Email" required></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="ios-input-row"><span class="row-label">Password G</span><input type="text" id="dbPassG" placeholder="Pass Google" required></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="ios-input-row"><span class="row-label">Password M</span><input type="text" id="dbPassM" placeholder="Pass Moonton" required></div>`;
Â  Â  Â  Â  Â  Â  Â  Â  if(type === "Mail own") html += `<div class="ios-input-row"><span class="row-label">Kode Cadangan</span><textarea id="dbBackup" placeholder="Backup Code"></textarea></div>`;
Â  Â  Â  Â  Â  Â  } else if (type === "Monkos") {
Â  Â  Â  Â  Â  Â  Â  Â  html += `<div class="ios-input-row"><span class="row-label">Email Akun</span><input type="text" id="dbEmail" placeholder="Email" required></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="ios-input-row"><span class="row-label">Password Google</span><input type="text" id="dbPassG" placeholder="Pass Google" required></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="ios-input-row"><span class="row-label">Kode Cadangan</span><textarea id="dbBackup" placeholder="Backup Code"></textarea></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="ios-input-row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <span class="row-label">Login Via</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="ios-select-trigger !p-0 !bg-transparent !border-none" onclick="openIOSPicker('LOGIN VIA', ['TikTok', 'Facebook', 'Google'], 'dbLoginVia')">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <span id="labelDbLoginVia" class="text-[15px] text-zinc-500">Pilih Login Via...</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#8e8e93" stroke-width="2.5"><path d="M6 9l6 6 6-6"/></svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <input type="hidden" id="dbLoginVia" required>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </div>`;
Â  Â  Â  Â  Â  Â  } else if (type === "Galver") {
Â  Â  Â  Â  Â  Â  Â  Â  html += `<div class="ios-input-row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <span class="row-label">Metode Login</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="ios-select-trigger !p-0 !bg-transparent !border-none" onclick="openIOSPicker('METODE LOGIN', ['Login Email', 'Login Name'], 'galverSubtype', true)">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <span id="labelGalverSubtype" class="text-[15px] text-zinc-500">Pilih Metode...</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#8e8e93" stroke-width="2.5"><path d="M6 9l6 6 6-6"/></svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <input type="hidden" id="galverSubtype" required>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div id="galverFields"></div>`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  html += '</div>';
Â  Â  Â  Â  Â  Â  container.innerHTML = html;
Â  Â  Â  Â  }

Â  Â  Â  Â  function handleGalverFields(subtype) {
Â  Â  Â  Â  Â  Â  const container = document.getElementById('galverFields');
Â  Â  Â  Â  Â  Â  if(!container) return;
Â  Â  Â  Â  Â  Â  let html = '';
Â  Â  Â  Â  Â  Â  if (subtype === 'Login Email') {
Â  Â  Â  Â  Â  Â  Â  Â  Â html += `<div class="ios-input-row"><span class="row-label">Email Akun</span><input type="text" id="dbEmail" placeholder="Email" required></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="ios-input-row"><span class="row-label">Password Google</span><input type="text" id="dbPassG" placeholder="Pass Google" required></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="ios-input-row"><span class="row-label">Kode Cadangan</span><textarea id="dbBackup" placeholder="Backup Code"></textarea></div>`;
Â  Â  Â  Â  Â  Â  } else if (subtype === 'Login Name') {
Â  Â  Â  Â  Â  Â  Â  Â  Â html += `<div class="ios-input-row"><span class="row-label">Nama/ID</span><input type="text" id="dbName" placeholder="Nama Akun" required></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="ios-input-row"><span class="row-label">Password Moonton</span><input type="text" id="dbPassM" placeholder="Pass Moonton" required></div>`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  container.innerHTML = html;
Â  Â  Â  Â  }

Â  Â  Â  Â  async function sendAccountToTelegram(chatId, text, imageBase64) {
Â  Â  Â  Â  Â  Â  const formData = new FormData();
Â  Â  Â  Â  Â  Â  formData.append('chat_id', chatId);Â 
Â  Â  Â  Â  Â  Â  formData.append('parse_mode', 'HTML');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (imageBase64) {
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const arr = imageBase64.split(','), mime = arr[0].match(/:(.*?);/)[1], bstr = atob(arr[1]);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let n = bstr.length; const u8arr = new Uint8Array(n);Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  while(n--){ u8arr[n] = bstr.charCodeAt(n); }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  formData.append('photo', new Blob([u8arr], {type:mime}), 'img.png');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  formData.append('caption', text);
Â  Â  Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error processing image:", e);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  formData.append('text', text);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } else {Â 
Â  Â  Â  Â  Â  Â  Â  Â  formData.append('text', text);Â 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  try {Â 
Â  Â  Â  Â  Â  Â  Â  Â  const endpoint = imageBase64 ? 'sendPhoto' : 'sendMessage';
Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch(`${CF_TELEGRAM_PROXY_BASE}/${endpoint}`, { method: 'POST', body: formData });Â 
Â  Â  Â  Â  Â  Â  Â  Â  const resData = await response.json();
Â  Â  Â  Â  Â  Â  Â  Â  if(resData.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showIOSNotify("Berhasil", "Data berhasil terkirim ke Telegram.", false);Â 
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â throw new Error(resData.description || "Gagal mengirim ke Telegram");
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } catch(e) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  console.error(e);
Â  Â  Â  Â  Â  Â  Â  Â  showIOSNotify("Error", e.message || "Gagal mengirim pesan.");Â 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // PERUBAHAN: Event listener untuk close popover saat klik di mana saja
Â  Â  Â  Â  document.addEventListener('click', (e) => {
Â  Â  Â  Â  Â  Â  // Jika klik bukan di dalam popover, bukan tombol settings, dan bukan card database
Â  Â  Â  Â  Â  Â  if (!e.target.closest('.ios-popover') &&Â 
Â  Â  Â  Â  Â  Â  Â  Â  !e.target.closest('#settingsBtn') &&Â 
Â  Â  Â  Â  Â  Â  Â  Â  !e.target.closest('.db-card')) {
Â  Â  Â  Â  Â  Â  Â  Â  closeAllPopovers();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Jika klik di luar modal tetapi di dalam overlay, close modal
Â  Â  Â  Â  Â  Â  if (e.target.id === 'modalOverlay') {
Â  Â  Â  Â  Â  Â  Â  Â  closeModals();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  // PERUBAHAN UTAMA: Event listener untuk close popover saat scroll dengan capture phase
Â  Â  Â  Â  // Ini memastikan menu tertutup dan blur hilang saat layar digulir
Â  Â  Â  Â  window.addEventListener('scroll', () => {
Â  Â  Â  Â  Â  Â  if (activeId !== null) {
Â  Â  Â  Â  Â  Â  Â  Â  closeAllPopovers();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }, true);

Â  Â  Â  Â  // Inisialisasi input harga dengan event listener
Â  Â  Â  Â  document.addEventListener('DOMContentLoaded', function() {
Â  Â  Â  Â  Â  Â  // Set inputmode numeric untuk input harga
Â  Â  Â  Â  Â  Â  const hargaInputs = document.querySelectorAll('.price-input');
Â  Â  Â  Â  Â  Â  hargaInputs.forEach(input => {
Â  Â  Â  Â  Â  Â  Â  Â  input.setAttribute('inputmode', 'numeric');
Â  Â  Â  Â  Â  Â  Â  Â  input.setAttribute('pattern', '[0-9.,]*');
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Format saat kehilangan fokus
Â  Â  Â  Â  Â  Â  Â  Â  input.addEventListener('blur', function() {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  formatRupiahInput(this);
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Validasi saat input
Â  Â  Â  Â  Â  Â  Â  Â  input.addEventListener('input', function() {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  validateNumberInput(this);
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Clear format saat fokus
Â  Â  Â  Â  Â  Â  Â  Â  input.addEventListener('focus', function() {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  this.value = this.value.replace(/\./g, '');
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Fix untuk eye icon di login
Â  Â  Â  Â  Â  Â  const eyeToggle = document.getElementById('eyeToggleBtn');
Â  Â  Â  Â  Â  Â  if (eyeToggle) {
Â  Â  Â  Â  Â  Â  Â  Â  eyeToggle.addEventListener('click', toggleLoginPassword);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Inisialisasi password toggle untuk settings
Â  Â  Â  Â  Â  Â  const currentPasswordToggle = document.getElementById('currentPasswordToggle');
Â  Â  Â  Â  Â  Â  if (currentPasswordToggle) {
Â  Â  Â  Â  Â  Â  Â  Â  currentPasswordToggle.addEventListener('click', function() {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  togglePasswordVisibility('currentPasswordDisplay', 'currentPasswordToggle');
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â Â 
// =====================
// REVISI RESET PASSWORD (OTP TELEGRAM & PIN)
// =====================

// Helper: tampilkan error detail
function handleServerError(err, context) {
Â  Â  console.error(context, err);
Â  Â  const msg = err?.message || "Kesalahan tidak diketahui";
Â  Â  showIOSNotify("Gagal", `${context}: ${msg}`);
}

// Helper: validasi format telegram
function normalizeTelegramID(input) {
Â  Â  let v = input.trim();
Â  Â  if (v.startsWith('@')) v = v.substring(1);
Â  Â  return v;
}

// REVISI: OTP Telegram dengan error detail
window.checkTelegramAndSendOTP = async () => {
Â  Â  const raw = document.getElementById('forgotTelegramID').value;
Â  Â  const telegramID = normalizeTelegramID(raw);
Â  Â  const btn = document.getElementById('sendTelegramOTPBtn');

Â  Â  if (!telegramID) {
Â  Â  Â  Â  return showIOSNotify("Input Salah", "ID Telegram wajib diisi.");
Â  Â  }

Â  Â  btn.disabled = true;
Â  Â  btn.innerText = "Memproses...";

Â  Â  try {
Â  Â  Â  Â  if (!auth.currentUser) {
Â  Â  Â  Â  Â  Â  await signInAnonymously(auth);
Â  Â  Â  Â  }

Â  Â  Â  Â  const q = query(collectionGroup(db, 'settings'), where('telegramID', '==', telegramID));
Â  Â  Â  Â  const snap = await getDocs(q);

Â  Â  Â  Â  if (snap.empty) {
Â  Â  Â  Â  Â  Â  throw new Error("ID Telegram tidak terdaftar.");
Â  Â  Â  Â  }

Â  Â  Â  Â  const docSnap = snap.docs[0];
Â  Â  Â  Â  verifiedUserUID = docSnap.ref.parent.parent.id;

Â  Â  Â  Â  generatedOTP = Math.floor(100000 + Math.random() * 900000).toString();

Â  Â  Â  Â  const payload = {
Â  Â  Â  Â  Â  Â  chat_id: telegramID,
Â  Â  Â  Â  Â  Â  text: `ðŸ” KODE OTP RESET PASSWORD\n\nKode OTP Anda: ${generatedOTP}\n\nBerlaku 5 menit.`
Â  Â  Â  Â  };

Â  Â  Â  Â  const tgResp = await fetch(`${CF_TELEGRAM_PROXY_BASE}/sendMessage`, {
Â  Â  Â  Â  Â  Â  method: "POST",
Â  Â  Â  Â  Â  Â  headers: { "Content-Type": "application/json" },
Â  Â  Â  Â  Â  Â  body: JSON.stringify(payload)
Â  Â  Â  Â  });

Â  Â  Â  Â  const tgJson = await tgResp.json();
Â  Â  Â  Â  if (!tgJson.ok) {
Â  Â  Â  Â  Â  Â  throw new Error(tgJson.description || "Telegram API error");
Â  Â  Â  Â  }

Â  Â  Â  Â  document.getElementById('otpInputContainer').classList.remove('hidden');
Â  Â  Â  Â  btn.innerText = "Verifikasi OTP";
Â  Â  Â  Â  btn.disabled = false;
Â  Â  Â  Â  btn.onclick = verifyTelegramOTP;

Â  Â  Â  Â  showIOSNotify("OTP Terkirim", "Silakan cek Telegram Anda.");
Â  Â  } catch (e) {
Â  Â  Â  Â  btn.disabled = false;
Â  Â  Â  Â  btn.innerText = "Kirim OTP";
Â  Â  Â  Â  handleServerError(e, "OTP Telegram");
Â  Â  }
};

// REVISI: verifikasi OTP
window.verifyTelegramOTP = async () => {
Â  Â  const input = document.getElementById('forgotTelegramOTP').value.trim();
Â  Â  if (!input) return showIOSNotify("OTP Kosong", "Masukkan kode OTP.");

Â  Â  if (input !== generatedOTP) {
Â  Â  Â  Â  return showIOSNotify("OTP Salah", "Kode OTP tidak cocok.");
Â  Â  }

Â  Â  openNewPasswordModal();
};

// REVISI: verifikasi PIN cadangan dengan error detail
window.verifyBackupPin = async () => {
Â  Â  const email = document.getElementById('forgotPinEmail').value.trim();
Â  Â  const pin = document.getElementById('forgotPinCode').value.trim();

Â  Â  if (!email || !pin) {
Â  Â  Â  Â  return showIOSNotify("Input Salah", "Email dan PIN wajib diisi.");
Â  Â  }
Â  Â  if (pin.length !== 6) {
Â  Â  Â  Â  return showIOSNotify("PIN Tidak Valid", "PIN harus 6 digit.");
Â  Â  }

Â  Â  try {
Â  Â  Â  Â  if (!auth.currentUser) {
Â  Â  Â  Â  Â  Â  await signInAnonymously(auth);
Â  Â  Â  Â  }

Â  Â  Â  Â  const q = query(collection(db, 'users'), where('email', '==', email));
Â  Â  Â  Â  const snap = await getDocs(q);
Â  Â  Â  Â  if (snap.empty) {
Â  Â  Â  Â  Â  Â  throw new Error("Email tidak ditemukan.");
Â  Â  Â  Â  }

Â  Â  Â  Â  const userDoc = snap.docs[0];
Â  Â  Â  Â  const data = userDoc.data();

Â  Â  Â  Â  if (!data.backupPIN) {
Â  Â  Â  Â  Â  Â  throw new Error("PIN cadangan belum diatur.");
Â  Â  Â  Â  }

Â  Â  Â  Â  if (data.backupPIN !== pin) {
Â  Â  Â  Â  Â  Â  throw new Error("PIN cadangan salah.");
Â  Â  Â  Â  }

Â  Â  Â  Â  verifiedUserUID = userDoc.id;
Â  Â  Â  Â  openNewPasswordModal();
Â  Â  } catch (e) {
Â  Â  Â  Â  handleServerError(e, "Verifikasi PIN");
Â  Â  }
};

function openNewPasswordModal() {
Â  Â  closeModals();
Â  Â  document.getElementById('modalOverlay').classList.add('active');
Â  Â  document.getElementById('newPasswordModal').classList.add('active');
}

</script>

<!-- Data Akun Popover (REVISI) -->
<div id="dataAkunPopover" class="ios-popover">
    <button class="popover-item" onclick="openAccountDetail()">
        <span>Lihat Detail</span>
    </button>
    <button class="popover-item" onclick="editAccountData()">
        <span>Edit Akun</span>
    </button>
    <button class="popover-item !text-red-500 font-bold" onclick="deleteAccountData()">
        <span>Hapus Akun</span>
    </button>
</div>

<script>
// ===== REVISI DATA AKUN POPOVER =====
let activeAccountId = null;

function openDataAkunPopover(event, accountId) {
    event.stopPropagation();
    activeAccountId = accountId;

    const popover = document.getElementById('dataAkunPopover');
    const rect = event.currentTarget.getBoundingClientRect();

    popover.style.top = (rect.top + window.scrollY + 10) + 'px';
    popover.style.left = (rect.right - 240) + 'px';
    popover.style.display = 'flex';

    document.addEventListener('click', closeDataAkunPopover);
}

function closeDataAkunPopover() {
    const popover = document.getElementById('dataAkunPopover');
    if (popover) popover.style.display = 'none';
    document.removeEventListener('click', closeDataAkunPopover);
}

function openAccountDetail() {
    showIOSNotify("Info Akun", "Detail akun: " + activeAccountId);
    closeDataAkunPopover();
}

function editAccountData() {
    showIOSNotify("Edit Akun", "Edit akun: " + activeAccountId);
    closeDataAkunPopover();
}

function deleteAccountData() {
    showIOSNotify("Hapus Akun", "Akun dihapus: " + activeAccountId);
    closeDataAkunPopover();
}
</script>

</body>
</html>
