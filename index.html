<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AhraStore Pro - Cloud Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        
        :root {
            --bg-dark: #000000;
            --card-bg: #1c1c1e;
            --card-secondary: #2c2c2e;
            --accent-blue: #0a84ff;
            --text-main: #ffffff;
            --text-secondary: #8e8e93;
            --ios-blur: rgba(28, 28, 30, 0.85);
            color-scheme: dark;
        }

        html, body {
            height: 100%;
            margin: 0;
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            overflow-x: hidden;
            -webkit-text-size-adjust: 100%;
            user-select: none;
        }

        .app-container {
            width: 100%;
            max-width: 450px;
            margin: 0 auto;
            min-height: 100dvh;
            display: flex;
            flex-direction: column;
            background-color: var(--bg-dark);
            position: relative;
        }

        /* Loading Screen */
        #loadingScreen {
            position: fixed;
            inset: 0;
            background: var(--bg-dark);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .ios-loader {
            width: 35px;
            height: 35px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top: 3px solid var(--accent-blue);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Login Screen */
        #loginScreen {
            position: fixed; inset: 0; background: black; z-index: 9000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 40px; text-align: center;
        }
        .login-logo {
            width: 80px; height: 80px; background: var(--accent-blue);
            border-radius: 22px; margin-bottom: 24px;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 10px 30px rgba(10, 132, 255, 0.3);
            overflow: hidden;
        }

        .shizuku-card {
            background-color: var(--card-bg);
            border-radius: 14px;
            padding: 16px;
            margin-bottom: 16px;
            border: 0.5px solid rgba(255, 255, 255, 0.05);
        }

        .ios-input-group {
            background-color: var(--card-secondary);
            border-radius: 12px;
            overflow: hidden;
            border: 0.5px solid rgba(255, 255, 255, 0.05);
            text-align: left;
        }

        .ios-input-row {
            display: flex;
            flex-direction: column;
            padding: 10px 16px;
            border-bottom: 0.5px solid rgba(255, 255, 255, 0.05);
            text-align: left;
        }
        .ios-input-row:last-child { border-bottom: none; }

        .row-label {
            font-size: 10px;
            font-weight: 800;
            color: var(--accent-blue);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 2px;
            text-align: left;
        }

        .pill-button {
            background-color: var(--accent-blue);
            color: white;
            border-radius: 12px;
            padding: 14px 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 15px;
            transition: all 0.2s;
            border: none;
            width: 100%;
            cursor: pointer;
        }
        .pill-button:active { transform: scale(0.96); opacity: 0.8; }

        .tab-btn {
            position: relative;
            padding: 12px 0;
            font-size: 11px;
            font-weight: 700;
            color: var(--text-secondary);
            transition: color 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .tab-btn.tab-active { color: var(--accent-blue); }
        .tab-btn.tab-active::after {
            content: '';
            position: absolute;
            bottom: 0; left: 25%; width: 50%; height: 3px;
            background-color: var(--accent-blue);
            border-radius: 3px 3px 0 0;
        }

        .ios-select-trigger {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            padding: 14px 16px;
            background-color: var(--card-secondary);
            border-radius: 12px;
            color: var(--text-main);
            font-size: 15px;
            cursor: pointer;
            transition: background 0.2s;
            border: 0.5px solid rgba(255, 255, 255, 0.05);
        }

        input, textarea {
            background: transparent !important;
            border: none !important;
            color: white !important;
            padding: 0 !important;
            font-size: 15px !important;
            width: 100%;
            outline: none;
            text-align: left;
        }
        input::placeholder { color: var(--text-secondary); }

        .ios-popover {
            position: absolute;
            background: var(--ios-blur);
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border-radius: 14px;
            z-index: 100;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            display: none;
            flex-direction: column;
            overflow: hidden;
            border: 0.5px solid rgba(255, 255, 255, 0.1);
            transform-origin: top right;
            animation: popIn 0.2s cubic-bezier(0.4, 0, 0.2, 1) forwards;
            width: 220px;
        }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .popover-item {
            padding: 14px 16px;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 0.5px solid rgba(255, 255, 255, 0.1);
            color: white;
            text-align: left;
            background: transparent;
        }
        .popover-item:last-child { border-bottom: none; }
        .popover-item:active { background: rgba(255,255,255,0.15); }

        .overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
            z-index: 8000;
            display: none;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .overlay.active { display: block; opacity: 1; }

        .bottom-sheet {
            position: fixed;
            bottom: 12px; left: 12px; right: 12px;
            background: var(--ios-blur);
            backdrop-filter: blur(30px) saturate(180%);
            border-radius: 20px;
            z-index: 8500;
            transform: translateY(120%);
            transition: transform 0.4s cubic-bezier(0.1, 0.7, 0.1, 1);
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0,0,0,0.6);
        }
        .bottom-sheet.active { transform: translateY(0); }

        .centered-modal {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            width: 90%; max-width: 360px;
            background: var(--ios-blur);
            backdrop-filter: blur(40px);
            border-radius: 24px;
            z-index: 9000;
            display: none;
            flex-direction: column;
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 0.5px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 20px 60px rgba(0,0,0,0.7);
        }
        .centered-modal.active { display: flex; opacity: 1; transform: translate(-50%, -50%) scale(1); }

        .picker-option {
            padding: 16px; text-align: center; font-size: 17px;
            color: var(--accent-blue); background: transparent;
            width: 100%; border-bottom: 0.5px solid rgba(255, 255, 255, 0.1);
        }
        .picker-option:active { background: rgba(255, 255, 255, 0.1); }

        .db-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 14px; }
        .db-card {
            background: var(--card-bg); border-radius: 16px; padding: 12px;
            border: 0.5px solid rgba(255, 255, 255, 0.05);
            position: relative; cursor: pointer;
        }

        .sold-badge {
            background: #ff3b30; color: white; font-size: 10px;
            padding: 2px 8px; border-radius: 6px; font-weight: 800;
            position: absolute; top: 10px; right: 10px;
            box-shadow: 0 2px 10px rgba(255, 59, 48, 0.3); z-index: 5;
        }

        /* iOS Professional Notification Card */
        #iosNotifyContainer {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-150%);
            width: calc(100% - 40px);
            max-width: 400px;
            z-index: 10000;
            transition: transform 0.6s cubic-bezier(0.19, 1, 0.22, 1);
        }
        #iosNotifyContainer.active { transform: translateX(-50%) translateY(0); }

        .ios-notification {
            background: rgba(44, 44, 46, 0.8);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-radius: 18px;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
            border: 0.5px solid rgba(255,255,255,0.1);
        }

        /* Toggle Switch Styling */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #3c3c3e;
            transition: .4s;
            border-radius: 34px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: #30d158;
        }

        input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }
    </style>
</head>
<body>

    <!-- iOS Notification Card -->
    <div id="iosNotifyContainer">
        <div class="ios-notification">
            <div id="notifyIconContainer" class="w-10 h-10 rounded-xl flex items-center justify-center">
                <!-- Icon injected by JS -->
            </div>
            <div class="flex-1">
                <p id="notifyTitle" class="text-[14px] font-bold text-white"></p>
                <p id="notifyMessage" class="text-[13px] text-zinc-300 leading-tight"></p>
            </div>
        </div>
    </div>

    <!-- Loading Screen -->
    <div id="loadingScreen">
        <div class="ios-loader"></div>
        <p class="mt-6 text-[10px] font-bold text-[#8e8e93] tracking-[0.2em] uppercase">AhraStore</p>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="hidden">
        <div class="login-logo">
            <img src="https://i.postimg.cc/8sK6LGQG/image.png" alt="Logo" class="w-full h-full object-cover">
        </div>
        <h2 class="text-3xl font-bold tracking-tight mb-2">Selamat Datang Di AHRASTORE.apk</h2>
        <p class="text-[14px] text-zinc-500 mb-10">Silahkan Login Untuk Lanjut</p>
        
        <div class="w-full max-w-xs space-y-4">
            <div class="ios-input-group">
                <div class="ios-input-row">
                    <span class="row-label">Email</span>
                    <input type="email" id="loginEmail" placeholder="email@contoh.com">
                </div>
                <div class="ios-input-row">
                    <span class="row-label">Password</span>
                    <div class="flex items-center">
                        <input type="password" id="loginPass" placeholder="••••••••" class="flex-1">
                        <button type="button" onclick="toggleLoginPassword()" class="p-1 text-zinc-500">
                            <svg id="eyeIcon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11-8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                        </button>
                    </div>
                </div>
            </div>
            <button id="loginBtn" onclick="handleEmailAuth('login')" class="pill-button">MASUK</button>
            <button id="signupBtn" onclick="handleEmailAuth('signup')" class="pill-button !bg-zinc-800 !text-blue-500">DAFTAR BARU</button>
            
            <div class="flex items-center gap-4 py-2">
                <div class="h-[1px] bg-zinc-800 flex-1"></div>
                <span class="text-[9px] text-zinc-500 font-bold uppercase">Atau</span>
                <div class="h-[1px] bg-zinc-800 flex-1"></div>
            </div>

            <button id="googleLoginBtn" onclick="handleGoogleAuth()" class="pill-button !bg-white !text-black">
                <svg width="18" height="18" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
                Google
            </button>
        </div>
    </div>

    <!-- Setup Username Modal (New User) -->
    <div id="setupUsernameModal" class="centered-modal">
        <div class="p-8 text-center">
            <div class="w-16 h-16 bg-blue-500 rounded-3xl flex items-center justify-center mx-auto mb-4 shadow-xl shadow-blue-500/20">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
            </div>
            <h3 class="text-xl font-bold mb-1 text-white">Lengkapi Profil</h3>
            <p class="text-[13px] text-zinc-500 mb-6">Silahkan masukkan username anda untuk melanjutkan.</p>
            
            <div class="ios-input-group mb-6">
                <div class="ios-input-row">
                    <span class="row-label">Username</span>
                    <input type="text" id="newUsername" placeholder="Contoh: AdminGanteng" maxlength="15">
                </div>
            </div>

            <button onclick="saveInitialUsername()" id="saveUsernameBtn" class="pill-button">SIMPAN PROFIL</button>
        </div>
    </div>

    <!-- App Container -->
    <div id="app" class="app-container" style="display:none;">
        <header class="px-6 py-4 flex justify-between items-end bg-black/80 backdrop-blur-xl sticky top-0 z-40 border-b border-white/5">
            <div class="flex items-center gap-3">
                <!-- UPDATED: Profile Photo Container always visible, toggles child visibility -->
                <div id="headerProfilePhoto" class="w-12 h-12 rounded-full bg-zinc-800 border-2 border-white/10 overflow-hidden flex items-center justify-center">
                    <img id="headerProfileImg" src="" class="w-full h-full object-cover hidden">
                    <svg id="headerProfilePlaceholder" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#444" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                </div>
                <div>
                    <h1 id="welcomeHeader" class="text-2xl font-bold text-white tracking-tight">Halo User</h1>
                    <div class="flex items-center gap-1.5 mt-0.5">
                        <div id="statusDot" class="w-2 h-2 rounded-full bg-green-500 transition-colors duration-300"></div>
                        <span id="connectionLabel" class="text-[10px] font-bold text-zinc-500 uppercase tracking-wider">Online</span>
                    </div>
                </div>
            </div>
            <button id="settingsBtn" onclick="toggleAhraPopover('settingsOverlay')" class="p-2 text-blue-500 transition-all duration-300">
                <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0a2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
            </button>

            <div id="settingsOverlay" class="ios-popover" style="top: 75px; right: 20px;">
                <button onclick="openProfileSettings(); closeAllPopovers();" class="popover-item">
                    <span>Pengaturan Akun</span>
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                </button>
                <button onclick="exportJSON(); closeAllPopovers();" class="popover-item">
                    <span>Export Data (.json)</span>
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                </button>
                <button onclick="handleLogout()" class="popover-item !text-red-500 font-bold">
                    <span>Logout Akun</span>
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                </button>
            </div>
        </header>

        <nav class="flex px-4 bg-black/80 backdrop-blur-xl border-b border-white/5 sticky top-[75px] z-30">
            <button onclick="switchTab('stok')" id="tab-stok" class="tab-btn flex-1 tab-active">Stok</button>
            <button onclick="switchTab('testi')" id="tab-testi" class="tab-btn flex-1">Testi</button>
            <button onclick="switchTab('save')" id="tab-save" class="tab-btn flex-1">Simpan</button>
            <button onclick="switchTab('db')" id="tab-db" class="tab-btn flex-1">Data akun</button>
        </nav>

        <main id="mainContent" class="p-5 flex-grow pb-28">
            <!-- Section Stok (Fast Post) -->
            <section id="section-stok">
                <div class="shizuku-card">
                    <h2 class="text-[12px] font-bold mb-5 text-zinc-500 uppercase tracking-widest">Telegram Post</h2>
                    <form id="formStok" class="space-y-4">
                        <div class="ios-input-group">
                            <div class="ios-input-row">
                                <span class="row-label">Bukti Foto</span>
                                <label for="stokImage" class="flex justify-between items-center cursor-pointer py-1" onclick="openGallery('stokImage')">
                                    <span id="label-stokImage" class="text-[15px] text-zinc-500">Pilih Foto...</span>
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-blue-500"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
                                    <input type="file" id="stokImage" accept="image/*" required class="hidden">
                                </label>
                            </div>
                            <div class="ios-input-row"><span class="row-label">Harga</span><input type="text" id="stokHarga" placeholder="Contoh: 50k" required></div>
                        </div>
                        <div class="ios-select-trigger" id="triggerStokInfo" onclick="openIOSPicker('STATUS INFORMASI', ['Mail fresh', 'Free change email'], 'stokInfo')">
                            <span id="labelStokInfo">Pilih Status...</span>
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#8e8e93" stroke-width="2.5"><path d="M6 9l6 6 6-6"/></svg>
                        </div>
                        <input type="hidden" id="stokInfo">
                        <button type="submit" class="pill-button mt-2">KIRIM KE CHANNEL</button>
                    </form>
                </div>
            </section>

            <!-- Section Testi -->
            <section id="section-testi" class="hidden">
                <div class="shizuku-card">
                    <h2 class="text-[12px] font-bold mb-5 text-zinc-500 uppercase tracking-widest">Testimoni Post</h2>
                    <form id="formTesti" class="space-y-4">
                        <div class="ios-input-group">
                            <div class="ios-input-row">
                                <span class="row-label">Bukti Transaksi</span>
                                <label for="testiImage" class="flex justify-between items-center cursor-pointer py-1" onclick="openGallery('testiImage')">
                                    <span id="label-testiImage" class="text-[15px] text-zinc-500">Pilih Foto...</span>
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-blue-500"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
                                    <input type="file" id="testiImage" accept="image/*" required class="hidden">
                                </label>
                            </div>
                            <div class="ios-input-row" onclick="openIOSDatePicker()">
                                <span class="row-label">Tanggal</span>
                                <div class="flex justify-between items-center cursor-pointer">
                                    <span id="labelTestiTanggal" class="text-[15px] text-zinc-500">Pilih Tanggal...</span>
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#8e8e93" stroke-width="2.5"><path d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                                </div>
                                <input type="hidden" id="testiTanggal" required>
                            </div>
                            <div class="ios-input-row"><span class="row-label">Harga</span><input type="text" id="testiHarga" placeholder="Harga Transaksi" required></div>
                        </div>
                        <div class="ios-select-trigger" id="triggerTestiAkun" onclick="openTestimoniPicker()">
                            <span id="labelTestiAkun">Pilih Tingkatan...</span>
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#8e8e93" stroke-width="2.5"><path d="M6 9l6 6 6-6"/></svg>
                        </div>
                        <input type="hidden" id="testiAkun">
                        <button type="submit" class="pill-button !bg-green-500">POST TESTIMONI</button>
                    </form>
                </div>
            </section>

            <!-- Section Simpan ke DB -->
            <section id="section-save" class="hidden">
                <div class="shizuku-card">
                    <h2 id="saveFormTitle" class="text-[12px] font-bold mb-5 text-zinc-500 uppercase tracking-widest">Database Input</h2>
                    <form id="formSave" class="space-y-4">
                        <div class="ios-input-group">
                            <div class="ios-input-row">
                                <span class="row-label">Foto Akun</span>
                                <label for="saveImage" class="flex justify-between items-center cursor-pointer py-1" onclick="openGallery('saveImage')">
                                    <span id="label-saveImage" class="text-[15px] text-zinc-500">Pilih Foto...</span>
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-blue-500"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
                                    <input type="file" id="saveImage" accept="image/*" class="hidden">
                                </label>
                            </div>
                        </div>
                        <div class="ios-select-trigger" id="triggerSaveType" onclick="openIOSPicker('JENIS AKUN', ['Mail fresh', 'Mail own', 'Monkos', 'Galver'], 'saveType', true)">
                            <span id="labelSaveType">Pilih Jenis Akun...</span>
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#8e8e93" stroke-width="2.5"><path d="M6 9l6 6 6-6"/></svg>
                        </div>
                        <input type="hidden" id="saveType">
                        <div id="dynamicFields" class="space-y-4"></div>
                        <button type="submit" class="pill-button mt-4 !bg-blue-600">SIMPAN KE CLOUD</button>
                    </form>
                </div>
            </section>

            <!-- Section Katalog DB -->
            <section id="section-db" class="hidden">
                <div class="flex justify-between items-center mb-5 px-1">
                    <h2 class="text-[12px] font-bold text-zinc-500 uppercase tracking-widest">Katalog Cloud</h2>
                    <span id="dbCount" class="text-[10px] bg-blue-500/20 text-blue-400 px-3 py-1 rounded-full font-extrabold">0 Item</span>
                </div>
                <div id="databaseGrid" class="db-grid"></div>
            </section>

            <div id="statusMsg" class="mt-6 p-4 rounded-xl hidden text-center text-[13px] font-semibold transition-all shadow-xl"></div>
        </main>
    </div>

    <!-- Modals -->
    <div id="modalOverlay" class="overlay"></div>
    
    <div id="iosPickerSheet" class="bottom-sheet">
        <div class="picker-header p-4 border-b border-white/5"><h3 id="pickerTitle" class="text-[13px] font-bold text-zinc-500 uppercase text-center">Judul</h3></div>
        <div id="pickerOptionsContainer" class="flex flex-col max-h-[60vh] overflow-y-auto"></div>
        <div class="px-4 pb-4"><button onclick="closeModals()" class="mt-2 w-full p-4 bg-zinc-800/80 rounded-2xl text-blue-500 font-bold">Batal</button></div>
    </div>

    <div id="iosDetailModal" class="centered-modal">
        <div class="p-6">
            <h3 id="modalTitle" class="text-lg font-bold mb-2 text-center">Judul Modal</h3>
            <div id="modalBody" class="space-y-4 max-h-[50vh] overflow-y-auto"></div>
        </div>
        <div class="flex border-t border-white/10">
            <button id="modalBtnCancel" onclick="closeModals()" class="flex-1 p-4 text-blue-500 font-medium border-r border-white/10">Tutup</button>
            <button id="modalBtnAction" class="flex-1 p-4 text-blue-500 font-bold hidden">Simpan</button>
        </div>
    </div>

    <!-- Account Settings Modal -->
    <div id="accountSettingsModal" class="centered-modal">
        <div class="p-6">
            <h3 class="text-lg font-bold mb-4 text-center">Pengaturan Akun</h3>
            <div class="space-y-4 max-h-[60vh] overflow-y-auto pr-1">
                <div class="flex flex-col items-center mb-6">
                    <label for="editProfilePhoto" class="relative cursor-pointer" onclick="openGallery('editProfilePhoto')">
                        <div id="modalProfileCircle" class="w-24 h-24 rounded-full bg-zinc-800 border-2 border-blue-500/30 overflow-hidden flex items-center justify-center">
                            <img id="modalProfileImg" src="" class="w-full h-full object-cover hidden">
                            <svg id="profilePlaceholder" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#444" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                        </div>
                        <div class="absolute bottom-0 right-0 bg-blue-500 p-2 rounded-full shadow-lg">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
                        </div>
                        <input type="file" id="editProfilePhoto" accept="image/*" class="hidden">
                    </label>
                    <p class="text-[10px] text-blue-500 font-bold uppercase tracking-widest mt-3">Ketuk Foto Untuk Ganti</p>
                </div>

                <div class="ios-input-group">
                    <div class="ios-input-row">
                        <span class="row-label">Username</span>
                        <input type="text" id="editUsername" placeholder="Username Anda">
                    </div>
                    <div class="ios-input-row">
                        <span class="row-label">Email Terdaftar</span>
                        <span id="displayEmail" class="text-[15px] text-zinc-500 py-1">email@loading...</span>
                    </div>
                </div>

                <div class="pt-2">
                    <p class="text-[10px] font-bold text-zinc-500 uppercase tracking-widest mb-2 ml-1">Ganti Password (Opsional)</p>
                    <div class="ios-input-group">
                        <div class="ios-input-row">
                            <span class="row-label">Password Lama</span>
                            <input type="password" id="oldPassword" placeholder="Konfirmasi Password Saat Ini">
                        </div>
                        <div class="ios-input-row">
                            <span class="row-label">Password Baru</span>
                            <input type="password" id="newPassword" placeholder="Minimal 6 Karakter">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="flex border-t border-white/10">
            <button onclick="closeModals()" class="flex-1 p-4 text-zinc-400 font-medium border-r border-white/10">Batal</button>
            <button onclick="saveAccountSettings()" id="saveAccountBtn" class="flex-1 p-4 text-blue-500 font-bold">Simpan</button>
        </div>
    </div>

    <div id="itemActionMenu" class="ios-popover" style="width: 220px;">
        <button onclick="handleAction('detail')" class="popover-item"><span>Detail Akun</span><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg></button>
        <button onclick="handleAction('edit')" class="popover-item"><span>Edit Data</span><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button>
        <button onclick="handleAction('sold')" class="popover-item"><span>Status Sold</span><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/></svg></button>
        <button onclick="handleAction('send_admin')" class="popover-item"><span>Kirim ke Admin</span><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 2 15 22 11 13 2 9 22 2"/></svg></button>
        <button onclick="handleAction('send_buyer')" class="popover-item"><span>Kirim ke Buyer</span><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></button>
        <button onclick="handleAction('delete')" class="popover-item !text-red-500"><span>Hapus</span><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/></svg></button>
    </div>

    <!-- Firebase SDK Modules -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, 
            GoogleAuthProvider, signInWithPopup, signOut, updatePassword, reauthenticateWithCredential, EmailAuthProvider 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, collection, addDoc, doc, onSnapshot, deleteDoc, updateDoc, query, orderBy, getDoc, setDoc 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- KONFIGURASI TELEGRAM ---
        const TELEGRAM_BOT_TOKEN = "7699614697:AAH3nlKT-dKETar5GEDPy6k2cVRyZpuLuao";
        const TELEGRAM_CHAT_ID = "7423591679"; 

        // --- KONFIGURASI FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyBVk932P_IbgAh6hoZ9HhnPNzdYsthIl04",
            authDomain: "ahrastore-14913.firebaseapp.com",
            projectId: "ahrastore-14913",
            storageBucket: "ahrastore-14913.appspot.com",
            messagingSenderId: "751112680601",
            appId: "1:751112680601:web:efd16728078d392d67f408",
            measurementId: "G-JLFVMMRH8M"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'ahra-store-pro';

        let user = null;
        let accounts = [];
        let activeId = null;
        let currentUserData = {};

        // --- FUNGSI UNTUK MEMBUKA GALERI ---
        window.openGallery = function(inputId) {
            const input = document.getElementById(inputId);
            if (!input) return;
            
            // Untuk mobile, kita coba paksa ke galeri
            if ('showPicker' in HTMLInputElement.prototype) {
                // Metode modern
                input.showPicker();
            } else {
                // Metode fallback
                input.click();
            }
        };

        // --- AUTH OBSERVER ---
        onAuthStateChanged(auth, async (u) => {
            user = u;
            const loader = document.getElementById('loadingScreen');
            const login = document.getElementById('loginScreen');
            const appEl = document.getElementById('app');

            if (u) {
                // Check user profile for username
                await checkUserProfile(u);
                
                login.style.display = 'none';
                appEl.style.display = 'flex';
                appEl.classList.remove('hidden');
                
                updateConnectionStatus(true);
                initDatabase();
            } else {
                appEl.style.display = 'none';
                login.style.display = 'flex';
                document.getElementById('setupUsernameModal').classList.remove('active');
                document.getElementById('accountSettingsModal').classList.remove('active');
                document.getElementById('modalOverlay').classList.remove('active');
                resetProfileUI();
            }

            if (loader) {
                loader.style.opacity = '0';
                setTimeout(() => loader.style.display = 'none', 500);
            }
        });

        // --- PROFILE SYSTEM ---
        async function checkUserProfile(u) {
            try {
                const profileRef = doc(db, 'artifacts', appId, 'users', u.uid, 'settings', 'profile');
                const profileSnap = await getDoc(profileRef);

                if (profileSnap.exists()) {
                    currentUserData = profileSnap.data();
                    updateProfileUI(currentUserData);
                } else {
                    document.getElementById('modalOverlay').classList.add('active');
                    document.getElementById('setupUsernameModal').classList.add('active');
                }
            } catch (err) {
                console.error("Profile check failed:", err);
            }
        }

        function updateProfileUI(data) {
            document.getElementById('welcomeHeader').innerText = `Halo ${data.username || 'User'}`;
            
            // Header Image Logic - UPDATED
            const headerImg = document.getElementById('headerProfileImg');
            const headerPlaceholder = document.getElementById('headerProfilePlaceholder');
            
            if (data.profileImage) {
                headerImg.src = data.profileImage;
                headerImg.classList.remove('hidden');
                headerPlaceholder.classList.add('hidden');
            } else {
                headerImg.classList.add('hidden');
                headerPlaceholder.classList.remove('hidden');
            }

            // Modal Pre-fill
            document.getElementById('editUsername').value = data.username || '';
            document.getElementById('displayEmail').innerText = user?.email || 'N/A';
            
            const modalImg = document.getElementById('modalProfileImg');
            const modalPlaceholder = document.getElementById('profilePlaceholder');
            if (data.profileImage) {
                modalImg.src = data.profileImage;
                modalImg.classList.remove('hidden');
                modalPlaceholder.classList.add('hidden');
            } else {
                modalImg.classList.add('hidden');
                modalPlaceholder.classList.remove('hidden');
            }
        }

        function resetProfileUI() {
            const headerImg = document.getElementById('headerProfileImg');
            const headerPlaceholder = document.getElementById('headerProfilePlaceholder');
            headerImg.classList.add('hidden');
            headerPlaceholder.classList.remove('hidden');
            document.getElementById('welcomeHeader').innerText = 'Halo User';
        }

        window.saveInitialUsername = async () => {
            const username = document.getElementById('newUsername').value.trim();
            const btn = document.getElementById('saveUsernameBtn');
            
            if (!username || username.length < 3) {
                return showIOSNotify("Username Terlalu Pendek", "Gunakan minimal 3 karakter.");
            }

            btn.disabled = true;
            btn.innerText = "Menyimpan...";

            try {
                const profileRef = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'profile');
                const newData = {
                    username: username,
                    createdAt: Date.now()
                };
                await setDoc(profileRef, newData);
                currentUserData = newData;
                updateProfileUI(newData);
                
                document.getElementById('setupUsernameModal').classList.remove('active');
                document.getElementById('modalOverlay').classList.remove('active');
                showIOSNotify("Profil Diperbarui", `Halo ${username}, selamat datang!`, false);
            } catch (err) {
                showIOSNotify("Gagal Simpan", "Terjadi kesalahan saat menyimpan profil.");
            } finally {
                btn.disabled = false;
                btn.innerText = "SIMPAN PROFIL";
            }
        };

        // --- ACCOUNT SETTINGS ACTIONS ---
        window.openProfileSettings = () => {
            document.getElementById('modalOverlay').classList.add('active');
            document.getElementById('accountSettingsModal').classList.add('active');
        };

        window.previewProfilePhoto = (input) => {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const modalImg = document.getElementById('modalProfileImg');
                    modalImg.src = e.target.result;
                    modalImg.classList.remove('hidden');
                    document.getElementById('profilePlaceholder').classList.add('hidden');
                };
                reader.readAsDataURL(input.files[0]);
            }
        };

        window.saveAccountSettings = async () => {
            const username = document.getElementById('editUsername').value.trim();
            const oldPass = document.getElementById('oldPassword').value;
            const newPass = document.getElementById('newPassword').value;
            const btn = document.getElementById('saveAccountBtn');
            const photoFile = document.getElementById('editProfilePhoto').files[0];

            if (username.length < 3) return showIOSNotify("Username Pendek", "Minimal 3 karakter.");
            
            btn.disabled = true;
            btn.innerText = "Saving...";

            try {
                // 1. Handle Profile Data (Username & Image)
                const updates = { username: username };
                if (photoFile) {
                    updates.profileImage = await new Promise(r => { 
                        const fr = new FileReader(); 
                        fr.onload = () => r(fr.result); 
                        fr.readAsDataURL(photoFile); 
                    });
                } else if (currentUserData.profileImage) {
                    updates.profileImage = currentUserData.profileImage;
                }

                const profileRef = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'profile');
                await updateDoc(profileRef, updates);
                currentUserData = { ...currentUserData, ...updates };
                updateProfileUI(currentUserData);

                // 2. Handle Password Change
                if (newPass) {
                    if (!oldPass) {
                        btn.disabled = false; btn.innerText = "Simpan";
                        return showIOSNotify("Konfirmasi Password", "Masukkan password lama untuk ganti password.");
                    }
                    if (newPass.length < 6) {
                         btn.disabled = false; btn.innerText = "Simpan";
                         return showIOSNotify("Password Lemah", "Password baru minimal 6 karakter.");
                    }

                    const credential = EmailAuthProvider.credential(user.email, oldPass);
                    await reauthenticateWithCredential(user, credential);
                    await updatePassword(user, newPass);
                    showIOSNotify("Password Diganti", "Password Anda berhasil diperbarui.", false);
                }

                showIOSNotify("Profil Diperbarui", "Data akun berhasil disimpan.", false);
                closeModals();
            } catch (err) {
                console.error(err);
                let msg = "Terjadi kesalahan saat menyimpan.";
                if (err.code === 'auth/wrong-password') msg = "Password lama tidak sesuai.";
                showIOSNotify("Gagal Update", msg);
            } finally {
                btn.disabled = false;
                btn.innerText = "Simpan";
                document.getElementById('oldPassword').value = "";
                document.getElementById('newPassword').value = "";
            }
        };

        function updateConnectionStatus(isOnline) {
            const label = document.getElementById('connectionLabel');
            const dot = document.getElementById('statusDot');
            if (isOnline) {
                label.innerText = "Online";
                label.classList.replace('text-red-500', 'text-zinc-500');
                dot.classList.replace('bg-red-500', 'bg-green-500');
            } else {
                label.innerText = "Offline";
                label.classList.replace('text-zinc-500', 'text-red-500');
                dot.classList.replace('bg-green-500', 'bg-red-500');
            }
        }

        window.addEventListener('offline', () => updateConnectionStatus(false));
        window.addEventListener('online', () => updateConnectionStatus(true));

        // --- LOGIN UI ACTIONS ---
        window.toggleLoginPassword = () => {
            const passInput = document.getElementById('loginPass');
            const eyeIcon = document.getElementById('eyeIcon');
            if (passInput.type === 'password') {
                passInput.type = 'text';
                eyeIcon.innerHTML = '<path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/>';
            } else {
                passInput.type = 'password';
                eyeIcon.innerHTML = '<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>';
            }
        };

        // --- iOS Professional Notification System ---
        window.showIOSNotify = (title, message, isError = true) => {
            const container = document.getElementById('iosNotifyContainer');
            const titleEl = document.getElementById('notifyTitle');
            const msgEl = document.getElementById('notifyMessage');
            const iconContainer = document.getElementById('notifyIconContainer');
            
            titleEl.innerText = title;
            msgEl.innerText = message;
            
            if(isError) {
                iconContainer.className = "w-10 h-10 rounded-xl flex items-center justify-center bg-red-500/20 text-red-500";
                iconContainer.innerHTML = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>';
            } else {
                iconContainer.className = "w-10 h-10 rounded-xl flex items-center justify-center bg-green-500/20 text-green-500";
                iconContainer.innerHTML = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>';
            }
            
            container.classList.add('active');
            setTimeout(() => {
                container.classList.remove('active');
            }, 4000);
        };

        // --- AUTH ACTIONS ---
        window.handleEmailAuth = async (type) => {
            const e = document.getElementById('loginEmail').value;
            const p = document.getElementById('loginPass').value;
            const btn = type === 'login' ? document.getElementById('loginBtn') : document.getElementById('signupBtn');
            
            if(!e || !p) return showIOSNotify("Form Tidak Lengkap", "Silakan isi email dan password Anda.");
            
            btn.disabled = true;
            btn.innerText = "Processing...";
            
            try {
                if(type === 'login') {
                    await signInWithEmailAndPassword(auth, e, p);
                } else {
                    await createUserWithEmailAndPassword(auth, e, p);
                }
            } catch(err) { 
                console.error(err.code);
                let title = "Autentikasi Gagal";
                let msg = "Terjadi kesalahan saat memproses data.";
                
                switch(err.code) {
                    case 'auth/email-already-in-use':
                        title = "Email Terdaftar";
                        msg = "Email ini sudah digunakan oleh akun lain.";
                        break;
                    case 'auth/invalid-email':
                        title = "Email Tidak Valid";
                        msg = "Format email yang Anda masukkan salah.";
                        break;
                    case 'auth/user-not-found':
                        title = "Akun Tidak Ada";
                        msg = "Kami tidak dapat menemukan akun dengan email ini.";
                        break;
                    case 'auth/wrong-password':
                        title = "Password Salah";
                        msg = "Kata sandi yang Anda masukkan tidak sesuai.";
                        break;
                    case 'auth/weak-password':
                        title = "Password Lemah";
                        msg = "Password harus minimal 6 karakter.";
                        break;
                }
                showIOSNotify(title, msg);
            } finally {
                btn.disabled = false;
                btn.innerText = type === 'login' ? "MASUK" : "DAFTAR BARU";
            }
        };

        window.handleGoogleAuth = async () => {
            const btn = document.getElementById('googleLoginBtn');
            if (!btn) return;
            
            btn.disabled = true;
            btn.innerText = "Loading...";
            
            try { 
                // Gunakan Google Auth Provider
                const provider = new GoogleAuthProvider();
                
                // Tambahkan scopes jika diperlukan
                provider.addScope('profile');
                provider.addScope('email');
                
                // Konfigurasi untuk popup
                provider.setCustomParameters({
                    prompt: 'select_account' // Memaksa user memilih akun
                });
                
                console.log("Memulai login Google...");
                
                // Gunakan signInWithPopup untuk membuka popup
                const result = await signInWithPopup(auth, provider);
                
                console.log("Login Google berhasil:", result.user.email);
                
                // Login berhasil, observer akan menangani sisanya
                
            } catch(error) { 
                console.error("Error Google Auth:", error);
                
                let errorMessage = "Gagal melakukan autentikasi dengan akun Google.";
                
                // Handle error spesifik
                if (error.code === 'auth/popup-blocked') {
                    errorMessage = "Popup diblokir. Izinkan popup untuk login dengan Google.";
                } else if (error.code === 'auth/popup-closed-by-user') {
                    errorMessage = "Popup login ditutup sebelum selesai.";
                } else if (error.code === 'auth/unauthorized-domain') {
                    errorMessage = "Domain ini tidak diizinkan untuk login Google. Tambahkan domain di Firebase Console.";
                } else if (error.code === 'auth/operation-not-allowed') {
                    errorMessage = "Login dengan Google belum diaktifkan di Firebase Console.";
                }
                
                showIOSNotify("Google Auth Gagal", errorMessage);
                
                // Reset button state
                btn.disabled = false;
                btn.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg> Google';
            } finally {
                // Pastikan button kembali normal
                setTimeout(() => {
                    btn.disabled = false;
                    btn.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg> Google';
                }, 1000);
            }
        };

        window.handleLogout = () => { 
            if(confirm("Keluar dari aplikasi?")) {
                signOut(auth);
                showIOSNotify("Logout Berhasil", "Anda telah keluar dari akun.", false);
            }
        };

        // --- FIRESTORE DATABASE LOGIC ---
        function initDatabase() {
            if(!user) return;
            const q = query(
                collection(db, 'artifacts', appId, 'users', user.uid, 'stok'),
                orderBy('timestamp', 'desc')
            );
            
            onSnapshot(q, (snap) => {
                accounts = [];
                snap.forEach(d => accounts.push({id: d.id, ...d.data()}));
                renderDatabase();
            }, (error) => {
                console.error(error);
            });
        }

        function renderDatabase() {
            const grid = document.getElementById('databaseGrid');
            grid.innerHTML = "";
            document.getElementById('dbCount').innerText = `${accounts.length} Item`;
            
            accounts.forEach(acc => {
                const card = document.createElement('div');
                card.className = "db-card";
                card.onclick = (e) => {
                    activeId = acc.id;
                    const menu = document.getElementById('itemActionMenu');
                    const rect = card.getBoundingClientRect();
                    const containerRect = document.querySelector('.app-container').getBoundingClientRect();
                    let topPos = rect.top - containerRect.top + 40;
                    let leftPos = rect.left - containerRect.left + 20;
                    if(leftPos + 220 > containerRect.width) leftPos = containerRect.width - 240;
                    
                    menu.style.top = `${topPos}px`;
                    menu.style.left = `${leftPos}px`;
                    menu.style.display = 'flex';
                    e.stopPropagation();
                };
                card.innerHTML = `
                    <div class="h-32 bg-zinc-900 rounded-xl mb-3 overflow-hidden relative flex items-center justify-center">
                        ${acc.isSold ? '<div class="sold-badge">SOLD</div>' : ''}
                        ${acc.image ? `<img src="${acc.image}" class="w-full h-full object-cover ${acc.isSold?'grayscale opacity-30':''}">` : '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#2c2c2e" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>'}
                    </div>
                    <p class="text-[13px] font-bold truncate px-1">${acc.dbEmail || acc.dbName || 'No Name'}</p>
                    <p class="text-[9px] text-zinc-500 font-bold uppercase mt-0.5 px-1">${acc.type}</p>
                `;
                grid.appendChild(card);
            });
        }

        // Action Handlers
        window.handleAction = async (type) => {
            const acc = accounts.find(a => a.id === activeId);
            document.getElementById('itemActionMenu').style.display = 'none';
            if(!acc) return;

            const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'stok', activeId);

            if(type === 'detail') {
                document.getElementById('modalTitle').innerText = "Detail Akun";
                let html = '<div class="ios-input-group">';
                const fields = { 'type': 'Jenis', 'dbEmail': 'Email', 'dbPassG': 'Password G', 'dbPassM': 'Password M', 'dbBackup': 'Kode Cadangan', 'dbName': 'Nama/ID', 'dbLoginVia': 'Login Via' };
                for(let key in fields) {
                    if(acc[key]) html += `<div class="ios-input-row"><span class="row-label">${fields[key]}</span><span class="text-sm font-medium break-all text-white/90">${acc[key]}</span></div>`;
                }
                html += '</div>';
                document.getElementById('modalBody').innerHTML = html;
                document.getElementById('modalBtnAction').classList.add('hidden');
                document.getElementById('modalOverlay').classList.add('active');
                document.getElementById('iosDetailModal').classList.add('active');
            } 
            else if (type === 'edit') {
                openEditModal(acc);
            }
            else if (type === 'sold') {
                await updateDoc(docRef, { isSold: !acc.isSold });
                showIOSNotify("Status Diperbarui", "Status penjualan akun telah diubah.", false);
            } 
            else if (type === 'delete') {
                if(confirm("Hapus stok ini permanen dari Cloud?")) {
                    await deleteDoc(docRef);
                    showIOSNotify("Terhapus", "Data akun telah dihapus dari cloud.", false);
                }
            }
            else if (type === 'send_admin') {
                 let text = `🚀 <b>DETAIL AKUN (ADMIN)</b>\nJenis: ${acc.type}\n--------------------------------\n`;
                 ['dbEmail', 'dbPassG', 'dbPassM', 'dbLoginVia', 'dbName'].forEach(k => { if(acc[k]) text += `<b>${k.replace('db','')} :</b> <code>${acc[k]}</code>\n`; });
                 await sendAccountToTelegram(TELEGRAM_CHAT_ID, text, acc.image);
            }
            else if (type === 'send_buyer') {
                document.getElementById('modalTitle').innerText = "Kirim ke Buyer";
                const body = document.getElementById('modalBody');
                body.innerHTML = `<div class="ios-input-group"><div class="ios-input-row"><span class="row-label">Username Buyer</span><input type="text" id="buyerUsername" placeholder="@username" required></div></div>`;
                const action = document.getElementById('modalBtnAction');
                action.innerText = "Kirim Data"; action.classList.remove('hidden');
                action.onclick = async () => {
                    const buyer = document.getElementById('buyerUsername').value;
                    if(!buyer) return;
                    let text = `✨ <b>DETAIL AKUN BY AHRASTORE</b>\nBuyer: ${buyer}\n--------------------------------\n`;
                    ['dbEmail', 'dbPassG', 'dbPassM', 'dbLoginVia', 'dbName', 'dbBackup'].forEach(k => { if(acc[k]) text += `<b>${k.replace('db','')} :</b> <code>${acc[k]}</code>\n`; });
                    text += `\n--------------------------------\nStok: @StokAhraStore2`;
                    closeModals(); await sendAccountToTelegram(TELEGRAM_CHAT_ID, text, acc.image);
                };
                document.getElementById('modalOverlay').classList.add('active');
                document.getElementById('iosDetailModal').classList.add('active');
            }
        };

        // --- FUNGSI EDIT DATA ---
        function openEditModal(account) {
            document.getElementById('modalTitle').innerText = "Edit Data Akun";
            
            let html = `
                <form id="editForm" class="space-y-4">
                    <div class="ios-input-group">
                        <div class="ios-input-row">
                            <span class="row-label">Foto Akun (Opsional)</span>
                            <label for="editImage" class="flex justify-between items-center cursor-pointer py-1" onclick="openGallery('editImage')">
                                <span id="label-editImage" class="text-[15px] ${account.image ? 'text-white' : 'text-zinc-500'}">
                                    ${account.image ? 'Ganti foto...' : 'Unggah foto...'}
                                </span>
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-blue-500">
                                    <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
                                    <circle cx="12" cy="13" r="4"/>
                                </svg>
                                <input type="file" id="editImage" accept="image/*" class="hidden">
                            </label>
                            ${account.image ? `
                            <div class="mt-2">
                                <p class="text-[10px] text-zinc-500 mb-1">Foto saat ini:</p>
                                <img src="${account.image}" class="w-20 h-20 object-cover rounded-lg border border-white/10">
                            </div>` : ''}
                        </div>
                        
                        <div class="ios-input-row">
                            <span class="row-label">Jenis Akun</span>
                            <div class="ios-select-trigger !p-0 !bg-transparent !border-none" onclick="openEditTypePicker()">
                                <span id="labelEditType" class="text-[15px] ${account.type ? 'text-white' : 'text-zinc-500'}">
                                    ${account.type || 'Pilih Jenis...'}
                                </span>
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#8e8e93" stroke-width="2.5">
                                    <path d="M6 9l6 6 6-6"/>
                                </svg>
                            </div>
                            <input type="hidden" id="editType" value="${account.type || ''}">
                        </div>
                        
                        <div id="editDynamicFields">
                            ${generateEditFields(account)}
                        </div>
                        
                        <div class="ios-input-row">
                            <span class="row-label">Status Sold</span>
                            <div class="flex items-center justify-between">
                                <span class="text-[15px]">${account.isSold ? 'Terjual' : 'Tersedia'}</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="editIsSold" ${account.isSold ? 'checked' : ''}>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                </form>
            `;
            
            document.getElementById('modalBody').innerHTML = html;
            document.getElementById('modalBtnAction').innerText = "Simpan Perubahan";
            document.getElementById('modalBtnAction').classList.remove('hidden');
            document.getElementById('modalBtnAction').onclick = () => saveEditChanges(account.id);
            
            document.getElementById('modalOverlay').classList.add('active');
            document.getElementById('iosDetailModal').classList.add('active');
        }

        function generateEditFields(account) {
            let html = '';
            const fields = [
                { id: 'editDbEmail', label: 'Email Akun', value: account.dbEmail || '' },
                { id: 'editDbPassG', label: 'Password Google', value: account.dbPassG || '' },
                { id: 'editDbPassM', label: 'Password Moonton', value: account.dbPassM || '' },
                { id: 'editDbBackup', label: 'Kode Cadangan', value: account.dbBackup || '' },
                { id: 'editDbName', label: 'Nama/ID', value: account.dbName || '' },
                { id: 'editDbLoginVia', label: 'Login Via', value: account.dbLoginVia || '' },
                { id: 'editDbKet', label: 'Keterangan', value: account.dbKet || '' }
            ];
            
            fields.forEach(field => {
                if (field.value || field.id === 'editDbEmail') { // Always show email field
                    html += `
                        <div class="ios-input-row">
                            <span class="row-label">${field.label}</span>
                            <input type="text" id="${field.id}" value="${field.value}" placeholder="${field.label}" class="text-white">
                        </div>
                    `;
                }
            });
            
            return html;
        }

        window.openEditTypePicker = () => {
            const types = ['Mail fresh', 'Mail own', 'Monkos', 'Galver'];
            openIOSPicker('PILIH JENIS AKUN', types, 'editType', false);
            
            // Add event listener to update dynamic fields when type changes
            document.querySelectorAll('#pickerOptionsContainer .picker-option').forEach(btn => {
                btn.addEventListener('click', function() {
                    setTimeout(() => {
                        const newType = document.getElementById('editType').value;
                        const account = accounts.find(a => a.id === activeId);
                        if (account && newType !== account.type) {
                            // Update account object temporarily
                            account.type = newType;
                            // Regenerate fields based on new type
                            const container = document.getElementById('editDynamicFields');
                            container.innerHTML = generateEditFields(account);
                        }
                    }, 100);
                });
            });
        };

        async function saveEditChanges(docId) {
            const type = document.getElementById('editType').value;
            const isSold = document.getElementById('editIsSold')?.checked || false;
            
            if (!type) {
                showIOSNotify("Error", "Jenis akun harus diisi.");
                return;
            }
            
            const btn = document.getElementById('modalBtnAction');
            btn.disabled = true;
            btn.innerText = "Menyimpan...";
            
            try {
                const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'stok', docId);
                const updates = {
                    type: type,
                    isSold: isSold,
                    updatedAt: Date.now()
                };
                
                // Collect all field values
                ['editDbEmail', 'editDbPassG', 'editDbPassM', 'editDbBackup', 'editDbName', 'editDbLoginVia', 'editDbKet'].forEach(fieldId => {
                    const element = document.getElementById(fieldId);
                    if (element) {
                        const value = element.value.trim();
                        const dbField = fieldId.replace('editDb', 'db');
                        if (value) {
                            updates[dbField] = value;
                        } else {
                            // Remove field if empty
                            updates[dbField] = null;
                        }
                    }
                });
                
                // Handle image if there's a new one
                const imageInput = document.getElementById('editImage');
                if (imageInput?.files[0]) {
                    const reader = new FileReader();
                    updates.image = await new Promise((resolve) => {
                        reader.onload = (e) => resolve(e.target.result);
                        reader.readAsDataURL(imageInput.files[0]);
                    });
                }
                
                await updateDoc(docRef, updates);
                
                showIOSNotify("Berhasil", "Data akun berhasil diperbarui.", false);
                closeModals();
                
            } catch (error) {
                console.error("Error updating document:", error);
                showIOSNotify("Gagal", "Terjadi kesalahan saat menyimpan perubahan.");
            } finally {
                btn.disabled = false;
                btn.innerText = "Simpan Perubahan";
            }
        }

        window.handleEditImageSelect = (input) => {
            const label = document.getElementById('label-editImage');
            if (input.files && input.files[0]) {
                label.innerText = input.files[0].name;
                label.style.color = "white";
            } else {
                label.innerText = "Unggah foto...";
                label.style.color = "#8e8e93";
            }
        };

        // --- FILE UI UTILS ---
        window.handleFileSelect = (input, labelId) => {
            const label = document.getElementById(labelId);
            if (input.files && input.files[0]) {
                label.innerText = input.files[0].name;
                label.style.color = "white";
            } else {
                label.innerText = "Pilih Foto...";
                label.style.color = "#8e8e93";
            }
        };

        // --- PICKER UTILS ---
        window.openIOSDatePicker = () => {
            const container = document.getElementById('pickerOptionsContainer');
            document.getElementById('pickerTitle').innerText = "PILIH TANGGAL";
            container.innerHTML = "";
            const dates = [];
            for(let i=0; i<30; i++){
                const d = new Date(); d.setDate(d.getDate() - i);
                dates.push(d.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' }));
            }
            dates.forEach(date => {
                const btn = document.createElement('button'); btn.className = "picker-option"; btn.innerText = date;
                btn.onclick = () => {
                    document.getElementById('testiTanggal').value = date;
                    document.getElementById('labelTestiTanggal').innerText = date;
                    document.getElementById('labelTestiTanggal').style.color = "white";
                    closeModals();
                };
                container.appendChild(btn);
            });
            document.getElementById('modalOverlay').classList.add('active');
            document.getElementById('iosPickerSheet').classList.add('active');
        };

        window.openTestimoniPicker = () => {
            const levels = ["Junior", "Senior", "Ahli", "Ternama", "Terhormat", "Juragan", "Sultan"];
            const container = document.getElementById('pickerOptionsContainer');
            document.getElementById('pickerTitle').innerText = "PILIH TINGKATAN";
            container.innerHTML = "";
            levels.forEach(lvl => {
                const btn = document.createElement('button'); btn.className = "picker-option"; btn.innerText = lvl;
                btn.onclick = () => {
                    if(lvl === "Sultan") {
                        document.getElementById('testiAkun').value = lvl;
                        document.getElementById('labelTestiAkun').innerText = lvl;
                        document.getElementById('labelTestiAkun').style.color = "white";
                        closeModals();
                    } else { openLevelNumberPicker(lvl); }
                };
                container.appendChild(btn);
            });
            document.getElementById('modalOverlay').classList.add('active');
            document.getElementById('iosPickerSheet').classList.add('active');
        };

        function openLevelNumberPicker(lvlBase) {
            const container = document.getElementById('pickerOptionsContainer');
            document.getElementById('pickerTitle').innerText = `PILIH ANGKA ${lvlBase.toUpperCase()}`;
            container.innerHTML = "";
            [1, 2, 3, 4, 5].forEach(num => {
                const btn = document.createElement('button'); btn.className = "picker-option"; btn.innerText = num;
                btn.onclick = () => {
                    const finalValue = `${lvlBase} ${num}`;
                    document.getElementById('testiAkun').value = finalValue;
                    document.getElementById('labelTestiAkun').innerText = finalValue;
                    document.getElementById('labelTestiAkun').style.color = "white";
                    closeModals();
                };
                container.appendChild(btn);
            });
        }

        // --- FORM HANDLERS ---
        document.getElementById('formTesti').onsubmit = async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            const tanggal = document.getElementById('testiTanggal').value;
            const harga = document.getElementById('testiHarga').value;
            const akun = document.getElementById('testiAkun').value;
            if(!tanggal || !harga || !akun) return showIOSNotify("Form Testimoni", "Mohon lengkapi semua data testimoni.");
            
            btn.disabled = true; btn.innerText = "Memproses...";
            
            const text = `✨ <b>TESTIMONI TRANSAKSI AHRASTORE</b>\n\n📅 Tanggal : ${tanggal}\nℹ️ Info : Akun ${akun}\n💸 Harga : ${harga}\n\n📦 Stok lain nya cek di sini\n🌐 https://t.me/StokAhraStore2\n🤟 Testimoni? cek\n🌐 https://t.me/TESTIMONIAHRASTORE`;
            const photo = document.getElementById('testiImage').files[0];
            const formData = new FormData();
            formData.append('chat_id', TELEGRAM_CHAT_ID); 
            formData.append('parse_mode', 'HTML'); 
            formData.append('caption', text);
            if(photo) formData.append('photo', photo);
            
            try {
                const response = await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/${photo?'sendPhoto':'sendMessage'}`, { method: 'POST', body: formData });
                const resData = await response.json();
                
                if(resData.ok) {
                    showIOSNotify("Testimoni Terkirim", "Postingan telah berhasil dikirim ke channel.", false);
                    e.target.reset(); document.getElementById('labelTestiTanggal').innerText = "Pilih Tanggal..."; document.getElementById('labelTestiAkun').innerText = "Pilih Tingkatan..."; document.getElementById('label-testiImage').innerText = "Pilih Foto...";
                } else {
                     throw new Error(resData.description || "Gagal mengirim ke Telegram");
                }
            } catch(e) { 
                console.error(e);
                showIOSNotify("Pengiriman Gagal", e.message || "Gagal mengirim data ke Telegram."); 
            }
            btn.disabled = false; btn.innerText = "POST TESTIMONI";
        };

        document.getElementById('formSave').onsubmit = async (e) => {
            e.preventDefault();
            const type = document.getElementById('saveType').value;
            if(!type) return showIOSNotify("Data Tidak Lengkap", "Pilih jenis akun terlebih dahulu.");
            const btn = e.target.querySelector('button'); btn.disabled = true; btn.innerText = "Menyimpan...";
            const data = { type, timestamp: Date.now(), isSold: false };
            ['dbEmail', 'dbPassG', 'dbPassM', 'dbBackup', 'dbName', 'dbKet', 'dbLoginVia'].forEach(f => {
                const el = document.getElementById(f); if(el) data[f] = el.value;
            });
            const file = document.getElementById('saveImage').files[0];
            if(file) data.image = await new Promise(r => { const fr = new FileReader(); fr.onload = () => r(fr.result); fr.readAsDataURL(file); });
            try {
                await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'stok'), data);
                showIOSNotify("Berhasil Disimpan", "Akun berhasil didaftarkan ke cloud database.", false);
                e.target.reset(); document.getElementById('dynamicFields').innerHTML = ""; document.getElementById('labelSaveType').innerText = "Pilih Jenis Akun..."; document.getElementById('label-saveImage').innerText = "Pilih Foto...";
                switchTab('db');
            } catch(err) { showIOSNotify("Input Gagal", "Gagal menyimpan data ke Firestore."); }
            btn.disabled = false; btn.innerText = "SIMPAN KE CLOUD";
        };

        document.getElementById('formStok').onsubmit = async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button'); btn.disabled = true; btn.innerText = "Mengirim...";
            const harga = document.getElementById('stokHarga').value;
            const info = document.getElementById('stokInfo').value;
            const text = `‼️NEW ACCOUNT FROM AHRASTORE‼️\n\n💸Price : ${harga}\nℹ️Info Akun : ${info}\n\n🛒Order? Chat Admin AHRASTORE\n🌐 https://t.me/zaaamyy\n📦Stok lain nya cek di sini\n🌐 https://t.me/StokAhraStore2`;
            
            const formData = new FormData();
            formData.append('chat_id', TELEGRAM_CHAT_ID); 
            formData.append('parse_mode', 'HTML'); 
            const photo = document.getElementById('stokImage').files[0];
            
            // Fix: Logic for text vs caption
            if (photo) {
                formData.append('caption', text);
                formData.append('photo', photo);
            } else {
                formData.append('text', text); // sendMessage uses 'text', not 'caption'
            }

            try {
                const response = await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/${photo ? 'sendPhoto' : 'sendMessage'}`, { method: 'POST', body: formData });
                const resData = await response.json();
                
                if(resData.ok) {
                    showIOSNotify("Berhasil Dikirim", "Informasi stok akun terkirim ke channel.", false);
                    e.target.reset(); document.getElementById('label-stokImage').innerText = "Pilih Foto...";
                } else {
                    throw new Error(resData.description || "Telegram API Error");
                }
            } catch (e) { 
                console.error(e);
                showIOSNotify("Gagal Kirim", e.message || "Terjadi masalah saat menghubungi Telegram."); 
            }
            btn.disabled = false; btn.innerText = "KIRIM KE CHANNEL";
        };

        // --- GLOBAL UI UTILS ---
        window.switchTab = (tab) => {
            ['stok', 'testi', 'save', 'db'].forEach(t => {
                const el = document.getElementById(`section-${t}`);
                const btn = document.getElementById(`tab-${t}`);
                if(el) el.classList.toggle('hidden', t !== tab);
                if(btn) btn.classList.toggle('tab-active', t === tab);
            });
            window.scrollTo(0,0);
        };

        window.toggleAhraPopover = (id) => {
            const el = document.getElementById(id);
            el.style.display = el.style.display === 'flex' ? 'none' : 'flex';
        };

        window.closeAllPopovers = () => {
            document.querySelectorAll('.ios-popover').forEach(p => p.style.display = 'none');
        };

        window.closeModals = () => {
            document.querySelectorAll('.overlay, .bottom-sheet, .centered-modal').forEach(m => {
                if(m.id !== 'setupUsernameModal') m.classList.remove('active');
            });
            setTimeout(() => { 
                const btn = document.getElementById('modalBtnAction');
                if(btn) btn.classList.add('hidden'); 
            }, 300);
        };
        document.getElementById('modalOverlay').onclick = closeModals;

        window.exportJSON = () => {
            const blob = new Blob([JSON.stringify(accounts, null, 2)], { type: "application/json" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `AhraStore_Cloud_Backup_${Date.now()}.json`;
            link.click();
        };

        window.openIOSPicker = (title, options, targetId, isDynamic = false) => {
            const container = document.getElementById('pickerOptionsContainer');
            document.getElementById('pickerTitle').innerText = title;
            container.innerHTML = "";
            options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = "picker-option"; btn.innerText = opt;
                btn.onclick = () => {
                    document.getElementById(targetId).value = opt;
                    const label = document.getElementById('label' + targetId.charAt(0).toUpperCase() + targetId.slice(1));
                    if(label) { label.innerText = opt; label.style.color = "white"; }
                    if (isDynamic && targetId === 'saveType') handleDynamicFields(opt);
                    if (isDynamic && targetId === 'galverSubtype') handleGalverFields(opt);
                    closeModals();
                };
                container.appendChild(btn);
            });
            document.getElementById('modalOverlay').classList.add('active');
            document.getElementById('iosPickerSheet').classList.add('active');
        };

        function handleDynamicFields(type) {
            const container = document.getElementById('dynamicFields');
            let html = '<div class="ios-input-group">';
            if (type === "Mail fresh" || type === "Mail own") {
                html += `<div class="ios-input-row"><span class="row-label">Email Akun</span><input type="text" id="dbEmail" placeholder="Email" required></div>
                         <div class="ios-input-row"><span class="row-label">Password G</span><input type="text" id="dbPassG" placeholder="Pass Google" required></div>
                         <div class="ios-input-row"><span class="row-label">Password M</span><input type="text" id="dbPassM" placeholder="Pass Moonton" required></div>`;
                if(type === "Mail own") html += `<div class="ios-input-row"><span class="row-label">Kode Cadangan</span><textarea id="dbBackup" placeholder="Backup Code"></textarea></div>`;
            } else if (type === "Monkos") {
                html += `<div class="ios-input-row"><span class="row-label">Email Akun</span><input type="text" id="dbEmail" placeholder="Email" required></div>
                         <div class="ios-input-row"><span class="row-label">Password Google</span><input type="text" id="dbPassG" placeholder="Pass Google" required></div>
                         <div class="ios-input-row"><span class="row-label">Kode Cadangan</span><textarea id="dbBackup" placeholder="Backup Code"></textarea></div>
                         <div class="ios-input-row">
                             <span class="row-label">Login Via</span>
                             <div class="ios-select-trigger !p-0 !bg-transparent !border-none" onclick="openIOSPicker('LOGIN VIA', ['TikTok', 'Facebook', 'Google'], 'dbLoginVia')">
                                 <span id="labelDbLoginVia" class="text-[15px] text-zinc-500">Pilih Login Via...</span>
                                 <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#8e8e93" stroke-width="2.5"><path d="M6 9l6 6 6-6"/></svg>
                             </div>
                             <input type="hidden" id="dbLoginVia" required>
                         </div>`;
            } else if (type === "Galver") {
                html += `<div class="ios-input-row">
                             <span class="row-label">Metode Login</span>
                             <div class="ios-select-trigger !p-0 !bg-transparent !border-none" onclick="openIOSPicker('METODE LOGIN', ['Login Email', 'Login Name'], 'galverSubtype', true)">
                                 <span id="labelGalverSubtype" class="text-[15px] text-zinc-500">Pilih Metode...</span>
                                 <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#8e8e93" stroke-width="2.5"><path d="M6 9l6 6 6-6"/></svg>
                             </div>
                             <input type="hidden" id="galverSubtype" required>
                         </div>
                         <div id="galverFields"></div>`;
            }
            html += '</div>';
            container.innerHTML = html;
        }

        function handleGalverFields(subtype) {
            const container = document.getElementById('galverFields');
            if(!container) return;
            let html = '';
            if (subtype === 'Login Email') {
                 html += `<div class="ios-input-row"><span class="row-label">Email Akun</span><input type="text" id="dbEmail" placeholder="Email" required></div>
                          <div class="ios-input-row"><span class="row-label">Password Google</span><input type="text" id="dbPassG" placeholder="Pass Google" required></div>
                          <div class="ios-input-row"><span class="row-label">Kode Cadangan</span><textarea id="dbBackup" placeholder="Backup Code"></textarea></div>`;
            } else if (subtype === 'Login Name') {
                 html += `<div class="ios-input-row"><span class="row-label">Nama/ID</span><input type="text" id="dbName" placeholder="Nama Akun" required></div>
                          <div class="ios-input-row"><span class="row-label">Password Moonton</span><input type="text" id="dbPassM" placeholder="Pass Moonton" required></div>`;
            }
            container.innerHTML = html;
        }

        async function sendAccountToTelegram(chatId, text, imageBase64) {
            const formData = new FormData();
            formData.append('chat_id', chatId); 
            formData.append('parse_mode', 'HTML');
            
            if (imageBase64) {
                const arr = imageBase64.split(','), mime = arr[0].match(/:(.*?);/)[1], bstr = atob(arr[1]);
                let n = bstr.length; const u8arr = new Uint8Array(n); while(n--){ u8arr[n] = bstr.charCodeAt(n); }
                formData.append('photo', new Blob([u8arr], {type:mime}), 'img.png');
                formData.append('caption', text);
            } else { 
                formData.append('text', text); 
            }
            
            try { 
                const response = await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/${imageBase64?'sendPhoto':'sendMessage'}`, { method: 'POST', body: formData }); 
                const resData = await response.json();
                if(resData.ok) {
                     showIOSNotify("Berhasil", "Data berhasil terkirim ke Telegram.", false); 
                } else {
                     throw new Error(resData.description || "Gagal mengirim ke Telegram");
                }
            } catch(e) { 
                console.error(e);
                showIOSNotify("Error", e.message || "Gagal mengirim pesan."); 
            }
        }

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.ios-popover') && !e.target.closest('#settingsBtn') && !e.target.closest('.db-card')) {
                document.querySelectorAll('.ios-popover').forEach(m => m.style.display = 'none');
            }
        });
    </script>
</body>
</html>
